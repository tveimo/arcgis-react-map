import{g8 as g,M as x,a_ as E,a6 as b,ag as j,eQ as p,fo as I}from"./index-BU6th8yW.js";import{t as R}from"./pbfQueryUtils-D1SNoYIW.js";function O(n){const t={};for(const a in n){if(a==="declaredClass")continue;const i=n[a];if(i!=null&&typeof i!="function")if(Array.isArray(i)){t[a]=[];for(let e=0;e<i.length;e++)t[a][e]=O(i[e])}else typeof i=="object"?i.toJSON&&(t[a]=JSON.stringify(i)):t[a]=i}return t}const S="Layer does not support extent calculation.";function q(n,t){if(t&&n.type==="extent")return`${n.xmin},${n.ymin},${n.xmax},${n.ymax}`;if(t&&n.type==="point")return`${n.x},${n.y}`;const a=n.toJSON();return delete a.spatialReference,JSON.stringify(a)}function F(n,t,a){var l,d;const i=n.geometry,e=n.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const r=e;let u,s,o;if(i&&(s=i.spatialReference,o=p(s),r.geometryType=I(i),r.geometry=q(i,n.compactGeometryEnabled),r.inSR=o),e.groupByFieldsForStatistics&&(r.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds)switch((l=a==null?void 0:a.uniqueIdFields)==null?void 0:l.length){case void 0:r.objectIds=e.objectIds.join(",");break;case 1:r.uniqueIds=JSON.stringify(e.objectIds),delete r.objectIds;break;default:r.uniqueIds=JSON.stringify(e.objectIds.map(f=>JSON.parse(f))),delete r.objectIds}if(e.orderByFields&&(r.orderByFields=e.orderByFields.join(",")),!e.outFields||!e.returnDistinctValues&&(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?delete r.outFields:e.outFields.includes("*")?r.outFields="*":r.outFields=e.outFields.join(","),e.outSR?(r.outSR=p(e.outSR),u=n.outSpatialReference):i&&(e.returnGeometry||e.returnCentroid)&&(r.outSR=r.inSR,u=s),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(r.outStatistics=JSON.stringify(e.outStatistics)),e.fullText&&(r.fullText=JSON.stringify(e.fullText)),e.pixelSize&&(r.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(n.defaultSpatialReferenceEnabled&&s!=null&&((d=n.quantizationParameters)==null?void 0:d.extent)!=null&&s.equals(n.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,r.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(r.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(r.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(r.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const f=e.timeExtent,{start:y,end:m}=f;y==null&&m==null||(r.time=y===m?y:`${y??"null"},${m??"null"}`),delete e.timeExtent}return n.defaultSpatialReferenceEnabled&&s!=null&&u!=null&&s.equals(u)&&(r.defaultSR=r.inSR,delete r.inSR,delete r.outSR),r}async function z(n,t,a,i,e){var u;const r=(u=t.timeExtent)!=null&&u.isEmpty?{data:{features:[]}}:await c(n,t,"json",i,void 0,e);return g(t,a,r.data),r}async function h(n,t,a,i,e){var s;if((s=t.timeExtent)!=null&&s.isEmpty)return{data:a.createFeatureResult()};const r=await J(n,t,i,e),u=r;return u.data=R(r.data,a),u}function J(n,t,a,i){return c(n,t,"pbf",a,void 0,i)}function V(n,t,a,i){var e;return(e=t.timeExtent)!=null&&e.isEmpty?Promise.resolve({data:{objectIds:[]}}):c(n,t,"json",a,{returnIdsOnly:!0},i)}function v(n,t,a,i){var e;return(e=t.timeExtent)!=null&&e.isEmpty?Promise.resolve({data:{count:0}}):c(n,t,"json",a,{returnIdsOnly:!0,returnCountOnly:!0},i)}async function B(n,t,a){var r;if((r=t.timeExtent)!=null&&r.isEmpty)return{data:{count:0,extent:null}};const i=await c(n,t,"json",a,{returnExtentOnly:!0,returnCountOnly:!0}),e=i.data;if(e.hasOwnProperty("extent"))return i;if(e.features)throw new Error(S);if(e.hasOwnProperty("count"))throw new Error(S);return i}function N(n,t){if(!n.returnIdsOnly||!t.uniqueIdFields)return n;const a={...n,returnUniqueIdsOnly:!0};return delete a.returnIdsOnly,a}async function c(n,t,a,i={},e={},r={}){const u=typeof n=="string"?x(n):n,s=t.geometry?[t.geometry]:[],o=await E(s,null,{signal:i.signal}),l=o==null?void 0:o[0];l!=null&&((t=t.clone()).geometry=l);const d=O({...u.query,f:a,...N(e,r),...F(t,e,r)});return b(j(u.path,$(t,e)?"query3d":"query"),{...i,responseType:a==="pbf"?"array-buffer":"json",query:{...d,...i.query}})}function $(n,t){return n.formatOf3DObjects!=null&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}export{B as O,v as S,z as c,h as f,J as m,V as p,O as t};
