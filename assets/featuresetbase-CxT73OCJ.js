import{gD as p,gE as y,gJ as k,de as De,gI as S,gL as xe,W as ue,bW as Ee,gM as Ne,gt as Fe,db as j,gN as Ae,d1 as ve,aF as Se}from"./index-BU6th8yW.js";import{t as Le,D as Ce,l as $}from"./arcade-B9UE3G6Z.js";import{a as N,i as Ze,k as ee,K as L,j as U,p as A,S as ke,l as ce,o as me,X as pe,q as P,T as K,$ as B,b as V,G as Pe,N as _,u as Re,L as Q}from"./aiServices-C0kaBTZL.js";import{R as je,q as ye,p as Ue,c as ne,e as Me,a as Oe,b as ze,N as X,j as We,F as He,E as Ge,L as G,B as Ve,d as J,f as R,k as te}from"./featureSetUtils-C23knIN9.js";import{t as Ke}from"./ImmutableArray-BPVd6ESQ.js";import{l as _e}from"./portalUtils-BWLRjcnL.js";import{u as qe,O as we}from"./SpatialFilter-CRrDMLZw.js";import{x as ge,s as ie}from"./shared-CcgWNeg0.js";import{R as D}from"./WhereClause-ByMSscX8.js";import{queryAssociations as Be}from"./queryAssociations-13sEnjOq.js";import Qe from"./QueryAssociationsParameters-D6G_at3U.js";import"./featureConversionUtils-p8-yzuPr.js";import"./OptimizedFeature-Cy0wyyDO.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./unitConversion-Dy6XfI0W.js";import"./number-AqiZYGHM.js";import"./operatorsWorkerConnection-CWyoT6NY.js";import"./Association-DkKerXvj.js";function Je(i){if(i.length===1){if(S(i[0]))return $("distinct",i[0],-1);if(V(i[0]))return $("distinct",i[0].toArray(),-1)}return $("distinct",i,-1)}function ae(i,w,n){const a=i.getVariables();if(a.length>0){const I={};for(const F of a)I[F]=w.evaluateIdentifier(n,{name:F});i.parameters=I}return i}function u(i,w,n=null){for(const a in i)if(a.toLowerCase()===w.toLowerCase())return i[a];return n}function Ie(i){if(i===null)return null;const w={type:u(i,"type",""),name:u(i,"name","")};if(w.type==="range")w.range=u(i,"range",[]);else{w.codedValues=[];for(const n of u(i,"codedValues",[]))w.codedValues.push({name:u(n,"name",""),code:u(n,"code",null)})}return w}function re(i){if(i===null)return null;const w={},n=u(i,"wkt");n!==null&&(w.wkt=n);const a=u(i,"wkid");return a!==null&&(w.wkid=a),w}function he(i){if(i===null)return null;const w={hasZ:u(i,"hasz",!1),hasM:u(i,"hasm",!1)},n=u(i,"spatialreference");n!=null&&(w.spatialReference=re(n));const a=u(i,"x",null);if(a!==null)return w.x=a,w.y=u(i,"y",null),w.hasZ&&(w.z=u(i,"z",null)),w.hasM&&(w.m=u(i,"m",null)),w;const I=u(i,"rings",null);if(I!==null)return w.rings=I,w;const F=u(i,"paths",null);if(F!==null)return w.paths=F,w;const e=u(i,"points",null);if(e!==null)return w.points=e,w;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const s=u(i,t,null);s!==null&&(w[t]=s)}return w}function Xe(i,w){for(const n of w)if(n===i)return!0;return!1}function Ye(i){return!!i.layerDefinition&&!!i.featureSet&&Xe(i.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&S(i.layerDefinition.fields)!==!1&&S(i.featureSet.features)!==!1}function q(i){return(i==null?void 0:i.toLowerCase())==="utc"?"UTC":(i==null?void 0:i.toLowerCase())==="unknown"?"Unknown":i}async function $e(i,w,n,a,I,F,e){var f,c,x;const t=await i.getFeatureSetInfo();if(((t==null?void 0:t.layerId)??null)===null||!I.layerIdLookup.get(t.layerId))return null;const s=i.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),o=[];switch(n){case"connected":o.push("connectivity"),o.push("junction-edge-from-connectivity"),o.push("junction-edge-to-connectivity"),o.push("junction-edge-midspan-connectivity"),o.push("junction-junction-connectivity");break;case"container":case"content":o.push("containment");break;case"structure":case"attached":o.push("attachment");break;case"junctionedge":o.push("junction-edge-from-connectivity"),o.push("junction-edge-to-connectivity");break;case"midspan":o.push("junction-edge-midspan-connectivity");break;default:throw new p(F,y.InvalidParameter,e)}let m=null,d=!1;if(a!==null&&a!==""&&a!==void 0){for(const g of I.terminals)g.terminalName===a&&(m=g.terminalId);m===null&&(d=!0)}const l=[];if(!d){const g=new ve({globalId:w.field(i.globalIdField),networkSourceId:I.layerIdLookup.get(t.layerId).sourceId,...m?{terminalId:m}:""}),T=await Be(s,new Qe({types:o,elements:[g]}));let E=0;for(const v of T.associations){let M=null,O="",C="";if(((f=v.fromNetworkElement)==null?void 0:f.globalId)===g.globalId?(M=v.toNetworkElement,C="to"):((c=v.toNetworkElement)==null?void 0:c.globalId)===g.globalId&&(M=v.fromNetworkElement,C="from"),!M)continue;switch(n){case"attached":if(v.associationType!=="attachment"||C!=="to")continue;break;case"structure":if(v.associationType!=="attachment"||C!=="from")continue;break;case"container":if(v.associationType!=="containment"||C!=="from")continue;break;case"content":if(v.associationType!=="containment"||C!=="to")continue;break;case"connected":break;case"junctionedge":v.associationType==="junction-edge-to-connectivity"?O="to":v.associationType==="junction-edge-from-connectivity"&&(O="from");break;case"midspan":if(v.associationType!=="junction-edge-midspan-connectivity")continue}const z=((x=I.sourceIdLookup.get(M.networkSourceId))==null?void 0:x.className)??"";l.push(new Se({geometry:null,attributes:{objectId:E++,globalId:M.globalId,percentAlong:v.percentAlong??0,isContentVisible:v.isContentVisible?0:1,className:z,side:O}}))}}const r=new Fe({source:l,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new j({name:"objectId",alias:"objectId",type:"oid"}),new j({name:"globalId",alias:"globalId",type:"global-id"}),new j({name:"percentAlong",alias:"percentAlong",type:"double"}),new j({name:"side",alias:"side",type:"string"}),new j({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new j({name:"className",alias:"className",type:"string"})]});return X(r)}function hn(i){if(i.mode==="async"){i.functions.timezone=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{var o,m;if(N(e,1,2,n,a),Ze(e[0])||ee(e[0]))return"Unknown";if(L(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?q("unknown"):q(e[0].dateFieldsTimeZone);if(!(e[1]instanceof U)||e[1].hasField("type")===!1)throw new p(n,y.InvalidParameter,a);const d=e[1].field("type");if(k(d)===!1)throw new p(n,y.InvalidParameter,a);switch(A(d).toLowerCase()){case"preferredtimezone":return q(e[0].preferredTimeZone);case"editfieldsinfo":return q(((o=e[0].editFieldsInfo)==null?void 0:o.timeZone)??null);case"timeinfo":return q(((m=e[0].timeInfo)==null?void 0:m.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&k(e[1].field("fieldname")))return q(e[0].fieldTimeZone(A(e[1].field("fieldname"))))}throw new p(n,y.InvalidParameter,a)}const t=ke(e[0],ce(n));if(t===null)return null;const s=t.timeZone;return s==="system"?De.systemTimeZoneCanonicalName:s.toLowerCase()==="utc"?"UTC":s.toLowerCase()==="unknown"?"Unknown":s})},i.functions.sqltimestamp=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{N(e,1,3,n,a);const t=e[0];if(me(t)){if(e.length===1)return t.toSQLWithKeyword();if(e.length===2)return t.changeTimeZone(A(e[1])).toSQLWithKeyword();throw new p(n,y.InvalidParameter,a)}if(ee(t))return t.toSQLWithKeyword();if(L(t)){if(e.length!==3)throw new p(n,y.InvalidParameter,a);await t.load();const s=A(e[1]);if(ee(e[2]))return e[2].toSQLWithKeyword();if(me(e[2])===!1)throw new p(n,y.InvalidParameter,a);const o=t.fieldTimeZone(s);return o==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(o).toSQLWithKeyword()}throw new p(n,y.InvalidParameter,a)})},i.signatures.push({name:"sqltimestamp",min:2,max:4}),i.functions.featuresetbyid=function(n,a){return i.standardFunctionAsync(n,a,(I,F,e)=>{if(N(e,2,4,n,a),pe(e[0])){const t=A(e[1]);let s=P(e[2],null);const o=K(P(e[3],!0));if(s===null&&(s=["*"]),S(s)===!1)throw new p(n,y.InvalidParameter,a);return e[0].featureSetById(t,o,s)}throw new p(n,y.InvalidParameter,a)})},i.signatures.push({name:"featuresetbyid",min:2,max:4});const w=new xe(["datasource","parent","root"]);i.functions.getfeatureset=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{if(N(e,1,2,n,a),B(e[0])){const t=e[1]==null?"datasource":w.lookup(A(e[1]));return je(e[0].fullSchema(),t,n.lrucache,n.interceptor,n.spatialReference)}throw new p(n,y.InvalidParameter,a)})},i.signatures.push({name:"getfeatureset",min:1,max:2}),i.functions.featuresetbyportalitem=function(n,a){return i.standardFunctionAsync(n,a,(I,F,e)=>{var d,l;if(N(e,2,5,n,a),e[0]===null)throw new p(n,y.PortalRequired,a);if(e[0]instanceof Le){const r=A(e[1]),f=A(e[2]);let c=P(e[3],null);const x=K(P(e[4],!0));if(c===null&&(c=["*"]),S(c)===!1)throw new p(n,y.InvalidParameter,a);let g;return g=(d=n.services)!=null&&d.portal?n.services.portal:ue.getDefault(),g=_e(e[0],g),ye(r,f,n.spatialReference,c,x,g,n.lrucache,n.interceptor)}if(k(e[0])===!1)throw new p(n,y.PortalRequired,a);const t=A(e[0]),s=A(e[1]);let o=P(e[2],null);const m=K(P(e[3],!0));if(o===null&&(o=["*"]),S(o)===!1)throw new p(n,y.InvalidParameter,a);return ye(t,s,n.spatialReference,o,m,((l=n.services)==null?void 0:l.portal)??ue.getDefault(),n.lrucache,n.interceptor)})},i.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),i.functions.featuresetbyname=function(n,a){return i.standardFunctionAsync(n,a,(I,F,e)=>{if(N(e,2,4,n,a),pe(e[0])){const t=A(e[1]);let s=P(e[2],null);const o=K(P(e[3],!0));if(s===null&&(s=["*"]),S(s)===!1)throw new p(n,y.InvalidParameter,a);return e[0].featureSetByName(t,o,s)}throw new p(n,y.InvalidParameter,a)})},i.signatures.push({name:"featuresetbyname",min:2,max:4}),i.functions.featureset=function(n,a){return i.standardFunction(n,a,(I,F,e)=>{N(e,1,1,n,a);const t={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(k(e[0])){const s=JSON.parse(e[0]);s.layerDefinition!==void 0?(t.layerDefinition=s.layerDefinition,t.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(t.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(t.featureSet.features=s.features,t.featureSet.geometryType=s.geometryType,t.layerDefinition.geometryType=t.featureSet.geometryType,t.layerDefinition.objectIdField=s.objectIdFieldName??"",t.layerDefinition.typeIdField=s.typeIdFieldName,t.layerDefinition.globalIdField=s.globalIdFieldName,t.layerDefinition.fields=s.fields,s.spatialReference&&(t.layerDefinition.spatialReference=s.spatialReference))}else{if(!(e[0]instanceof U))throw new p(n,y.InvalidParameter,a);{const s=JSON.parse(e[0].castToText(!0)),o=u(s,"layerdefinition");if(o!==null){t.layerDefinition.geometryType=u(o,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.globalIdField=u(o,"globalidfield",""),t.layerDefinition.objectIdField=u(o,"objectidfield",""),t.layerDefinition.typeIdField=u(o,"typeidfield",""),t.layerDefinition.hasZ=u(o,"hasz",!1)===!0,t.layerDefinition.hasM=u(o,"hasm",!1)===!0;const m=u(o,"spatialreference");m&&(t.layerDefinition.spatialReference=re(m));const d=[];for(const r of u(o,"fields",[])){const f={name:u(r,"name",""),alias:u(r,"alias",""),type:u(r,"type",""),nullable:u(r,"nullable",!0),editable:u(r,"editable",!0),length:u(r,"length",null),domain:Ie(u(r,"domain"))};d.push(f)}t.layerDefinition.fields=d;const l=u(s,"featureset");if(l){const r={};for(const f of d)r[f.name.toLowerCase()]=f.name;for(const f of u(l,"features",[])){const c={},x=u(f,"attributes",{});for(const g in x)c[r[g.toLowerCase()]]=x[g];t.featureSet.features.push({attributes:c,geometry:he(u(f,"geometry"))})}}}else{t.layerDefinition.hasZ=u(s,"hasz",!1)===!0,t.layerDefinition.hasM=u(s,"hasm",!1)===!0,t.layerDefinition.geometryType=u(s,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.objectIdField=u(s,"objectidfieldname",""),t.layerDefinition.typeIdField=u(s,"typeidfieldname","");const m=u(s,"spatialreference");m&&(t.layerDefinition.spatialReference=re(m));const d=[],l=u(s,"fields",null);if(!S(l))throw new p(n,y.InvalidParameter,a);for(const c of l){const x={name:u(c,"name",""),alias:u(c,"alias",""),type:u(c,"type",""),nullable:u(c,"nullable",!0),editable:u(c,"editable",!0),length:u(c,"length",null),domain:Ie(u(c,"domain"))};d.push(x)}t.layerDefinition.fields=d;const r={};for(const c of d)r[c.name.toLowerCase()]=c.name;let f=u(s,"features",null);if(S(f))for(const c of f){const x={},g=u(c,"attributes",{});for(const T in g)x[r[T.toLowerCase()]]=g[T];t.featureSet.features.push({attributes:x,geometry:he(u(c,"geometry",null))})}else f=null,t.featureSet.features=f}}}if(Ye(t)===!1)throw new p(n,y.InvalidParameter,a);return t.layerDefinition.geometryType||(t.layerDefinition.geometryType="esriGeometryNull"),Ue.create(t,n.spatialReference)})},i.signatures.push({name:"featureset",min:1,max:1}),i.functions.filter=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{if(N(e,2,2,n,a),S(e[0])||V(e[0])){const t=[];let s,o=e[0];if(o instanceof Ke&&(o=o.toArray()),!Pe(e[1]))throw new p(n,y.InvalidParameter,a);s=e[1].createFunction(n);for(const m of o){const d=s(m);Ee(d)?await d===!0&&t.push(m):d===!0&&t.push(m)}return t}if(L(e[0])){const t=await e[0].load(),s=D.create(e[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),o=s.getVariables();if(o.length>0){const m={};for(const d of o)m[d]=i.evaluateIdentifier(n,{name:d});s.parameters=m}return new ne({parentfeatureset:e[0],whereclause:s})}throw new p(n,y.InvalidParameter,a)})},i.signatures.push({name:"filter",min:2,max:2}),i.functions.orderby=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{if(N(e,2,2,n,a),L(e[0])){const t=new Me(e[1]);return new Oe({parentfeatureset:e[0],orderbyclause:t})}throw new p(n,y.InvalidParameter,a)})},i.signatures.push({name:"orderby",min:2,max:2}),i.functions.top=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{if(N(e,2,2,n,a),L(e[0]))return new ze({parentfeatureset:e[0],topnum:e[1]});if(S(e[0]))return _(e[1])>=e[0].length?e[0].slice():e[0].slice(0,_(e[1]));if(V(e[0]))return _(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,_(e[1]));throw new p(n,y.InvalidParameter,a)})},i.signatures.push({name:"top",min:2,max:2}),i.functions.first=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{if(N(e,1,1,n,a),L(e[0])){const t=await e[0].first(I.abortSignal);if(t!==null){const s=Ce.createFromGraphicLikeObject(t.geometry,t.attributes,e[0],n.timeZone);return s._underlyingGraphic=t,s}return t}return S(e[0])?e[0].length===0?null:e[0][0]:V(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:1,max:1}),i.functions.attachments=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{N(e,1,2,n,a);const t={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof U){if(e[1].hasField("minsize")&&(t.minsize=_(e[1].field("minsize"))),e[1].hasField("metadata")&&(t.returnMetadata=K(e[1].field("metadata"))),e[1].hasField("maxsize")&&(t.maxsize=_(e[1].field("maxsize"))),e[1].hasField("types")){const s=Re(e[1].field("types"),!1);s.length>0&&(t.types=s)}}else if(e[1]!==null)throw new p(n,y.InvalidParameter,a)}if(B(e[0])){const s=e[0]._layer;let o;if(L(s))o=s;else{if(s==null||!ge(s))return[];o=X(s,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}return await o.load(),o.queryAttachments(e[0].field(o.objectIdField),t.minsize,t.maxsize,t.types,t.returnMetadata)}if(e[0]===null)return[];throw new p(n,y.InvalidParameter,a)})},i.signatures.push({name:"attachments",min:1,max:2}),i.functions.featuresetbyrelationshipname=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{N(e,2,4,n,a);const t=e[0],s=A(e[1]);let o=P(e[2],null);const m=K(P(e[3],!0));if(o===null&&(o=["*"]),S(o)===!1)throw new p(n,y.InvalidParameter,a);if(e[0]===null)return null;if(!B(e[0]))throw new p(n,y.InvalidParameter,a);const d=t._layer;let l;if(L(d))l=d;else{if(d==null||!ge(d))return null;l=X(d,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}l=await l.load();const r=l.relationshipMetaData().filter(T=>T.name===s);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return We(l,r[0],t.field(l.objectIdField),l.spatialReference,o,m,n.lrucache,n.interceptor);let f=l.serviceUrl();if(!f)return null;f=f.charAt(f.length-1)==="/"?f+r[0].relatedTableId.toString():f+"/"+r[0].relatedTableId.toString();const c=await He(f,l.spatialReference,o,m,n.lrucache,n.interceptor);await c.load();let x=c.relationshipMetaData();if(x=x.filter(T=>T.id===r[0].id),t.hasField(r[0].keyField)===!1||t.field(r[0].keyField)===null){const T=await l.getFeatureByObjectId(t.field(l.objectIdField),[r[0].keyField]);if(T){const E=D.create(x[0].keyField+"= @id",{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC});return E.parameters={id:T.attributes[r[0].keyField]},c.filter(E)}return new qe({parentfeatureset:c})}const g=D.create(x[0].keyField+"= @id",{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC});return g.parameters={id:t.field(r[0].keyField)},c.filter(g)})},i.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),i.functions.featuresetbyassociation=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{N(e,2,3,n,a);const t=e[0],s=Ne(A(P(e[1],""))),o=k(e[2])?A(e[2]):null;if(e[0]===null)return null;if(!B(e[0]))throw new p(n,y.InvalidParameter,a);let m=t._layer;if(m instanceof Fe&&(m=X(m,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),m===null||L(m)===!1)return null;await m.load();const d=m.serviceUrl(),l=await Ge(d,n.spatialReference,!0);if(l.unVersion>=8)return await $e(m,t,s,o,l,n,a);const r=l.associations;let f=null,c=null,x=!1;if(o!==null&&o!==""&&o!==void 0){for(const b of l.terminals)b.terminalName===o&&(c=b.terminalId);c===null&&(x=!0)}const g=r.getFieldsIndex(),T=g.get("TOGLOBALID").name,E=g.get("FROMGLOBALID").name,v=g.get("TOTERMINALID").name,M=g.get("FROMTERMINALID").name,O=g.get("FROMNETWORKSOURCEID").name,C=g.get("TONETWORKSOURCEID").name,z=g.get("ASSOCIATIONTYPE").name,be=g.get("ISCONTENTVISIBLE").name,Te=g.get("OBJECTID").name;for(const b of m.fields)if(b.type==="global-id"){f=t.field(b.name);break}let W=null,se=new G(new j({name:"percentalong",alias:"percentalong",type:"double"}),D.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),oe=new G(new j({name:"side",alias:"side",type:"string"}),D.create("''",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));const Z="globalid",le="globalId",fe={};for(const b in l.lkp)fe[b]=l.lkp[b].sourceId;const H=new Ve(new j({name:"classname",alias:"classname",type:"string"}),null,fe);let h="";switch(s){case"midspan":{h=`((${T}='${f}') OR ( ${E}='${f}')) AND (${z} IN (5))`,H.codefield=D.create(`CASE WHEN (${T}='${f}') THEN ${O} ELSE ${C} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const b=ie(R.findField(r.fields,E));b.name=Z,b.alias=Z,W=new G(b,D.create(`CASE WHEN (${E}='${f}') THEN ${T} ELSE ${E} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),se=l.unVersion>=4?new te(R.findField(r.fields,g.get("PERCENTALONG").name)):new G(new j({name:"percentalong",alias:"percentalong",type:"double"}),D.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{h=`((${T}='${f}') OR ( ${E}='${f}')) AND (${z} IN (4,6))`,H.codefield=D.create(`CASE WHEN (${T}='${f}') THEN ${O} ELSE ${C} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const b=ie(R.findField(r.fields,E));b.name=Z,b.alias=Z,W=new G(b,D.create(`CASE WHEN (${E}='${f}') THEN ${T} ELSE ${E} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),oe=new G(new j({name:"side",alias:"side",type:"string"}),D.create(`CASE WHEN (${z}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let b=`${T}='@T'`,de=`${E}='@T'`;c!==null&&(b+=` AND ${v}=@A`,de+=` AND ${M}=@A`),h="(("+b+") OR ("+de+"))",h=Q(h,"@T",f??""),b=Q(b,"@T",f??""),c!==null&&(b=Q(b,"@A",c.toString()),h=Q(h,"@A",c.toString())),H.codefield=D.create("CASE WHEN "+b+` THEN ${O} ELSE ${C} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const Y=ie(R.findField(r.fields,E));Y.name=Z,Y.alias=Z,W=new G(Y,D.create("CASE WHEN "+b+` THEN ${E} ELSE ${T} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"container":h=`${T}='${f}' AND ${z} = 2`,c!==null&&(h+=` AND ${v} = `+c.toString()),H.codefield=O,h="( "+h+" )",W=new J(R.findField(r.fields,E),Z,Z);break;case"content":h=`(${E}='${f}' AND ${z} = 2)`,c!==null&&(h+=` AND ${M} = `+c.toString()),H.codefield=C,h="( "+h+" )",W=new J(R.findField(r.fields,T),Z,Z);break;case"structure":h=`(${T}='${f}' AND ${z} = 3)`,c!==null&&(h+=` AND ${v} = `+c.toString()),H.codefield=O,h="( "+h+" )",W=new J(R.findField(r.fields,E),Z,le);break;case"attached":h=`(${E}='${f}' AND ${z} = 3)`,c!==null&&(h+=` AND ${M} = `+c.toString()),H.codefield=C,h="( "+h+" )",W=new J(R.findField(r.fields,T),Z,le);break;default:throw new p(n,y.InvalidParameter,a)}return x&&(h="1 <> 1"),new R({parentfeatureset:r,adaptedFields:[new te(R.findField(r.fields,Te)),new te(R.findField(r.fields,be)),W,oe,H,se],extraFilter:h?D.create(h,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}):null})})},i.signatures.push({name:"featuresetbyassociation",min:2,max:6}),i.functions.groupby=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{if(N(e,3,3,n,a),!L(e[0]))throw new p(n,y.InvalidParameter,a);const t=await e[0].load(),s=[],o=[];let m=!1,d=[];if(k(e[1]))d.push(e[1]);else if(e[1]instanceof U)d.push(e[1]);else if(S(e[1]))d=e[1];else{if(!V(e[1]))throw new p(n,y.InvalidParameter,a);d=e[1].toArray()}for(const l of d)if(k(l)){const r=D.create(A(l),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),f=we(r)===!0?A(l):"%%%%FIELDNAME";s.push({name:f,expression:r}),f==="%%%%FIELDNAME"&&(m=!0)}else{if(!(l instanceof U))throw new p(n,y.InvalidParameter,a);{const r=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",f=l.hasField("expression")?l.field("expression"):"";if(r==="%%%%FIELDNAME"&&(m=!0),!r)throw new p(n,y.InvalidParameter,a);s.push({name:r,expression:D.create(f||r,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(d=[],k(e[2]))d.push(e[2]);else if(S(e[2]))d=e[2];else if(V(e[2]))d=e[2].toArray();else{if(!(e[2]instanceof U))throw new p(n,y.InvalidParameter,a);d.push(e[2])}for(const l of d){if(!(l instanceof U))throw new p(n,y.InvalidParameter,a);{const r=l.hasField("name")?l.field("name"):"",f=l.hasField("statistic")?l.field("statistic"):"",c=l.hasField("expression")?l.field("expression"):"";if(!(r&&f&&k(f)&&c))throw new p(n,y.InvalidParameter,a);o.push({name:r,statistic:f,expression:D.create(c,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(m){const l={};for(const f of t.fields)l[f.name.toLowerCase()]=1;for(const f of s)f.name!=="%%%%FIELDNAME"&&(l[f.name.toLowerCase()]=1);for(const f of o)f.name!=="%%%%FIELDNAME"&&(l[f.name.toLowerCase()]=1);let r=0;for(const f of s)if(f.name==="%%%%FIELDNAME"){for(;l["field_"+r.toString()]===1;)r++;l["field_"+r.toString()]=1,f.name="FIELD_"+r.toString()}}for(const l of s)ae(l.expression,i,n);for(const l of o)ae(l.expression,i,n);return e[0].groupby(s,o)})},i.signatures.push({name:"groupby",min:3,max:3}),i.functions.distinct=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{if(L(e[0])){N(e,2,2,n,a);const t=await e[0].load(),s=[];let o=[];if(k(e[1]))o.push(e[1]);else if(e[1]instanceof U)o.push(e[1]);else if(S(e[1]))o=e[1];else{if(!V(e[1]))throw new p(n,y.InvalidParameter,a);o=e[1].toArray()}let m=!1;for(const d of o)if(k(d)){const l=D.create(A(d),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),r=we(l)===!0?A(d):"%%%%FIELDNAME";s.push({name:r,expression:l}),r==="%%%%FIELDNAME"&&(m=!0)}else{if(!(d instanceof U))throw new p(n,y.InvalidParameter,a);{const l=d.hasField("name")?d.field("name"):"%%%%FIELDNAME",r=d.hasField("expression")?d.field("expression"):"";if(l==="%%%%FIELDNAME"&&(m=!0),!l)throw new p(n,y.InvalidParameter,a);s.push({name:l,expression:D.create(r||l,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(m){const d={};for(const r of t.fields)d[r.name.toLowerCase()]=1;for(const r of s)r.name!=="%%%%FIELDNAME"&&(d[r.name.toLowerCase()]=1);let l=0;for(const r of s)if(r.name==="%%%%FIELDNAME"){for(;d["field_"+l.toString()]===1;)l++;d["field_"+l.toString()]=1,r.name="FIELD_"+l.toString()}}for(const d of s)ae(d.expression,i,n);return e[0].groupby(s,[])}return Je(e)})},i.functions.getfeaturesetinfo=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{if(N(e,1,1,n,a),!L(e[0]))return null;const t=await e[0].getFeatureSetInfo();return t?U.convertObjectToArcadeDictionary({layerId:t.layerId,layerName:t.layerName,itemId:t.itemId,serviceLayerUrl:t.serviceLayerUrl,webMapLayerId:t.webMapLayerId??null,webMapLayerTitle:t.webMapLayerTitle??null,className:null,objectClassId:null},ce(n),!1,!1):null})},i.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),i.functions.filterbysubtypecode=function(n,a){return i.standardFunctionAsync(n,a,async(I,F,e)=>{if(N(e,2,2,n,a),L(e[0])){const t=await e[0].load(),s=e[1];if(!Ae(s))throw new p(n,y.InvalidParameter,a);if(t.subtypeField){const m=D.create(`${t.subtypeField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ne({parentfeatureset:e[0],whereclause:m})}if(t.typeIdField===null||t.typeIdField==="")throw new p(n,y.FeatureSetDoesNotHaveSubtypes,a);const o=D.create(`${t.typeIdField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ne({parentfeatureset:e[0],whereclause:o})}throw new p(n,y.InvalidParameter,a)})},i.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{hn as registerFunctions};
