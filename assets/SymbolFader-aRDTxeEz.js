import{n_ as E,n$ as W,hK as T,jn as S,dC as N,bG as F,jA as H,jC as j,jF as Y,jE as K,jx as L,o0 as Z,o1 as G,bP as X}from"./index-BU6th8yW.js";import{t as Q,e as A,c as ee}from"./config-DHajyIwB.js";import{E as w,t as z}from"./constants-B-jzO-JJ.js";import{r as te,l as se,a as ie}from"./StyleDefinition-BiE0eoXW.js";import{o as g,a as C}from"./ProgramTemplate-l9rj7sUi.js";import{r as re}from"./WGLContainer-Cy3GIefH.js";class oe{constructor(e,s){this.sourceTile=s,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}}let ne=class{constructor(e){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[e],this.id=e.id}};function le(y,e,s,t){return q(y,e,s.level,s.col,t.key.level,t.key.col)}function ae(y,e,s,t){return q(y,e,s.level,s.row,t.level,t.row)}function q(y,e,s,t,i,r){const o=s-i;if(o>=0)return(e>>o)+(t-(r<<o))*(y>>o);const n=-o;return e-(r-(t<<n))*(y>>n)<<n}class k{constructor(e,s,t){this._rows=Math.ceil(s/t),this._columns=Math.ceil(e/t),this._cellSize=t,this.cells=new Array(this._rows);for(let i=0;i<this._rows;i++){this.cells[i]=new Array(this._columns);for(let r=0;r<this._columns;r++)this.cells[i][r]=[]}}getCell(e,s){const t=Math.min(Math.max(Math.floor(s/this._cellSize),0),this._rows-1),i=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[t]&&this.cells[t][i]||null}getCellSpan(e,s,t,i){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function he(y,e,s,t,i,r,o){const n=e[t++];for(let l=0;l<n;l++){const a=new oe(r,o);a.xTile=e[t++],a.yTile=e[t++],a.hash=e[t++],a.priority=e[t++],a.featureIndex=e[t++];const h=e[t++],c=a.colliders();for(let m=0;m<h;m++){const _=e[t++],p=e[t++],f=e[t++],b=e[t++],x=!!e[t++],I=e[t++],M=s[t++],B=s[t++],J=e[t++],$=e[t++];c.push({xTile:_,yTile:p,dxPixels:f,dyPixels:b,hard:x,partIndex:I,width:J,height:$,minLod:M,maxLod:B})}const d=y[t++];for(let m=0;m<d;m++)a.textVertexRanges.push([y[t++],y[t++]]);const u=y[t++];for(let m=0;m<u;m++)a.iconVertexRanges.push([y[t++],y[t++]]);i.push(a)}return t}function Fe(y,e,s){for(const[t,i]of y.symbols)ce(y,e,s,i,t)}function ce(y,e,s,t,i){const r=y.layerData.get(i);if(r.type===w.SYMBOL){for(const o of t){const n=o.uniqueSymbol;let l;if(o.selectedForRendering){const a=n.parts[0],h=a.startOpacity,c=a.targetOpacity;y.allSymbolsFadingOut=y.allSymbolsFadingOut&&c===0;const d=Math.floor(127*h)|c<<7;l=d<<24|d<<16|d<<8|d}else l=0;for(const[a,h]of o.iconVertexRanges)for(let c=a;c<a+h;c+=4)r.iconOpacity[c/4]=l;if(o.selectedForRendering){const a=n.parts[1],h=a.startOpacity,c=a.targetOpacity;y.allSymbolsFadingOut=y.allSymbolsFadingOut&&c===0;const d=Math.floor(127*h)|c<<7;l=d<<24|d<<16|d<<8|d}else l=0;for(const[a,h]of o.textVertexRanges)for(let c=a;c<a+h;c+=4)r.textOpacity[c/4]=l}r.lastOpacityUpdate=e,r.opacityChanged=!0}}function ye(y,e,s,t){var a;const i=y.colliders();let r,o,n,l;for(const h of i)if((a=y.uniqueSymbol)!=null&&a.show&&y.uniqueSymbol.parts[h.partIndex].show&&(r=h.xScreen-t[0]+h.dxScreen,o=h.yScreen-t[1]+h.dyScreen,n=r+h.width,l=o+h.height,E(s,e.x,e.y,r,o,n,l)))return!0;return!1}let ue=class{constructor(e,s,t,i,r,o){this._symbols=e,this._styleRepository=i,this._zoom=r,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new k(s,t,Q),this._si=Math.sin(Math.PI*o/180),this._co=Math.cos(Math.PI*o/180),i.cachedStyles&&(this._styleProps=i.cachedStyles);for(const n of e)for(const l of n.symbols)this._allNeededMatrices.has(l.tile)||this._allNeededMatrices.set(l.tile,W(l.tile.transforms.tileUnitsToPixels))}work(e){var t,i;const s=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const r=this._symbols[this._currentLayerCursor],o=this._getProperties(r.styleLayerUID),n=(t=this._styleRepository.layerContexts)==null?void 0:t.get(r.styleLayerUID);for(;this._currentSymbolCursor<r.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-s>e)return!1;const l=r.symbols[this._currentSymbolCursor];if(!((i=l.uniqueSymbol)!=null&&i.show))continue;const a=this._computeCoordinates(l,o,n),h=l.uniqueSymbol;if(!h.show)continue;const{iconAllowOverlap:c,textAllowOverlap:d}=o;for(const u of a){if(!u.enabled)continue;const m=h.parts[u.partIndex];m.show&&!(u.partIndex?d:c)&&this._doesCollide(u)&&(u.hard?h.show=!1:m.show=!1)}h.show&&this._insertColliders(h.parts,a,o)}}return!0}_insertColliders(e,s,t){const{iconIgnorePlacement:i,textIgnorePlacement:r}=t;for(const o of s){if(!o.enabled||(o.partIndex?r:i)||!e[o.partIndex].show)continue;const n=o.xScreen+o.dxScreen,l=o.yScreen+o.dyScreen,a=n+o.width,h=l+o.height,[c,d,u,m]=this._gridIndex.getCellSpan(n,l,a,h);for(let _=d;_<=m;_++)for(let p=c;p<=u;p++)this._gridIndex.cells[_][p].push(o)}}_computeCoordinates(e,s,t){const{iconRotationAlignment:i,textRotationAlignment:r,iconTranslate:o,iconTranslateAnchor:n,textTranslate:l,textTranslateAnchor:a}=s,h=this._si,c=this._co,d=this._zoom,u=this._allNeededMatrices.get(e.tile),m=e.uniqueSymbol,_=e.colliders(t);let p=0;for(const f of _){const[b,x]=f.partIndex===0?o:l,I=f.partIndex===0?n:a,M=f.minLod<=d&&d<=f.maxLod;p+=M?0:1,f.enabled=M,f.xScreen=f.xTile*u[0]+f.yTile*u[3]+u[6],f.yScreen=f.xTile*u[1]+f.yTile*u[4]+u[7],I===te.MAP?(f.xScreen+=c*b-h*x,f.yScreen+=h*b+c*x):(f.xScreen+=b,f.yScreen+=x),se.VIEWPORT===(f.partIndex===0?i:r)?(f.dxScreen=f.dxPixels,f.dyScreen=f.dyPixels):(f.dxScreen=c*(f.dxPixels+f.width/2)-h*(f.dyPixels+f.height/2)-f.width/2,f.dyScreen=h*(f.dxPixels+f.width/2)+c*(f.dyPixels+f.height/2)-f.height/2)}return _.length>0&&p===_.length&&m&&(m.show=!1),_}_getProperties(e){var i,r;const s=this._styleProps.get(e);if(s)return s;const t=(r=(i=this._styleRepository).getLayerStyleProperties)==null?void 0:r.call(i,e,this._zoom);return this._styleProps.set(e,t),t}_doesCollide(e){const s=e.xScreen+e.dxScreen,t=e.yScreen+e.dyScreen,i=s+e.width,r=t+e.height,[o,n,l,a]=this._gridIndex.getCellSpan(s,t,i,r);for(let h=n;h<=a;h++)for(let c=o;c<=l;c++){const d=this._gridIndex.cells[h][c];for(const u of d){const m=u.xScreen+u.dxScreen,_=u.yScreen+u.dyScreen,p=m+u.width,f=_+u.height;if(!(i<m||s>p||r<_||t>f))return!0}}return!1}},R=class{constructor(e,s){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let t=1;const i=new Uint32Array(e);this.layerUIDs=[];const r=i[t++];for(let o=0;o<r;o++)this.layerUIDs[o]=i[t++];this.bufferDataOffset=t,s&&(this.layer=s.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return this._data==null}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){this._data!=null&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}},fe=class extends R{constructor(e,s){super(e,s),this.type=w.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const t=new Uint32Array(e);let i=this.bufferDataOffset;this.lineIndexStart=t[i++],this.lineIndexCount=t[i++];const r=t[i++];if(r>0){this.patternMap=new Map;for(let o=0;o<r;o++){const n=t[i++],l=t[i++],a=t[i++];this.patternMap.set(n,[l,a])}}this.bufferDataOffset=i}get usedMemory(){var e,s;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((s=this.vao)==null?void 0:s.cachedMemory)??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=T(this.vao)}doPrepareForRendering(e,s,t){const i=new Uint32Array(s),r=new Int32Array(i.buffer),o=i[t++],n=g.createVertex(e,S.STATIC_DRAW,new Int32Array(r.buffer,4*t,o));t+=o;const l=i[t++],a=g.createIndex(e,S.STATIC_DRAW,new Uint32Array(i.buffer,4*t,l));t+=l;const h=this.layer.lineMaterial;this.vao=new C(e,h.getAttributeLocations(),h.getLayoutInfo(),new Map([["geometry",n]]),a)}};class de extends R{constructor(e,s){super(e,s),this.type=w.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const t=new Uint32Array(e);let i=this.bufferDataOffset;this.fillIndexStart=t[i++],this.fillIndexCount=t[i++],this.outlineIndexStart=t[i++],this.outlineIndexCount=t[i++];const r=t[i++];if(r>0){this.patternMap=new Map;for(let o=0;o<r;o++){const n=t[i++],l=t[i++],a=t[i++];this.patternMap.set(n,[l,a])}}this.bufferDataOffset=i}get usedMemory(){var e,s,t;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((s=this.fillVAO)==null?void 0:s.cachedMemory)??0)+(((t=this.outlineVAO)==null?void 0:t.cachedMemory)??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=T(this.fillVAO),this.outlineVAO=T(this.outlineVAO)}doPrepareForRendering(e,s,t){const i=new Uint32Array(s),r=new Int32Array(i.buffer),o=i[t++],n=g.createVertex(e,S.STATIC_DRAW,new Int32Array(r.buffer,4*t,o));t+=o;const l=i[t++],a=g.createIndex(e,S.STATIC_DRAW,new Uint32Array(i.buffer,4*t,l));t+=l;const h=i[t++],c=g.createVertex(e,S.STATIC_DRAW,new Int32Array(r.buffer,4*t,h));t+=h;const d=i[t++],u=g.createIndex(e,S.STATIC_DRAW,new Uint32Array(i.buffer,4*t,d));t+=d;const m=this.layer,_=m.fillMaterial,p=m.outlineMaterial;this.fillVAO=new C(e,_.getAttributeLocations(),_.getLayoutInfo(),new Map([["geometry",n]]),a),this.outlineVAO=new C(e,p.getAttributeLocations(),p.getLayoutInfo(),new Map([["geometry",c]]),u)}}let me=class extends R{constructor(e,s,t){super(e,s),this.type=w.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const i=new Uint32Array(e),r=new Int32Array(e),o=new Float32Array(e);let n=this.bufferDataOffset;this.isIconSDF=!!i[n++];const l=i[n++],a=i[n++],h=i[n++],c=new N(l,a,h,0),d=i[n++];for(let p=0;p<d;p++){const f=i[n++],b=i[n++],x=i[n++];this.iconPerPageElementsMap.set(f,[b,x])}const u=i[n++];for(let p=0;p<u;p++){const f=i[n++],b=i[n++],x=i[n++];this.glyphPerPageElementsMap.set(f,[b,x])}const m=i[n++],_=i[n++];this.iconOpacity=new Int32Array(m),this.textOpacity=new Int32Array(_),n=he(i,r,o,n,this.symbols,t,c),this.bufferDataOffset=n}get usedMemory(){var e,s,t;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((s=this.iconVAO)==null?void 0:s.cachedMemory)??0)+(((t=this.textVAO)==null?void 0:t.cachedMemory)??0)+F(this.iconOpacity)+F(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const s of this.iconPerPageElementsMap.values())e+=s[1];for(const s of this.glyphPerPageElementsMap.values())e+=s[1];return e/3}doDestroy(){this.iconVAO=T(this.iconVAO),this.textVAO=T(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,s=this.iconVAO.vertexBuffers.get("opacity");e.length>0&&e.byteLength===s.usedMemory&&s.setSubData(e,0,0,e.length);const t=this.textOpacity,i=this.textVAO.vertexBuffers.get("opacity");t.length>0&&t.byteLength===i.usedMemory&&i.setSubData(t,0,0,t.length)}doPrepareForRendering(e,s,t){const i=new Uint32Array(s),r=new Int32Array(i.buffer),o=i[t++],n=g.createVertex(e,S.STATIC_DRAW,new Int32Array(r.buffer,4*t,o));t+=o;const l=i[t++],a=g.createIndex(e,S.STATIC_DRAW,new Uint32Array(i.buffer,4*t,l));t+=l;const h=i[t++],c=g.createVertex(e,S.STATIC_DRAW,new Int32Array(r.buffer,4*t,h));t+=h;const d=i[t++],u=g.createIndex(e,S.STATIC_DRAW,new Uint32Array(i.buffer,4*t,d));t+=d;const m=g.createVertex(e,S.STATIC_DRAW,this.iconOpacity.buffer),_=g.createVertex(e,S.STATIC_DRAW,this.textOpacity.buffer),p=this.layer,f=p.iconMaterial,b=p.textMaterial;this.iconVAO=new C(e,f.getAttributeLocations(),f.getLayoutInfo(),new Map([["geometry",n],["opacity",m]]),a),this.textVAO=new C(e,b.getAttributeLocations(),b.getLayoutInfo(),new Map([["geometry",c],["opacity",_]]),u)}},_e=class extends R{constructor(e,s){super(e,s),this.type=w.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const t=new Uint32Array(e);let i=this.bufferDataOffset;this.circleIndexStart=t[i++],this.circleIndexCount=t[i++],this.bufferDataOffset=i}get usedMemory(){var e,s;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((s=this.vao)==null?void 0:s.cachedMemory)??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=T(this.vao)}doPrepareForRendering(e,s,t){const i=new Uint32Array(s),r=new Int32Array(i.buffer),o=i[t++],n=g.createVertex(e,S.STATIC_DRAW,new Int32Array(r.buffer,4*t,o));t+=o;const l=i[t++],a=g.createIndex(e,S.STATIC_DRAW,new Uint32Array(i.buffer,4*t,l));t+=l;const h=this.layer.circleMaterial;this.vao=new C(e,h.getAttributeLocations(),h.getLayoutInfo(),new Map([["geometry",n]]),a)}};class V extends re{constructor(e,s,t,i,r,o,n,l=null){super(e,s,t,i,r,o,z,z),this.styleRepository=n,this._owner=l,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<A}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<A)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){var t,i;let s=!1;for(const r of e){const o=this.layerData.get(r);o&&(this._usedMemory-=o.usedMemory,o.type===w.SYMBOL&&this.symbols.delete(r)&&(s=!0),o.destroy(),this.layerData.delete(r))}(t=this._owner)==null||t.updateTileSize(this),s&&((i=this.featureIndex)==null||i.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const e=this.layerData.values();for(const s of e)if(s.hasData())return!0;return!1}dispose(){this.status!=="unloaded"&&(V._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){var e;--this._referenced===0&&((e=this._owner)==null||e.onDisposeTile(this),this.dispose(),this.stage=null)}retain(){++this._referenced}get cachedMemory(){return this._usedMemory}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){var t,i;(t=this.featureIndex)==null||t.clear();let s=!1;if(e){const{bucketsWithData:r,emptyBuckets:o}=e,n=this._createRenderBuckets(r);if(o&&o.byteLength>0){const l=new Uint32Array(o);for(const a of l)this._deleteLayerData(a)}for(const[l,a]of n)this._deleteLayerData(l),a.type===w.SYMBOL&&(this.symbols.set(l,a.symbols),s=!0),this._usedMemory+=a.usedMemory,this.layerData.set(l,a);(i=this._owner)==null||i.updateTileSize(this)}this._hasSymbolBuckets=!1;for(const r of this.layerData.values())r.type===w.SYMBOL&&(this._hasSymbolBuckets=!0);s&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(s){s.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const s=this.resolution/(e.resolution*e.pixelRatio),t=this.width/this.rangeX*s,i=this.height/this.rangeY*s,r=[0,0];e.toScreen(r,[this.x,this.y]);const o=this.transforms.tileUnitsToPixels;H(o),j(o,o,r),Y(o,o,Math.PI*e.rotation/180),K(o,o,[t,i,1])}_createTransforms(){return{displayViewScreenMat3:L(),tileMat3:L(),tileUnitsToPixels:L()}}static _destroyRenderBuckets(e){if(!e)return;const s=new Set;for(const t of e.values())s.has(t)||(t.destroy(),s.add(t));e.clear()}_createRenderBuckets(e){const s=new Map,t=new Map;for(const i of e){const r=this._deserializeBucket(i,t);for(const o of r.layerUIDs)s.set(o,r)}return s}_deserializeBucket(e,s){let t=s.get(e);if(t)return t;switch(new Uint32Array(e)[0]){case w.FILL:t=new de(e,this.styleRepository);break;case w.LINE:t=new fe(e,this.styleRepository);break;case w.SYMBOL:t=new me(e,this.styleRepository,this);break;case w.CIRCLE:t=new _e(e,this.styleRepository)}return s.set(e,t),t}_deleteLayerData(e){if(!this.layerData.has(e))return;const s=this.layerData.get(e);this._usedMemory-=s.usedMemory,s.destroy(),this.layerData.delete(e)}}function D(y){var e,s;return(((e=y.uniqueSymbol)==null?void 0:e.show)&&((s=y.uniqueSymbol)==null?void 0:s.lastShow))??!1}function pe(y,e){if(y.priority-e.priority)return y.priority-e.priority;if(D(y)&&!D(e))return-1;if(D(e)&&!D(y))return 1;const s=y.tile.key,t=e.tile.key;return s.world-t.world?s.world-t.world:s.level-t.level?s.level-t.level:s.row-t.row?s.row-t.row:s.col-t.col?s.col-t.col:y.xTile-e.xTile?y.xTile-e.xTile:y.yTile-e.yTile}let be=class{get running(){return this._running}constructor(e,s,t,i,r,o,n,l){this.selectionMode=e,this._visibleTiles=s,this._symbolRepository=t,this._styleRepository=i,this._createCollisionJob=r,this._assignTileSymbolsOpacity=o,this._symbolLayerSorter=n,this._isLayerVisible=l,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,s){this._screenWidth===e&&this._screenHeight===s||this.restart(),this._screenWidth=e,this._screenHeight=s}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const s=performance.now();if(!this._selectionJob.work(e)||(this._selectionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-s)))===0))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const s=performance.now();if(!this._collisionJob.work(e)||(this._collisionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-s)))===0))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const s=performance.now();if(!this._opacityJob.work(e)||(this._opacityJobCompleted=!0,(e=Math.max(0,e-(performance.now()-s)))===0))return!1}return this._running=!1,!0}_isFeatureFiltered(e,s,t){const i=s.getFilterFlags(e),r=i&G,o=t.featureEffect==null||t.featureEffect.excludedLabelsVisible||i&Z;return!(r&&o)}_getFilteredByLayer(){var s,t;let e;if((s=this._styleRepository)!=null&&s.layerContexts)for(const i of this._symbolRepository.uniqueSymbols){const r=(t=this._styleRepository.layerContexts)==null?void 0:t.get(i.styleLayerUID);if(r!=null&&r.attributeView)for(const o of i.uniqueSymbols){e??(e=new Map),e.get(i.styleLayerUID)||e.set(i.styleLayerUID,new Set);const n=e.get(i.styleLayerUID),l=r.attributeView,a=r.layerView;this._isFeatureFiltered(o.id,l,a)&&n.add(o.id)}}return e}_resetSelection(){for(let e=0;e<this._symbolRepository.uniqueSymbols.length;e++){const s=this._symbolRepository.uniqueSymbols[e];for(let t=0;t<s.uniqueSymbols.length;t++){const i=s.uniqueSymbols[t];for(const r of i.tileSymbols)r.selectedForRendering=!1}}}_createSelectionJob(){var c;const e=this.selectionMode==="feature-tile"?ge:we,s=this._symbolRepository.uniqueSymbols;this._resetSelection();const t=[];let i=0,r=0;const o=this._isLayerVisible,n=this._getFilteredByLayer(),l=(c=this._styleRepository)==null?void 0:c.layerContexts;function a(d){let u;const m=performance.now();for(;r<s.length;r++,i=0){const _=s[r],p=_.styleLayerUID,f=n==null?void 0:n.get(p);let b=0;if(l){const I=l.get(p).layerView;b=I.view.allLayerViews.items.indexOf(I)}if(!o(p)){t[r]||(t[r]={styleLayerUID:p,layerOrder:b,symbols:[]});continue}t[r]||(t[r]={styleLayerUID:p,symbols:[],layerOrder:b});const x=t[r];for(;i<_.uniqueSymbols.length;i++){if(u=_.uniqueSymbols[i],i%100==99&&performance.now()-m>d)return!1;if(u.lastShow=u.show,u.id&&(f==null?void 0:f.has(u.id))){u.show=!1,u.parts[0].show=!1,u.parts[1].show=!1;continue}const I=e(u);if(I){I.selectedForRendering=!0,x.symbols.push(I),u.show=!0;for(const M of u.parts)M.show=!0}else u.show=!1}}for(const _ of t)_.symbols.sort(pe);return t.sort((_,p)=>p.layerOrder-_.layerOrder),!0}const h=this._symbolLayerSorter;return{work:a,get sortedSymbols(){return t.sort(h)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,s=this._visibleTiles;let t=0;function i(r,o){for(const n of r.symbols.values())Se(n,o);e(r,o);for(const n of r.childrenTiles)i(n,o)}return{work(r){const o=performance.now();for(;t<s.length;t++){if(performance.now()-o>r)return!1;const n=s[t];if(n.parentTile!=null)continue;const l=performance.now();n instanceof V?i(n,l):e(n,l)}return!0}}}};function Se(y,e){for(const s of y){const t=s.uniqueSymbol;for(const i of t.parts){const r=i.targetOpacity>.5?1:-1;i.startOpacity+=r*((e-i.startTime)/A),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=e,i.targetOpacity=t.show&&i.show?1:0}}}function ge(y){let e=null,s=null,t=null;for(const i of y.tileSymbols){const r=i.tile;r.isReady&&r.isCoverage?e=i:r.isReady?s=i:r.rendering&&(t=i)}return e??s??t}function we(y){let e=null,s=!1,t=!1;for(const i of y.tileSymbols)if(!t||!s){const r=i.tile;(!e||r.isCoverage||r.neededForCoverage&&!s)&&(e=i,(r.neededForCoverage||r.isCoverage)&&(t=!0),r.isCoverage&&(s=!0))}return t?e:null}class v{static fromSymbols(e,s){let t=e.length;if(t>=xe){let i=s;do i/=2,t/=4;while(t>Ie&&i>Me);const r=new k(s,s,i);for(const o of e)r.getCell(o.xTile,o.yTile).push(o);return new v(s,e,r)}return new v(s,e,null)}constructor(e,s,t){this.tileCoordRange=e,this._symbols=s,this._index=t}addSymbols(e){for(const s of e)this._symbols.push(s);if(this._index)for(const s of e)this._index.getCell(s.xTile,s.yTile).push(s)}removeSymbols(e){const s=new Set(e);if(this._symbols=this._symbols.filter(t=>!s.has(t)),this._index)for(const t of this._index.cells)for(let i=0;i<t.length;i++)t[i]=t[i].filter(r=>!s.has(r))}getSymbols(){return this._symbols}getCandidate(e,s,t,i){if(!this._index){for(const h of this._symbols)if(t===h.hash&&Math.abs(e-h.xTile)<=i&&Math.abs(s-h.yTile)<=i)return h;return null}const r=this._index.getCellSpan(e-i,s-i,e+i,s+i),[o,n,l,a]=r;for(let h=n;h<=a;h++)for(let c=o;c<=l;c++){const d=this._index.cells[h][c];for(const u of d)if(t===u.hash&&Math.abs(e-u.xTile)<=i&&Math.abs(s-u.yTile)<=i)return u}return null}}const xe=32,Ie=8,Me=64,O=20;class Te{constructor(e,s){this.tileCoordRange=e,this._visibleTiles=s,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray==null&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}registerVectorTile(e,s){const t=this._ensureIndexMap(e),i=(s==null?void 0:s.values())??t.keys();for(const r of i){const o=t.get(r);o&&(this._removeSymbols(r,o.getSymbols()),t.delete(r))}this._addSymbols(e.key,t,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,s){const t=this._indexMapByTile.get(e);if(!t)throw new Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,t,U(s)),this._invalidate()}removeFeatureTileMetrics(e,s){const t=this._indexMapByTile.get(e);if(!t)return;const i=U(s);for(const[r,o]of t.entries()){const n=i.get(r);n&&(o.removeSymbols(n),this._removeSymbols(r,n))}this._invalidate()}deleteStyleLayers(e){for(const s of this._indexMapByTile.values())for(const t of e){const i=s.get(t);i&&(this._removeSymbols(t,i.getSymbols()),s.delete(t))}this._invalidate()}querySymbols(e,s,t,i){const r=[];for(const[o,n]of this._uniqueSymbolsByStyleLayerId.entries())for(const l of n){const a=l.tileSymbols.find(h=>h.selectedForRendering);a&&ye(a,e,s*(window.devicePixelRatio||1),t)&&r.push({vtlSymbol:a,styleLayerUID:o,tileKey:a.tile.key})}return r}_ensureIndexMap(e){let s=this._indexMapByTile.get(e);return s||(s=new Map,this._indexMapByTile.set(e,s)),s}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,s,t){for(const[i,r]of t){let o=s.get(i);o?o.addSymbols(r):(o=v.fromSymbols(r,this.tileCoordRange),s.set(i,o))}this._updateUniqueSymbols(e,t)}_removeTile(e){const s=this._indexMapByTile.get(e);if(s){for(const[t,i]of s.entries())this._removeSymbols(t,i.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,s){for(const t of s){const i=t.uniqueSymbol;if(i){if(i.tileSymbols=i.tileSymbols.filter(r=>r!==t),i.tileSymbols.length===0){const r=this._uniqueSymbolsByStyleLayerId.get(e);r.delete(i),r.size===0&&this._uniqueSymbolsByStyleLayerId.delete(e)}t.uniqueSymbol=null}}}_updateUniqueSymbols(e,s){if(s.size!==0){for(const t of this._visibleTiles)t.parentTile||t.key.world!==e.world||t.key.level===e.level&&!t.key.equals(e)||this._matchSymbols(t,e,s);for(const[t,i]of s)for(const r of i)if(!r.uniqueSymbol){r.uniqueSymbol=new ne(r);let o=this._uniqueSymbolsByStyleLayerId.get(t);o||(o=new Set,this._uniqueSymbolsByStyleLayerId.set(t,o)),o.add(r.uniqueSymbol)}}}_matchSymbols(e,s,t){if(e.key.level>s.level){const r=e.key.level-s.level;if(e.key.row>>r!==s.row||e.key.col>>r!==s.col)return}if(s.level>e.key.level){const r=s.level-e.key.level;if(s.row>>r!==e.key.row||s.col>>r!==e.key.col)return}const i=new Map;for(const[r,o]of t){const n=[],l=(e.key.level<s.level?1:1<<e.key.level-s.level)+O,a=this._indexMapByTile.get(e),h=a==null?void 0:a.get(r);if(h)for(const c of o){if(c.uniqueSymbol)continue;const d=le(this.tileCoordRange,c.xTile,s,e.key),u=ae(this.tileCoordRange,c.yTile,s,e.key),m=-O,_=this.tileCoordRange+O;if(!(d>=m&&d<_&&u>=m&&u<_)){n.push(c);continue}const p=h.getCandidate(d,u,c.hash,l),f=p==null?void 0:p.uniqueSymbol;f?(c.uniqueSymbol=f,f.tileSymbols.push(c)):n.push(c)}n.length>0&&i.set(r,n)}for(const r of e.childrenTiles||[])this._matchSymbols(r,s,i)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsByStyleLayerId,s=new Array(e.size);let t,i=0;for(const[r,o]of e){const n=new Array(o.size);t=0;for(const l of o)n[t++]=l;s[i]={styleLayerUID:r,uniqueSymbols:n},i++}return s}}function U(y){const e=new Map;for(const s of y){const t=s.labelClassId;let i=e.get(t);i||(i=[],e.set(t,i)),i.push(s)}return e}const Ce=.5,P=1e-6;class Je{constructor(e,s,t,i,r,o=ee){this.styleRepository=s,this._declutterBudget=o,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=X(!1);const n=(h,c,d)=>this._createCollisionJob(h,c,d),l=h=>{var d,u,m;const c=(u=(d=this.styleRepository).getStyleLayerByUID)==null?void 0:u.call(d,h);if(c){if(this._zoom+P<c.minzoom||this._zoom-P>=c.maxzoom)return!1;const _=(m=c.getLayoutProperty)==null?void 0:m.call(c,"visibility");if(_&&_.getValue()===ie.NONE)return!1}return!0},a=(h,c)=>{var d,u,m,_,p,f;return(((m=(u=(d=this.styleRepository).getStyleLayerByUID)==null?void 0:u.call(d,h.styleLayerUID))==null?void 0:m.z)??0)-(((f=(p=(_=this.styleRepository).getStyleLayerByUID)==null?void 0:p.call(_,c.styleLayerUID))==null?void 0:f.z)??0)};this._symbolRepository=new Te(r,i),this._symbolDeclutterer=new be(e,i,this._symbolRepository,this.styleRepository,n,t,a,l)}get symbolRepository(){return this._symbolRepository}_createCollisionJob(e,s,t){return this.updateDecluttererViewState(),new ue(e,s,t,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}registerFeatureTile(e){this.symbolRepository?(this.symbolRepository.registerFeatureTile(e),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}unregisterFeatureTile(e){this.symbolRepository?(this._symbolRepository.unregisterFeatureTile(e),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}insertFeatureTileMetrics(e,s){this.symbolRepository?(this.symbolRepository.insertFeatureTileMetrics(e,s),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}removeFeatureTileMetrics(e,s){this.symbolRepository?(this.symbolRepository.removeFeatureTileMetrics(e,s),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",()=>{this._symbolRepository.registerVectorTile(e),this.restartDeclutter()})),this._symbolRepository.registerVectorTile(e),this.restartDeclutter()}removeTile(e){const s=this._tileToHandle.get(e);s&&(this._symbolRepository.unregisterVectorTile(e),this.restartDeclutter(),s.remove(),this._tileToHandle.delete(e))}update(e,s){this._zoom=e,this._viewState={scale:s.scale,rotation:s.rotation,center:[s.center[0],s.center[1]],size:[s.size[0],s.size[1]]};const t=[0,0];s.toScreen(t,s.center);const i=[0,0];return s.toScreen(i,this._declutterViewState.center),this._offsetFromScreenCenter[0]=t[0]-i[0],this._offsetFromScreenCenter[1]=t[1]-i[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(this._declutterBudget),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){this._stableNotificationHandle!=null&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},(1+Ce)*A)}_notifyUnstable(){this._stableNotificationHandle!=null&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0}}export{Fe as a,Je as c,V as m};
