import{f5 as dr,a4 as Nn,eh as fr,ar as f,as as p,at as pr,_ as Fn,hw as Dn,ky as ze,dY as oe,dX as Ht,dV as Ee,jg as Un,am as mr,s as yt,i9 as Si,f0 as Bn,dW as ye,pb as Rr,mh as zn,dS as we,mi as Ct,ia as Lt,aw as br,vr as Hn,bS as Vn,bU as kn,hK as Qi,bR as Gn,vs as jn,nh as Wn,e7 as qn,aR as fe,aS as ms,fJ as Ti,aP as v,fI as Xn,fY as k,fG as ve,fH as X,vt as Yn,jp as vs,fW as Ce,i8 as Kn,jd as tt,bW as Qn,h as gs,o9 as le,du as Ri,k0 as Ze,jj as Li,vu as Ni,vv as Zn,cv as qt,gm as Pe,vw as Jn,d_ as ea,vx as ta,bo as K,bc as Se,be as je,fU as te,ic as He,aU as ui,fV as Zi,vy as ia,h_ as xt,i0 as Ei,ku as _s,vz as Ts,vA as Es,fE as Ge,jy as ra,pG as sa,j$ as _e,kk as kt,o7 as yi,b7 as xi,kq as at,el as na,uW as Xt,vB as Gt,vC as aa,i6 as oa,hR as la,rx as ca,hZ as ua,gJ as vr,bl as mt,vD as ha,ov as da,ow as ys,ox as fa,fK as ht,s_ as Ar,ie as Ir,oj as xs,bg as Pr,bj as Cr,b9 as Fi,fZ as ws,vE as pa,vF as ma,oh as va,au as Yt,rH as ga,vG as Lr,ba as Oe,ko as Nr,kn as Ji,jc as _a,id as Kt,vH as Ta,f_ as Ms,uU as Ea,h2 as gr,vI as Fr,rX as ya,bt as lt,f$ as er,ae as Os,vJ as xa,bp as xe,bY as tr,il as $s,lY as bi,kt as wa,ry as Ma,ao as Oa,gQ as $a,bf as Sa,fX as Ra,o8 as ba,h$ as Ss,n2 as Aa,b8 as Rs,a3 as Ia,dG as Pa,dT as et,dU as De,js as ir,ju as hi,jm as Dr,vK as Ca,jW as rr}from"./index-rbwFz4i4.js";import{r as La}from"./videoUtils-6P9aY_11.js";import{t as Na}from"./requestImageUtils-B3r_fvFm.js";import{u as vt,t as bs,O as sr,s as Je,a as Fa}from"./basicInterfaces-CZwQPxTp.js";import{_ as $t}from"./TextureFormat-1mYWTFa-.js";import{s as G,l as Da,g as As,h as Ua,o as di,m as Ba,T as Ur,f as Br,J as zr,p as za,y as Ha}from"./BufferView-BiQ968Zu.js";import{r as Hr,t as Va,e as Q}from"./mat4f64-q_b6UJoq.js";import{e as ka,A as Ga}from"./Indices-C2d6JGWI.js";import{S as ja}from"./triangle-nTXLD-Bt.js";import{e as x}from"./VertexAttribute-B3BTnNfN.js";import{n as d,t as re}from"./glsl-Cj7KC756.js";import{a as L}from"./BindType-BBwFZqyN.js";import{u as nr,n as ge,C as Is,H as Wa}from"./ShaderOutput-Bdd80V3g.js";import{r as qa,p as Xa,c as Ya,B as Ka,g as Qa,o as Za}from"./renderState-BoFtvD5i.js";import{e as Ai}from"./mat3f64-B5o_lm6j.js";import"./boundedPlane-CQusdHbn.js";import{E as _r,U as Ke,b as Ps,k as Cs,Q as Ja,L as eo}from"./sphere-CqjQASlZ.js";import{n as Vr}from"./projectVectorToVector-Cy7M1eLd.js";import{H as Ls,N as to,L as Ns,I as io,P as ro,s as so,u as no,a as ao,l as oo,v as lo,g as We,j as Fs}from"./frustum-Djv-21iI.js";import{a as co}from"./vectorStacks-lvhEIJ0s.js";import"./IntersectorType-gQim6TH1.js";import{I as uo,L as ho}from"./orientedBoundingBox-BruFRuaa.js";import{i as kr}from"./projectPointToVector-BeWRphB-.js";import{m as fo,v as po,h as mo}from"./lineSegment-MXltXHs2.js";import{x as vo,l as Gr,M as jr,j as go,z as Wr,Z as _o,t as To,W as St,O as Eo}from"./plane-BKe-xIys.js";function sh(e,t=!1){return e<=dr?t?new Array(e).fill(0):new Array(e):new Float32Array(e)}function nh(e){return(Array.isArray(e)?e.length:e.byteLength/8)<=dr?Array.from(e):new Float32Array(e)}function ah(e,t,i){return Array.isArray(e)?e.slice(t,t+i):e.subarray(t,t+i)}let j=class{constructor(t,i,r,s,n=null){if(this.name=t,this.type=i,this.arraySize=n,this.bind={[L.Bind]:null,[L.Pass]:null,[L.Draw]:null},s)switch(r){case void 0:break;case L.Bind:this.bind[L.Bind]=s;break;case L.Pass:this.bind[L.Pass]=s;break;case L.Draw:this.bind[L.Draw]=s}}equals(t){return this.type===t.type&&this.name===t.name&&this.arraySize===t.arraySize}},ar=class extends j{constructor(t,i){super(t,"sampler2D",L.Draw,(r,s,n)=>r.bindTexture(t,i(s,n)))}};function yo(){return!!Nn("enable-feature:objectAndLayerId-rendering")}let Ds=class extends j{constructor(t,i,r){super(t,"float",L.Bind,(s,n)=>s.setUniform1f(t,i(n),r))}};function xo({code:e,uniforms:t},i){t.add(new Ds("dpDummy",()=>1)),e.add(d`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 hiD = hiA + hiB;
vec3 loD = loA + loB;
return  dpDummy * hiD + loD;
}`)}let Te=class extends j{constructor(t,i,r){super(t,"vec3",L.Draw,(s,n,a,o)=>s.setUniform3fv(t,i(n,a,o),r))}},he=class extends j{constructor(t,i,r){super(t,"vec3",L.Pass,(s,n,a)=>s.setUniform3fv(t,i(n,a),r))}},wo=class extends j{constructor(t,i,r){super(t,"mat3",L.Draw,(s,n,a)=>s.setUniformMatrix3fv(t,i(n,a),r))}},Us=class extends j{constructor(t,i,r){super(t,"mat3",L.Pass,(s,n,a)=>s.setUniformMatrix3fv(t,i(n,a),r))}},fi=class extends j{constructor(t,i,r){super(t,"mat4",L.Bind,(s,n)=>s.setUniformMatrix4fv(t,i(n),r))}},W=class extends fr{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};f([p()],W.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),f([p()],W.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),f([p()],W.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),f([p()],W.prototype,"DECONFLICTOR_SHOW_GRID",void 0),f([p()],W.prototype,"LABELS_SHOW_BORDER",void 0),f([p()],W.prototype,"TEXT_SHOW_BASELINE",void 0),f([p()],W.prototype,"TEXT_SHOW_BORDER",void 0),f([p()],W.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),f([p()],W.prototype,"OVERLAY_SHOW_CENTER",void 0),f([p()],W.prototype,"SHOW_POI",void 0),f([p()],W.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),f([p()],W.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),f([p()],W.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),f([p()],W.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),f([p()],W.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),f([p()],W.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),f([p()],W.prototype,"I3S_TREE_SHOW_TILES",void 0),f([p()],W.prototype,"I3S_SHOW_MODIFICATIONS",void 0),f([p()],W.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),f([p()],W.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),f([p()],W.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),f([p()],W.prototype,"LINE_WIREFRAMES",void 0),W=f([pr("esri.views.3d.support.debugFlags")],W);const Mo=new W;function Oo(){return qr??(qr=(async()=>{const e=await Fn(()=>import("./basis_transcoder-51bwqjSK.js"),[]),t=await e.default({locateFile:i=>Dn(`esri/libs/basisu/${i}`)});return t.initializeBasis(),t})()),qr}let qr,Re=null,Qt=null;async function Bs(){return Qt==null&&(Qt=Oo(),Re=await Qt),Qt}function $o(e,t){if(Re==null)return e.byteLength;const i=new Re.BasisFile(new Uint8Array(e)),r=Hs(i)?zs(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),t):0;return i.close(),i.delete(),r}function So(e,t){if(Re==null)return e.byteLength;const i=new Re.KTX2File(new Uint8Array(e)),r=Vs(i)?zs(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),t):0;return i.close(),i.delete(),r}function zs(e,t,i,r,s){const n=Un(t?ze.COMPRESSED_RGBA8_ETC2_EAC:ze.COMPRESSED_RGB8_ETC2),a=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*r*n*a)}function Hs(e){return e.getNumImages()>=1&&!e.isUASTC()}function Vs(e){return e.getFaces()>=1&&e.isETC1S()}async function Ro(e,t,i){Re==null&&(Re=await Bs());const r=new Re.BasisFile(new Uint8Array(i));if(!Hs(r))return null;r.startTranscoding();const s=ks(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(n,a)=>r.getImageTranscodedSizeInBytes(0,n,a),(n,a,o)=>r.transcodeImage(o,0,n,a,0,0));return r.close(),r.delete(),s}async function bo(e,t,i){Re==null&&(Re=await Bs());const r=new Re.KTX2File(new Uint8Array(i));if(!Vs(r))return null;r.startTranscoding();const s=ks(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(n,a)=>r.getImageTranscodedSizeInBytes(n,0,0,a),(n,a,o)=>r.transcodeImage(o,n,0,0,a,0,-1,-1));return r.close(),r.delete(),s}function ks(e,t,i,r,s,n,a,o){const{compressedTextureETC:l,compressedTextureS3TC:u}=e.capabilities,[c,h]=l?r?[$t.ETC2_RGBA,ze.COMPRESSED_RGBA8_ETC2_EAC]:[$t.ETC1_RGB,ze.COMPRESSED_RGB8_ETC2]:u?r?[$t.BC3_RGBA,ze.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[$t.BC1_RGB,ze.COMPRESSED_RGB_S3TC_DXT1_EXT]:[$t.RGBA32,oe.RGBA],_=t.hasMipmap?i:Math.min(1,i),g=[];for(let m=0;m<_;m++)g.push(new Uint8Array(a(m,c))),o(m,c,g[m]);return t.internalFormat=h,t.hasMipmap=g.length>1,t.samplingMode=t.hasMipmap?Ee.LINEAR_MIPMAP_LINEAR:Ee.LINEAR,t.width=s,t.height=n,new Ht(e,t,{type:"compressed",levels:g})}const Zt=()=>mr.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Ao=542327876,Io=131072,Po=4;function Tr(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function Co(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}const Lo=Tr("DXT1"),No=Tr("DXT3"),Fo=Tr("DXT5"),Do=31,Uo=0,Bo=1,zo=2,Ho=3,Vo=4,ko=7,Go=20,jo=21;function Wo(e,t,i){const r=qo(i,t.hasMipmap??!1);if(r==null)throw new Error("DDS texture data is null");const{textureData:s,internalFormat:n,width:a,height:o}=r;return t.samplingMode=s.levels.length>1?Ee.LINEAR_MIPMAP_LINEAR:Ee.LINEAR,t.hasMipmap=s.levels.length>1,t.internalFormat=n,t.width=a,t.height=o,new Ht(e,t,s)}function qo(e,t){const i=new Int32Array(e.buffer,e.byteOffset,Do);if(i[Uo]!==Ao)return Zt().error("Invalid magic number in DDS header"),null;if(!(i[Go]&Po))return Zt().error("Unsupported format, must contain a FourCC code"),null;const r=i[jo];let s,n;switch(r){case Lo:s=8,n=ze.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case No:s=16,n=ze.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Fo:s=16,n=ze.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return Zt().error("Unsupported FourCC code:",Co(r)),null}let a=1,o=i[Vo],l=i[Ho];(3&o||3&l)&&(Zt().warn("Rounding up compressed texture size to nearest multiple of 4."),o=o+3&-4,l=l+3&-4);const u=o,c=l;let h,_;i[zo]&Io&&t!==!1&&(a=Math.max(1,i[ko]));let g=e.byteOffset+i[Bo]+4;const m=[];for(let M=0;M<a;++M)_=(o+3>>2)*(l+3>>2)*s,h=new Uint8Array(e.buffer,g,_),m.push(h),g+=_,o=Math.max(1,o>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:m},internalFormat:n,width:u,height:c}}const Qe=16;function Xr(e,t){return t=Math.floor(t/Qe)*Qe,Math.min(Math.round(e/Qe)*Qe,t)}function vh(e,t){return t=Math.floor(t/Qe)*Qe,Math.min(Math.ceil(e/Qe)*Qe,t)}function Xo(e,t){const[i,r]=Yo(e,t);return e.width===i&&e.height===r?e:Gs(e,i,r)}function Yo({width:e,height:t},{maxPreferredTexturePixels:i,maxTextureSize:r}){const s=Math.max(e,t),n=e*t;if(s<=r&&n<=i)return[e,t];const a=Math.min(Math.sqrt(i/n),r/s);return[Xr(Math.round(e*a),r),Xr(Math.round(t*a),r)]}function Gs(e,t,i){if(e instanceof ImageData)return Gs(Ko(e),t,i);const r=document.createElement("canvas");return r.width=t,r.height=i,r.getContext("2d").drawImage(e,0,0,r.width,r.height),r}function Ko(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");if(i==null)throw new yt("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return i.putImageData(e,0,0),t}let gh=class{constructor(t,i){this._data=t,this.id=Si(),this.events=new Bn,this._parameters={...Zo,...i},this._startPreload(t)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(t){t instanceof HTMLVideoElement?(this.update=i=>this._update(t,i),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t)}_startPreloadVideoElement(t){if(!(Rr(t.src)||t.preload==="auto"&&t.crossOrigin)&&(t.preload="auto",t.crossOrigin="anonymous",t.src=t.src,t.paused&&t.autoplay)){const i=[];La(t,r=>i.push(r)).then(()=>{t.play()}).finally(()=>i.forEach(r=>r.remove()))}}_startPreloadImageElement(t){zn(t.src)||Rr(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){const i=new we;return i.wrapMode=this._parameters.wrap??ye.REPEAT,i.flipped=!this._parameters.noUnpackFlip,i.samplingMode=this._parameters.mipmap?Ee.LINEAR_MIPMAP_LINEAR:Ee.LINEAR,i.hasMipmap=!!this._parameters.mipmap,i.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,i.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),i}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return this._glTexture!=null}get usedMemory(){var t;return((t=this._glTexture)==null?void 0:t.usedMemory)||Qo(this._data,this._parameters)}load(t){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const i=this._data;return i==null?(this._glTexture=new Ht(t,this._createDescriptor(t),null),this._glTexture):(this._emptyTexture=t.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof i=="string"?this._loadFromURL(t,i):i instanceof Image?this._loadFromImageElement(t,i):i instanceof HTMLVideoElement?this._loadFromVideoElement(t,i):i instanceof ImageData||i instanceof HTMLCanvasElement?this._loadFromImage(t,i):Ct(i)&&this._parameters.encoding===vt.DDS_ENCODING?this._loadFromDDSData(t,i):Lt(i)&&this._parameters.encoding===vt.DDS_ENCODING?this._loadFromDDSData(t,new Uint8Array(i)):(Lt(i)||Ct(i))&&this._parameters.encoding===vt.KTX2_ENCODING?this._loadFromKTX2(t,i):(Lt(i)||Ct(i))&&this._parameters.encoding===vt.BASIS_ENCODING?this._loadFromBasis(t,i):Ct(i)?this._loadFromPixelData(t,i):Lt(i)?this._loadFromPixelData(t,new Uint8Array(i)):null)}_update(t,i){return this._glTexture==null||t.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||i===t.currentTime?i:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,i){return this._glTexture=Wo(t,this._createDescriptor(t),i),this._emptyTexture=null,this._glTexture}_loadFromKTX2(t,i){return this._loadAsync(()=>bo(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromBasis(t,i){return this._loadAsync(()=>Ro(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(t,i){G(this._parameters.width>0&&this._parameters.height>0);const r=this._createDescriptor(t);return r.pixelFormat=this._parameters.components===1?oe.LUMINANCE:this._parameters.components===3?oe.RGB:oe.RGBA,r.pixelFormat!==oe.RGB&&r.pixelFormat!==oe.RGBA||(r.compress=this._parameters.compressionOptions),r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new Ht(t,r,i),this._glTexture}_loadFromURL(t,i){return this._loadAsync(async r=>{const s=await Na(i,{signal:r});return br(r),this._loadFromImage(t,s)})}_loadFromImageElement(t,i){return i.complete?this._loadFromImage(t,i):this._loadAsync(async r=>{const s=await Hn(i,i.src,!1,r);return br(r),this._loadFromImage(t,s)})}_loadFromVideoElement(t,i){return i.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(t,i):this._loadFromVideoElementAsync(t,i)}_loadFromVideoElementAsync(t,i){return this._loadAsync(r=>new Promise((s,n)=>{const a=()=>{i.removeEventListener("loadeddata",o),i.removeEventListener("error",l),Gn(u)},o=()=>{i.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(a(),s(this._loadFromImage(t,i)))},l=c=>{a(),n(c||new yt("texture:load-error","Failed to load video"))};i.addEventListener("loadeddata",o),i.addEventListener("error",l);const u=Vn(r,()=>l(kn()))}))}_loadFromImage(t,i){let r=i;r instanceof HTMLVideoElement||(r=Xo(r,t.parameters));const s=js(r);this._parameters.width=s.width,this._parameters.height=s.height;const n=this._createDescriptor(t);return n.pixelFormat=this._parameters.components===3?oe.RGB:oe.RGBA,n.width=s.width,n.height=s.height,n.compress=this._parameters.compressionOptions,this._glTexture=new Ht(t,n,r),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(t){const i=new AbortController;this._loadingController=i;const r=t(i.signal);this._loadingPromise=r;const s=()=>{this._loadingController===i&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null),this._emptyTexture=null};return r.then(s,s),r}unload(){if(this._glTexture=Qi(this._glTexture),this._emptyTexture=null,this._loadingController!=null){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}};function Qo(e,t){if(e==null)return 0;if(Lt(e)||Ct(e))return t.encoding===vt.KTX2_ENCODING?So(e,!!t.mipmap):t.encoding===vt.BASIS_ENCODING?$o(e,!!t.mipmap):e.byteLength;const{width:i,height:r}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?js(e):t;return(t.mipmap?4/3:1)*i*r*(t.components||4)||0}function js(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}const Zo={wrap:{s:ye.REPEAT,t:ye.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};function Jo(e){if(e.length<dr)return Array.from(e);if(Array.isArray(e))return Float64Array.from(e);if(!("BYTES_PER_ELEMENT"in e))return Array.from(e);switch(e.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(e);case 2:return jn(e)?Da().from(e):Wn(e)?Uint16Array.from(e):Int16Array.from(e);case 4:return Float32Array.from(e);default:return Float64Array.from(e)}}let el=class Ws{constructor(t,i,r){this.primitiveIndices=t,this._numIndexPerPrimitive=i,this.position=r,this._children=void 0,G(t.length>=1),G(r.size===3||r.size===4);const{data:s,size:n,indices:a}=r;G(a.length%this._numIndexPerPrimitive===0),G(a.length>=t.length*this._numIndexPerPrimitive);const o=t.length;let l=n*a[this._numIndexPerPrimitive*t[0]];it.clear(),it.push(l);const u=fe(s[l],s[l+1],s[l+2]),c=ms(u);for(let g=0;g<o;++g){const m=this._numIndexPerPrimitive*t[g];for(let M=0;M<this._numIndexPerPrimitive;++M){l=n*a[m+M],it.push(l);let E=s[l];u[0]=Math.min(E,u[0]),c[0]=Math.max(E,c[0]),E=s[l+1],u[1]=Math.min(E,u[1]),c[1]=Math.max(E,c[1]),E=s[l+2],u[2]=Math.min(E,u[2]),c[2]=Math.max(E,c[2])}}this.bbMin=u,this.bbMax=c;const h=Ti(v(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(c[0]-u[0],c[1]-u[1]),c[2]-u[2]);let _=this.radius*this.radius;for(let g=0;g<it.length;++g){l=it.at(g);const m=s[l]-h[0],M=s[l+1]-h[1],E=s[l+2]-h[2],F=m*m+M*M+E*E;if(F<=_)continue;const P=Math.sqrt(F),A=.5*(P-this.radius);this.radius=this.radius+A,_=this.radius*this.radius;const I=A/P;h[0]+=m*I,h[1]+=M*I,h[2]+=E*I}this.center=h,it.clear()}getChildren(){if(this._children||Xn(this.bbMin,this.bbMax)<=1)return this._children;const t=Ti(v(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,r=new Uint8Array(i),s=new Array(8);for(let c=0;c<8;++c)s[c]=0;const{data:n,size:a,indices:o}=this.position;for(let c=0;c<i;++c){let h=0;const _=this._numIndexPerPrimitive*this.primitiveIndices[c];let g=a*o[_],m=n[g],M=n[g+1],E=n[g+2];for(let F=1;F<this._numIndexPerPrimitive;++F){g=a*o[_+F];const P=n[g],A=n[g+1],I=n[g+2];P<m&&(m=P),A<M&&(M=A),I<E&&(E=I)}m<t[0]&&(h|=1),M<t[1]&&(h|=2),E<t[2]&&(h|=4),r[c]=h,++s[h]}let l=0;for(let c=0;c<8;++c)s[c]>0&&++l;if(l<2)return;const u=new Array(8);for(let c=0;c<8;++c)u[c]=s[c]>0?new Uint32Array(s[c]):void 0;for(let c=0;c<8;++c)s[c]=0;for(let c=0;c<i;++c){const h=r[c];u[h][s[h]++]=this.primitiveIndices[c]}this._children=new Array;for(let c=0;c<8;++c)u[c]!==void 0&&this._children.push(new Ws(u[c],this._numIndexPerPrimitive,this.position));return this._children}static prune(){it.prune()}};const it=new qn({deallocator:null});function tl(e,t){if(!e)return!1;const{size:i,data:r,indices:s}=e;k(t,0,0,0),k(me,0,0,0);let n=0,a=0;for(let o=0;o<s.length-2;o+=3){const l=s[o]*i,u=s[o+1]*i,c=s[o+2]*i;k(Y,r[l],r[l+1],r[l+2]),k(Ue,r[u],r[u+1],r[u+2]),k(Jt,r[c],r[c+1],r[c+2]);const h=ja(Y,Ue,Jt);h?(ve(Y,Y,Ue),ve(Y,Y,Jt),X(Y,Y,1/3*h),ve(t,t,Y),n+=h):(ve(me,me,Y),ve(me,me,Ue),ve(me,me,Jt),a+=3)}return(a!==0||n!==0)&&(n!==0?(X(t,t,1/n),!0):a!==0&&(X(t,me,1/a),!0))}function il(e,t){if(!e)return!1;const{size:i,data:r,indices:s}=e;k(t,0,0,0);let n=-1,a=0;for(let o=0;o<s.length;o++){const l=s[o]*i;n!==l&&(t[0]+=r[l],t[1]+=r[l+1],t[2]+=r[l+2],a++),n=l}return a>1&&X(t,t,1/a),a>0}function rl(e,t,i){if(!e)return!1;k(i,0,0,0),k(me,0,0,0);let r=0,s=0;const{size:n,data:a,indices:o}=e,l=o.length-1,u=l+(t?2:0);for(let c=0;c<u;c+=2){const h=c<l?c+1:0,_=o[c<l?c:l]*n,g=o[h]*n;Y[0]=a[_],Y[1]=a[_+1],Y[2]=a[_+2],Ue[0]=a[g],Ue[1]=a[g+1],Ue[2]=a[g+2],X(Y,ve(Y,Y,Ue),.5);const m=Yn(Y,Ue);m>0?(ve(i,i,X(Y,Y,m)),r+=m):r===0&&(ve(me,me,Y),s++)}return r!==0?(X(i,i,1/r),!0):s!==0&&(X(i,me,1/s),!0)}const Y=v(),Ue=v(),Jt=v(),me=v();var nt;(function(e){e[e.Mesh=0]="Mesh",e[e.Point=1]="Point",e[e.Line=2]="Line"})(nt||(nt={}));let qs=class{constructor(){this.uid=Si()}},sl=class extends qs{constructor(t){super(),this.highlightName=t,this.channel=bs.Highlight}},yh=class extends qs{constructor(){super(...arguments),this.channel=bs.MaskOccludee}},wh=class Xs{constructor(t,i,r=null,s=nt.Mesh,n=null,a=-1){this.material=t,this.mapPositions=r,this.type=s,this.objectAndLayerIdColor=n,this.edgeIndicesLength=a,this.highlights=new Set,this._highlightOptionsCounts=new Map,this.id=Si(),this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[o,l]of i)this._attributes.set(o,{...l,indices:ka(l.indices)}),o===x.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(o).indices.length:this.edgeIndicesLength)}instantiate(t={}){const i=new Xs(t.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach((r,s)=>{r.exclusive=!1,i._attributes.set(s,r)}),i._boundingInfo=this._boundingInfo,i.transformation=t.transformation||this.transformation,i}get attributes(){return this._attributes}getMutableAttribute(t){let i=this._attributes.get(t);return i&&!i.exclusive&&(i={...i,exclusive:!0,data:Jo(i.data)},this._attributes.set(t,i)),i}setAttributeData(t,i){const r=this._attributes.get(t);r?this._attributes.set(t,{...r,exclusive:!0,data:i}):vs()&&console.warn(`Setting undefined attribute ${t} data`)}get indexCount(){var i;const t=(i=this._attributes.values().next().value)==null?void 0:i.indices;return(t==null?void 0:t.length)??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(t){return!!(this.type===nt.Mesh?this._computeAttachmentOriginTriangles(t):this.type===nt.Line?this._computeAttachmentOriginLines(t):this._computeAttachmentOriginPoints(t))&&(this._transformation!=null&&Ce(t,t,this._transformation),!0)}_computeAttachmentOriginTriangles(t){const i=this.attributes.get(x.POSITION);return tl(i,t)}_computeAttachmentOriginLines(t){const i=this.attributes.get(x.POSITION);return rl(i,nl(this.material.parameters,i),t)}_computeAttachmentOriginPoints(t){const i=this.attributes.get(x.POSITION);return il(i,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.attributes.get(x.POSITION);if(!t||t.indices.length===0)return null;const i=this.type===nt.Mesh?3:1;G(t.indices.length%i===0,"Indexing error: "+t.indices.length+" not divisible by "+i);const r=Ga(t.indices.length/i);return new el(r,i,t)}get transformation(){return this._transformation??Hr}set transformation(t){this._transformation=t&&t!==Hr?Va(t):null}get highlightNames(){return this._highlightOptionsCounts}get hasHighlights(){return this._highlightOptionsCounts.size>0}foreachHighlightOptions(t){this._highlightOptionsCounts.forEach((i,r)=>t(r))}allocateIdAndHighlight(t){const i=new sl(t);return this.addHighlight(i)}addHighlight(t){this.highlights.add(t);const{highlightName:i}=t,r=(this._highlightOptionsCounts.get(i)??0)+1;return this._highlightOptionsCounts.set(i,r),t}removeHighlight(t){if(this.highlights.delete(t)){const{highlightName:i}=t,r=this._highlightOptionsCounts.get(i)??0;r<=1?this._highlightOptionsCounts.delete(i):this._highlightOptionsCounts.set(i,r-1)}}};function nl(e,t){return!(!("isClosed"in e)||!e.isClosed)&&t.indices.length>2}var Ve;function al(e,t){switch(t.textureCoordinateType){case Ve.Default:return e.attributes.add(x.UV0,"vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(d`void forwardTextureCoordinates() { vuv0 = uv0; }`);case Ve.Atlas:return e.attributes.add(x.UV0,"vec2"),e.attributes.add(x.UVREGION,"vec4"),e.varyings.add("vuv0","vec2"),e.varyings.add("vuvRegion","vec4"),void e.vertex.code.add(d`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:Kn(t.textureCoordinateType);case Ve.None:return void e.vertex.code.add(d`void forwardTextureCoordinates() {}`);case Ve.COUNT:return}}(function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Atlas=2]="Atlas",e[e.COUNT=3]="COUNT"})(Ve||(Ve={}));function ol(e){e.fragment.code.add(d`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)}function Ys(e,t){const{textureCoordinateType:i}=t;if(i===Ve.None||i===Ve.COUNT)return;e.include(al,t);const r=i===Ve.Atlas;r&&e.include(ol),e.fragment.code.add(d`
    vec4 textureLookup(sampler2D tex, vec2 uv) {
      return ${r?"textureAtlasLookup(tex, uv, vuvRegion)":"texture(tex, uv)"};
    }
  `)}let ll=class extends j{constructor(t,i,r){super(t,"float",L.Draw,(s,n,a)=>s.setUniform1f(t,i(n,a),r))}},cl=class extends j{constructor(t,i,r){super(t,"float",L.Pass,(s,n,a)=>s.setUniform1f(t,i(n,a),r))}},or=class extends j{constructor(t,i){super(t,"sampler2D",L.Pass,(r,s,n)=>r.bindTexture(t,i(s,n)))}},ul=class{constructor(t){this._material=t.material,this._techniques=t.techniques,this._output=t.output}dispose(){}get _stippleTextures(){return this._techniques.context.stippleTextures}get _markerTextures(){return this._techniques.context.markerTextures}getTechnique(t,i){return this._techniques.get(t,this._material.getConfiguration(this._output,i))}ensureResources(t){return sr.LOADED}},hl=class{};const Ot=hl;let bh=class extends ul{constructor(t){super(t),this._numLoading=0,this._disposed=!1,this._textures=t.textures,this.updateTexture(t.textureId),this._acquire(t.normalTextureId,i=>this._textureNormal=i),this._acquire(t.emissiveTextureId,i=>this._textureEmissive=i),this._acquire(t.occlusionTextureId,i=>this._textureOcclusion=i),this._acquire(t.metallicRoughnessTextureId,i=>this._textureMetallicRoughness=i)}dispose(){super.dispose(),this._texture=tt(this._texture),this._textureNormal=tt(this._textureNormal),this._textureEmissive=tt(this._textureEmissive),this._textureOcclusion=tt(this._textureOcclusion),this._textureMetallicRoughness=tt(this._textureMetallicRoughness),this._disposed=!0}ensureResources(t){return this._numLoading===0?sr.LOADED:sr.LOADING}get textureBindParameters(){var t,i,r,s,n;return new fl(((t=this._texture)==null?void 0:t.glTexture)??null,((i=this._textureNormal)==null?void 0:i.glTexture)??null,((r=this._textureEmissive)==null?void 0:r.glTexture)??null,((s=this._textureOcclusion)==null?void 0:s.glTexture)??null,((n=this._textureMetallicRoughness)==null?void 0:n.glTexture)??null)}updateTexture(t){this._texture!=null&&t===this._texture.id||(this._texture=tt(this._texture),this._acquire(t,i=>this._texture=i))}_acquire(t,i){if(t==null)return void i(null);const r=this._textures.acquire(t);if(Qn(r))return++this._numLoading,void r.then(s=>{if(this._disposed)return tt(s),void i(null);i(s)}).finally(()=>--this._numLoading);i(r)}},dl=class extends Ot{constructor(t=null){super(),this.textureEmissive=t}},fl=class extends dl{constructor(t,i,r,s,n,a,o){super(r),this.texture=t,this.textureNormal=i,this.textureOcclusion=s,this.textureMetallicRoughness=n,this.scale=a,this.normalTextureTransformMatrix=o}};var gt;(function(e){e[e.None=0]="None",e[e.SymbolColor=1]="SymbolColor",e[e.EmissiveColor=2]="EmissiveColor",e[e.Texture=3]="Texture",e[e.COUNT=4]="COUNT"})(gt||(gt={}));function pl(e,t){if(!nr(t.output))return;const{emissionSource:i,hasEmissiveTextureTransform:r,bindType:s}=t,n=i===gt.Texture;n&&(e.include(Ys,t),e.fragment.uniforms.add(s===L.Pass?new or("texEmission",u=>u.textureEmissive):new ar("texEmission",u=>u.textureEmissive)));const a=i===gt.EmissiveColor||n;a&&e.fragment.uniforms.add(s===L.Pass?new he("emissiveBaseColor",u=>u.emissiveBaseColor):new Te("emissiveBaseColor",u=>u.emissiveBaseColor));const o=i!==gt.None;o&&e.fragment.uniforms.add(s===L.Pass?new cl("emissiveStrength",u=>u.emissiveStrength):new ll("emissiveStrength",u=>u.emissiveStrength));const l=i===gt.SymbolColor;e.fragment.code.add(d`
    vec4 getEmissions(vec3 symbolColor) {
      vec4 emissions = ${a?"vec4(emissiveBaseColor, 1.0)":l?"vec4(symbolColor, 1.0)":"vec4(0.0)"};
      ${re(n,`emissions *= textureLookup(texEmission, ${r?"emissiveUV":"vuv0"});
         emissions.w = emissions.rgb == vec3(0.0) ? 0.0: emissions.w;`)}
      ${re(o,"emissions.rgb *= emissiveStrength;")}
      return emissions;
    }
  `)}var st;(function(e){e[e.Disabled=0]="Disabled",e[e.Normal=1]="Normal",e[e.Schematic=2]="Schematic",e[e.Water=3]="Water",e[e.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",e[e.Simplified=5]="Simplified",e[e.TerrainWithWater=6]="TerrainWithWater",e[e.COUNT=7]="COUNT"})(st||(st={}));function Ch(e,t){const i=t.pbrMode,r=e.fragment;if(i!==st.Schematic&&i!==st.Disabled&&i!==st.Normal)return void r.code.add(d`void applyPBRFactors() {}`);if(i===st.Disabled)return void r.code.add(d`void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`);if(i===st.Schematic)return void r.code.add(d`vec3 mrr = vec3(0.0, 0.6, 0.2);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`);const{hasMetallicRoughnessTexture:s,hasMetallicRoughnessTextureTransform:n,hasOcclusionTexture:a,hasOcclusionTextureTransform:o,bindType:l}=t;(s||a)&&e.include(Ys,t),r.code.add(d`vec3 mrr;
float occlusion;`),s&&r.uniforms.add(l===L.Pass?new or("texMetallicRoughness",u=>u.textureMetallicRoughness):new ar("texMetallicRoughness",u=>u.textureMetallicRoughness)),a&&r.uniforms.add(l===L.Pass?new or("texOcclusion",u=>u.textureOcclusion):new ar("texOcclusion",u=>u.textureOcclusion)),r.uniforms.add(l===L.Pass?new he("mrrFactors",u=>u.mrrFactors):new Te("mrrFactors",u=>u.mrrFactors)),r.code.add(d`
    ${re(s,d`void applyMetallicRoughness(vec2 uv) {
            vec3 metallicRoughness = textureLookup(texMetallicRoughness, uv).rgb;
            mrr[0] *= metallicRoughness.b;
            mrr[1] *= metallicRoughness.g;
          }`)}

    ${re(a,"void applyOcclusion(vec2 uv) { occlusion *= textureLookup(texOcclusion, uv).r; }")}

    float getBakedOcclusion() {
      return ${a?"occlusion":"1.0"};
    }

    void applyPBRFactors() {
      mrr = mrrFactors;
      occlusion = 1.0;

      ${re(s,`applyMetallicRoughness(${n?"metallicRoughnessUV":"vuv0"});`)}
      ${re(a,`applyOcclusion(${o?"occlusionUV":"vuv0"});`)}
    }
  `)}const Ks=new Map([[x.POSITION,0],[x.NORMAL,1],[x.NORMALCOMPRESSED,1],[x.UV0,2],[x.UVI,2],[x.COLOR,3],[x.COLORFEATUREATTRIBUTE,3],[x.SIZE,4],[x.TANGENT,4],[x.CENTEROFFSETANDDISTANCE,5],[x.SYMBOLCOLOR,5],[x.FEATUREATTRIBUTE,6],[x.INSTANCEFEATUREATTRIBUTE,6],[x.OLIDCOLOR,6],[x.INSTANCEOBJECTANDLAYERIDCOLOR,6],[x.INSTANCECOLOR,7],[x.ROTATION,8],[x.INSTANCEMODEL,8],[x.INSTANCEMODELNORMAL,12],[x.INSTANCEMODELORIGINHI,11],[x.INSTANCEMODELORIGINLO,15]]);let ml=class{constructor(t){this._bits=[...t]}equals(t){return gs(this._bits,t.bits)}get code(){return this._code??(this._code=String.fromCharCode(...this._bits)),this._code}get bits(){return this._bits}},vl=class extends Ot{constructor(){var t;super(),this._parameterBits=((t=this._parameterBits)==null?void 0:t.map(()=>0))??[],this._parameterNames??(this._parameterNames=[])}get key(){return this._key??(this._key=new ml(this._parameterBits)),this._key}decode(t=this.key){const i=this._parameterBits;this._parameterBits=[...t.bits];const r=this._parameterNames.map(s=>`    ${s}: ${this[s]}`).join(`
`);return this._parameterBits=i,r}};function ei(e={}){return(t,i)=>{var u,c;t.hasOwnProperty("_parameterNames")||Object.defineProperty(t,"_parameterNames",{value:((u=t._parameterNames)==null?void 0:u.slice())??[],configurable:!0,writable:!0}),t.hasOwnProperty("_parameterBits")||Object.defineProperty(t,"_parameterBits",{value:((c=t._parameterBits)==null?void 0:c.slice())??[0],configurable:!0,writable:!0}),t._parameterNames.push(i);const r=e.count||2,s=Math.ceil(Math.log2(r)),n=t._parameterBits;let a=0;for(;n[a]+s>16;)a++,a>=n.length&&n.push(0);const o=n[a],l=(1<<s)-1<<o;n[a]+=s,e.count?Object.defineProperty(t,i,{get(){return(this._parameterBits[a]&l)>>o},set(h){if(this[i]!==h){if(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~l|+h<<o&l,typeof h!="number")throw new yt("internal:invalid-shader-configuration",`Configuration value for ${i} must be a number, got ${typeof h}`);if(e.count==null)throw new yt("internal:invalid-shader-configuration",`Configuration value for ${i} must provide a count option`)}}}):Object.defineProperty(t,i,{get(){return!!((this._parameterBits[a]&l)>>o)},set(h){if(this[i]!==h&&(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~l|+h<<o&l,typeof h!="boolean"))throw new yt("internal:invalid-shader-configuration",`Configuration value for ${i} must be boolean, got ${typeof h}`)}})}}let gl=class extends vl{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}};var Z;(function(e){e[e.NONE=0]="NONE",e[e.ColorAlpha=1]="ColorAlpha",e[e.FrontFace=2]="FrontFace",e[e.COUNT=3]="COUNT"})(Z||(Z={}));let Nt=class extends gl{constructor(){super(...arguments),this.output=ge.Color,this.oitPass=Z.NONE,this.hasSlicePlane=!1,this.hasHighlightMixTexture=!1,this.bindType=L.Pass,this.writeDepth=!0}};f([ei({count:ge.COUNT})],Nt.prototype,"output",void 0),f([ei({count:Z.COUNT})],Nt.prototype,"oitPass",void 0),f([ei()],Nt.prototype,"hasSlicePlane",void 0),f([ei()],Nt.prototype,"hasHighlightMixTexture",void 0);function _l(e){return Math.abs(e*e*e)}function Qs(e,t,i){const r=i.parameters;return Di.scale=Math.min(r.divisor/(t-r.offset),1),Di.factor=_l(e),Di}function Zs(e,t){return le(e*Math.max(t.scale,t.minScaleFactor),e,t.factor)}function Tl(e,t,i){const r=Qs(e,t,i);return r.minScaleFactor=0,Zs(1,r)}function Uh(e,t,i,r){r.scale=Tl(e,t,i),r.factor=0,r.minScaleFactor=i.minScaleFactor}function Bh(e,t,i=[0,0]){const r=Math.min(Math.max(t.scale,t.minScaleFactor),1);return i[0]=e[0]*r,i[1]=e[1]*r,i}function El(e,t,i,r){return Zs(e,Qs(t,i,r))}const Di={scale:0,factor:0,minScaleFactor:0};function zh(e,t,i,r,s){let n=i.screenLength*e.pixelRatio;s!=null&&(n=El(n,r,t,s));const a=n*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return Ri(a*t,i.minWorldLength,i.maxWorldLength)}function Yr(e,t){let i=!1;for(const r in t){const s=t[r];s!==void 0&&(Array.isArray(s)?Array.isArray(e[r])&&gs(s,e[r])||(e[r]=s.slice(),i=!0):e[r]!==s&&(i=!0,e[r]=s))}return i}const Hh={multiply:1,ignore:2,replace:3,tint:4};let Vh=class{constructor(t,i){this.id=Si(),this.supportsEdges=!1,this.vertexAttributeLocations=Ks,this._renderPriority=0,this._parameters=new i,Yr(this._parameters,t),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(t){return!1}setParameters(t,i=!0){Yr(this._parameters,t)&&(this.validateParameters(this._parameters),i&&this._parametersChanged())}validateParameters(t){}shouldRender(t){return this.visible&&this.isVisibleForOutput(t.output)&&(!this.parameters.isDecoration||t.bind.decorations)&&(this.parameters.renderOccluded&t.renderOccludedMask)!==0}isVisibleForOutput(t){return!0}get renderPriority(){return this._renderPriority}set renderPriority(t){t!==this._renderPriority&&(this._renderPriority=t,this._parametersChanged())}_parametersChanged(){var t;(t=this.repository)==null||t.materialChanged(this)}get renderOccludedFlags(){return this.visible?this.parameters.renderOccluded:jt.None}get hasEmissions(){return!1}getConfiguration(t,i,r=new Nt){return r.output=t,r.hasHighlightMixTexture=t===ge.Highlight&&i.highlightMixTexture!=null,r}};var jt;(function(e){e[e.None=0]="None",e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"})(jt||(jt={}));let Gh=class extends Ot{constructor(){super(...arguments),this.renderOccluded=jt.Occlude,this.isDecoration=!1}};const Js=qa(qt.ONE,qt.ZERO,qt.ONE,qt.ONE_MINUS_SRC_ALPHA);function Wh(e){return e===Z.FrontFace?null:Js}function qh(e){switch(e){case Z.NONE:return Ya;case Z.ColorAlpha:return Js;case Z.FrontFace:case Z.COUNT:return null}}function Xh(e){if(e.draped)return null;switch(e.oitPass){case Z.NONE:case Z.FrontFace:return e.writeDepth?Xa:null;case Z.ColorAlpha:case Z.COUNT:return null}}const Yh=5e5,yl={factor:-1,units:-2};function Kh({oitPass:e,enableOffset:t}){return t&&e===Z.ColorAlpha?yl:null}function Qh(e,t=Ze.LESS){return e===Z.NONE||e===Z.FrontFace?t:Ze.LEQUAL}function Zh(e,t){const i=Is(t);return e===Z.ColorAlpha?i?{buffers:[Li,Ni,Zn]}:{buffers:[Li,Ni]}:i?{buffers:[Li,Ni]}:null}let xl=class{constructor(t=!1,i=!0){this.isVerticalRay=t,this.normalRequired=i}};const ti=ea();function ed(e,t,i,r,s,n){if(!e.visible)return;const a=Pe(nn,r,i),o=(u,c,h)=>{n(u,h,c)},l=new xl(!1,t.options.normalRequired);if(e.boundingInfo){G(e.type===nt.Mesh);const u=t.tolerance;en(e.boundingInfo,i,a,u,s,l,o)}else{const u=e.attributes.get(x.POSITION),c=u.indices;tn(i,a,0,c.length/3,c,u.data,u.stride,s,l,o)}}const wl=v();function en(e,t,i,r,s,n,a){if(e==null)return;const o=Al(i,wl);if(Jn(ti,e.bbMin),ta(ti,e.bbMax),s!=null&&s.applyToAabb(ti),Il(ti,t,o,r)){const{primitiveIndices:l,position:u}=e,c=l?l.length:u.indices.length/3;if(c>Cl){const h=e.getChildren();if(h!==void 0){for(const _ of h)en(_,t,i,r,s,n,a);return}}Ol(t,i,0,c,u.indices,u.data,u.stride,l,s,n,a)}}const _t=v();function td(e,t,i,r,s,n,a,o,l){const{data:u,stride:c}=n;tn(e,Pe(nn,t,e),i,r,s,u,c,a,o,l)}function Ml(e,t,i,r,s,n,a,o){const l=e[0],u=e[1],c=e[2],h=t[0],_=t[1],g=t[2];for(let m=i;m<r;++m){const M=3*m,E=M+1,F=M+2,P=n*M,A=s[P],I=s[P+1],z=s[P+2],U=n*E,S=n*F,w=s[U]-A,y=s[U+1]-I,b=s[U+2]-z,T=s[S]-A,O=s[S+1]-I,$=s[S+2]-z,N=_*$-O*g,B=g*T-$*h,H=h*O-T*_,V=w*N+y*B+b*H;if(Math.abs(V)<=sn)continue;const ie=l-A,ce=u-I,ue=c-z,ne=ie*N+ce*B+ue*H;if(V>0){if(ne<0||ne>V)continue}else if(ne>0||ne<V)continue;const pe=ce*b-y*ue,be=ue*w-b*ie,Ae=ie*y-w*ce,Me=h*pe+_*be+g*Ae;if(V>0){if(Me<0||ne+Me>V)continue}else if(Me>0||ne+Me<V)continue;const ae=(T*pe+O*be+$*Ae)/V;ae>=0&&o(ae,m,a?rn(w,y,b,T,O,$,_t):null)}}function Ol(e,t,i,r,s,n,a,o,l,u,c){const h=e[0],_=e[1],g=e[2],m=t[0],M=t[1],E=t[2],{normalRequired:F}=u;for(let P=i;P<r;++P){const A=o[P],I=3*A,z=a*s[I];let U=n[z],S=n[z+1],w=n[z+2];const y=a*s[I+1];let b=n[y],T=n[y+1],O=n[y+2];const $=a*s[I+2];let N=n[$],B=n[$+1],H=n[$+2];l!=null&&([U,S,w]=l.applyToVertex(U,S,w,P),[b,T,O]=l.applyToVertex(b,T,O,P),[N,B,H]=l.applyToVertex(N,B,H,P));const V=b-U,ie=T-S,ce=O-w,ue=N-U,ne=B-S,pe=H-w,be=M*pe-ne*E,Ae=E*ue-pe*m,Me=m*ne-ue*M,ae=V*be+ie*Ae+ce*Me;if(Math.abs(ae)<=sn)continue;const ct=h-U,Pi=_-S,Ci=g-w,ut=ct*be+Pi*Ae+Ci*Me;if(ae>0){if(ut<0||ut>ae)continue}else if(ut>0||ut<ae)continue;const Mr=Pi*ce-ie*Ci,Or=Ci*V-ce*ct,$r=ct*ie-V*Pi,Wt=m*Mr+M*Or+E*$r;if(ae>0){if(Wt<0||ut+Wt>ae)continue}else if(Wt>0||ut+Wt<ae)continue;const Sr=(ue*Mr+ne*Or+pe*$r)/ae;Sr>=0&&c(Sr,A,F?rn(V,ie,ce,ue,ne,pe,_t):null)}}function tn(e,t,i,r,s,n,a,o,l,u){const c=t,h=Ll,_=Math.abs(c[0]),g=Math.abs(c[1]),m=Math.abs(c[2]),M=_>=g?_>=m?0:2:g>=m?1:2,E=M,F=c[E]<0?2:1,P=(M+F)%3,A=(M+(3-F))%3,I=c[P]/c[E],z=c[A]/c[E],U=1/c[E],S=$l,w=Sl,y=Rl,{normalRequired:b}=l;for(let T=i;T<r;++T){const O=3*T,$=a*s[O];k(h[0],n[$+0],n[$+1],n[$+2]);const N=a*s[O+1];k(h[1],n[N+0],n[N+1],n[N+2]);const B=a*s[O+2];k(h[2],n[B+0],n[B+1],n[B+2]),o&&(K(h[0],o.applyToVertex(h[0][0],h[0][1],h[0][2],T)),K(h[1],o.applyToVertex(h[1][0],h[1][1],h[1][2],T)),K(h[2],o.applyToVertex(h[2][0],h[2][1],h[2][2],T))),Pe(S,h[0],e),Pe(w,h[1],e),Pe(y,h[2],e);const H=S[P]-I*S[E],V=S[A]-z*S[E],ie=w[P]-I*w[E],ce=w[A]-z*w[E],ue=y[P]-I*y[E],ne=y[A]-z*y[E],pe=ue*ce-ne*ie,be=H*ne-V*ue,Ae=ie*V-ce*H;if((pe<0||be<0||Ae<0)&&(pe>0||be>0||Ae>0))continue;const Me=pe+be+Ae;if(Me===0)continue;const ae=pe*(U*S[E])+be*(U*w[E])+Ae*(U*y[E]);if(ae*Math.sign(Me)<0)continue;const ct=ae/Me;ct>=0&&u(ct,T,b?bl(h):null)}}const $l=v(),Sl=v(),Rl=v();function rn(e,t,i,r,s,n,a){return k(wi,e,t,i),k(Mi,r,s,n),Se(a,wi,Mi),je(a,a),a}function bl(e){return Pe(wi,e[1],e[0]),Pe(Mi,e[2],e[0]),Se(_t,wi,Mi),je(_t,_t),_t}const wi=v(),Mi=v();function Al(e,t){return k(t,1/e[0],1/e[1],1/e[2])}function Il(e,t,i,r){return Pl(e,t,i,r,1/0)}function Pl(e,t,i,r,s){const n=(e[0]-r-t[0])*i[0],a=(e[3]+r-t[0])*i[0];let o=Math.min(n,a),l=Math.max(n,a);const u=(e[1]-r-t[1])*i[1],c=(e[4]+r-t[1])*i[1];if(l=Math.min(l,Math.max(u,c)),l<0||(o=Math.max(o,Math.min(u,c)),o>l))return!1;const h=(e[2]-r-t[2])*i[2],_=(e[5]+r-t[2])*i[2];return l=Math.min(l,Math.max(h,_)),!(l<0)&&(o=Math.max(o,Math.min(h,_)),!(o>l)&&o<s)}const Cl=1e3,sn=1e-7,nn=v(),Ll=[v(),v(),v()];var Kr;(function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.OPAQUE_MATERIAL_WITHOUT_NORMALS=3]="OPAQUE_MATERIAL_WITHOUT_NORMALS",e[e.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_MATERIAL_WITHOUT_NORMALS=5]="TRANSPARENT_MATERIAL_WITHOUT_NORMALS",e[e.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_MATERIAL_WITHOUT_DEPTH=7]="TRANSPARENT_MATERIAL_WITHOUT_DEPTH",e[e.OCCLUDED_GROUND=8]="OCCLUDED_GROUND",e[e.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",e[e.HUD_MATERIAL=12]="HUD_MATERIAL",e[e.LABEL_MATERIAL=13]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=14]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=15]="LINE_CALLOUTS_HUD_DEPTH",e[e.OVERLAY=16]="OVERLAY",e[e.DRAPED_MATERIAL=17]="DRAPED_MATERIAL",e[e.DRAPED_WATER=18]="DRAPED_WATER",e[e.VOXEL=19]="VOXEL",e[e.MAX_SLOTS=20]="MAX_SLOTS"})(Kr||(Kr={}));let id=class{constructor(){this._transform=Q(),this._transformInverse=new ii({value:this._transform},ui,Q),this._transformInverseTranspose=new ii(this._transformInverse,Zi,Q),this._transformTranspose=new ii({value:this._transform},Zi,Q),this._transformInverseRotation=new ii({value:this._transform},ia,Ai)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(t){xt(this._transform,t)}multiplyTransform(t){Ei(this._transform,this._transform,t)}set(t){xt(this._transform,t),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(t,i){this.setTransformMatrix(t),this.multiplyTransform(i),this._invalidateLazyTransforms()}},ii=class{constructor(t,i,r){this._original=t,this._update=i,this._dirty=!0,this._transform=r()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}},Nl=class{constructor(t=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=v(),this._tmpMbs=_r(),this._tmpObb=new uo,this._resetOffset(t)}_resetOffset(t){this._offset=t,this._totalOffset=t}set offset(t){this._resetOffset(t)}get offset(){return this._offset}set componentOffset(t){this._totalOffset=this._offset+t}set localOrigin(t){this.componentLocalOriginLength=te(t)}applyToVertex(t,i,r){const s=k(an,t,i,r),n=k(Dl,t,i,r+this.componentLocalOriginLength),a=this._totalOffset/te(n);return He(this._tmpVertex,s,n,a),this._tmpVertex}applyToAabb(t){const i=this.componentLocalOriginLength,r=t[0],s=t[1],n=t[2]+i,a=t[3],o=t[4],l=t[5]+i,u=Math.abs(r),c=Math.abs(s),h=Math.abs(n),_=Math.abs(a),g=Math.abs(o),m=Math.abs(l),M=.5*(1+Math.sign(r*a))*Math.min(u,_),E=.5*(1+Math.sign(s*o))*Math.min(c,g),F=.5*(1+Math.sign(n*l))*Math.min(h,m),P=Math.max(u,_),A=Math.max(c,g),I=Math.max(h,m),z=Math.sqrt(M*M+E*E+F*F),U=Math.sign(u+r),S=Math.sign(c+s),w=Math.sign(h+n),y=Math.sign(_+a),b=Math.sign(g+o),T=Math.sign(m+l),O=this._totalOffset;if(z<O)return t[0]-=(1-U)*O,t[1]-=(1-S)*O,t[2]-=(1-w)*O,t[3]+=y*O,t[4]+=b*O,t[5]+=T*O,t;const $=O/Math.sqrt(P*P+A*A+I*I),N=O/z,B=N-$,H=-B;return t[0]+=r*(U*H+N),t[1]+=s*(S*H+N),t[2]+=n*(w*H+N),t[3]+=a*(y*B+$),t[4]+=o*(b*B+$),t[5]+=l*(T*B+$),t}applyToMbs(t){const i=te(Ke(t)),r=this._totalOffset/i;return He(Ke(this._tmpMbs),Ke(t),Ke(t),r),this._tmpMbs[3]=t[3]+t[3]*this._totalOffset/i,this._tmpMbs}applyToObb(t){return ho(t,this._totalOffset,this._totalOffset,_s.Global,this._tmpObb),this._tmpObb}},Fl=class{constructor(t=0){this.offset=t,this.sphere=_r(),this.tmpVertex=v()}applyToVertex(t,i,r){const s=this.objectTransform.transform,n=k(an,t,i,r),a=Ce(n,n,s),o=this.offset/te(a);He(a,a,a,o);const l=this.objectTransform.inverse;return Ce(this.tmpVertex,a,l),this.tmpVertex}applyToMinMax(t,i){const r=this.offset/te(t);He(t,t,t,r);const s=this.offset/te(i);He(i,i,i,s)}applyToAabb(t){const i=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*i,t[1]+=t[1]*i,t[2]+=t[2]*i;const r=this.offset/Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]);return t[3]+=t[3]*r,t[4]+=t[4]*r,t[5]+=t[5]*r,t}applyToBoundingSphere(t){const i=te(Ke(t)),r=this.offset/i;return He(Ke(this.sphere),Ke(t),Ke(t),r),this.sphere[3]=t[3]+t[3]*this.offset/i,this.sphere}};const Qr=new Fl;function od(e){return e!=null?(Qr.offset=e,Qr):null}new Nl;const an=v(),Dl=v();function ld(e,t,i,r=1){const{data:s,indices:n}=e,a=t.typedBuffer,o=t.typedBufferStride,l=n.length;if(i*=o,r===1)for(let u=0;u<l;++u)a[i]=s[n[u]],i+=o;else for(let u=0;u<l;++u){const c=s[n[u]];for(let h=0;h<r;h++)a[i]=c,i+=o}}function Ui(e,t,i){const{data:r,indices:s}=e,n=t.typedBuffer,a=t.typedBufferStride,o=s.length;i*=a;for(let l=0;l<o;++l){const u=2*s[l];n[i]=r[u],n[i+1]=r[u+1],i+=a}}function Er(e,t,i,r=1){const{data:s,indices:n}=e,a=t.typedBuffer,o=t.typedBufferStride,l=n.length;if(i*=o,r===1)for(let u=0;u<l;++u){const c=3*n[u];a[i]=s[c],a[i+1]=s[c+1],a[i+2]=s[c+2],i+=o}else for(let u=0;u<l;++u){const c=3*n[u];for(let h=0;h<r;++h)a[i]=s[c],a[i+1]=s[c+1],a[i+2]=s[c+2],i+=o}}function on(e,t,i,r=1){const{data:s,indices:n}=e,a=t.typedBuffer,o=t.typedBufferStride,l=n.length;if(i*=o,r===1)for(let u=0;u<l;++u){const c=4*n[u];a[i]=s[c],a[i+1]=s[c+1],a[i+2]=s[c+2],a[i+3]=s[c+3],i+=o}else for(let u=0;u<l;++u){const c=4*n[u];for(let h=0;h<r;++h)a[i]=s[c],a[i+1]=s[c+1],a[i+2]=s[c+2],a[i+3]=s[c+3],i+=o}}function cd(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride;t*=s;for(let n=0;n<i;++n)r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=0,t+=s}function Ul(e,t,i,r,s=1){if(!t)return void Er(e,i,r,s);const{data:n,indices:a}=e,o=i.typedBuffer,l=i.typedBufferStride,u=a.length,c=t[0],h=t[1],_=t[2],g=t[4],m=t[5],M=t[6],E=t[8],F=t[9],P=t[10],A=t[12],I=t[13],z=t[14];r*=l;let U=0,S=0,w=0;const y=Ts(t)?b=>{U=n[b]+A,S=n[b+1]+I,w=n[b+2]+z}:b=>{const T=n[b],O=n[b+1],$=n[b+2];U=c*T+g*O+E*$+A,S=h*T+m*O+F*$+I,w=_*T+M*O+P*$+z};if(s===1)for(let b=0;b<u;++b)y(3*a[b]),o[r]=U,o[r+1]=S,o[r+2]=w,r+=l;else for(let b=0;b<u;++b){y(3*a[b]);for(let T=0;T<s;++T)o[r]=U,o[r+1]=S,o[r+2]=w,r+=l}}function Bl(e,t,i,r,s=1){if(!t)return void Er(e,i,r,s);const{data:n,indices:a}=e,o=t,l=i.typedBuffer,u=i.typedBufferStride,c=a.length,h=o[0],_=o[1],g=o[2],m=o[4],M=o[5],E=o[6],F=o[8],P=o[9],A=o[10],I=!Es(o),z=1e-6,U=1-z;r*=u;let S=0,w=0,y=0;const b=Ts(o)?T=>{S=n[T],w=n[T+1],y=n[T+2]}:T=>{const O=n[T],$=n[T+1],N=n[T+2];S=h*O+m*$+F*N,w=_*O+M*$+P*N,y=g*O+E*$+A*N};if(s===1)if(I)for(let T=0;T<c;++T){b(3*a[T]);const O=S*S+w*w+y*y;if(O<U&&O>z){const $=1/Math.sqrt(O);l[r]=S*$,l[r+1]=w*$,l[r+2]=y*$}else l[r]=S,l[r+1]=w,l[r+2]=y;r+=u}else for(let T=0;T<c;++T)b(3*a[T]),l[r]=S,l[r+1]=w,l[r+2]=y,r+=u;else for(let T=0;T<c;++T){if(b(3*a[T]),I){const O=S*S+w*w+y*y;if(O<U&&O>z){const $=1/Math.sqrt(O);S*=$,w*=$,y*=$}}for(let O=0;O<s;++O)l[r]=S,l[r+1]=w,l[r+2]=y,r+=u}}function zl(e,t,i,r,s=1){if(!t)return void on(e,i,r,s);const{data:n,indices:a}=e,o=t,l=i.typedBuffer,u=i.typedBufferStride,c=a.length,h=o[0],_=o[1],g=o[2],m=o[4],M=o[5],E=o[6],F=o[8],P=o[9],A=o[10],I=!Es(o),z=1e-6,U=1-z;if(r*=u,s===1)for(let S=0;S<c;++S){const w=4*a[S],y=n[w],b=n[w+1],T=n[w+2],O=n[w+3];let $=h*y+m*b+F*T,N=_*y+M*b+P*T,B=g*y+E*b+A*T;if(I){const H=$*$+N*N+B*B;if(H<U&&H>z){const V=1/Math.sqrt(H);$*=V,N*=V,B*=V}}l[r]=$,l[r+1]=N,l[r+2]=B,l[r+3]=O,r+=u}else for(let S=0;S<c;++S){const w=4*a[S],y=n[w],b=n[w+1],T=n[w+2],O=n[w+3];let $=h*y+m*b+F*T,N=_*y+M*b+P*T,B=g*y+E*b+A*T;if(I){const H=$*$+N*N+B*B;if(H<U&&H>z){const V=1/Math.sqrt(H);$*=V,N*=V,B*=V}}for(let H=0;H<s;++H)l[r]=$,l[r+1]=N,l[r+2]=B,l[r+3]=O,r+=u}}function Hl(e,t,i,r,s=1){const{data:n,indices:a}=e,o=i.typedBuffer,l=i.typedBufferStride,u=a.length;if(r*=l,t===n.length&&t===4){o[r]=n[0],o[r+1]=n[1],o[r+2]=n[2],o[r+3]=n[3];const c=new Uint32Array(i.typedBuffer.buffer,i.start),h=l/4,_=c[r/=4];r+=h;const g=u*s;for(let m=1;m<g;++m)c[r]=_,r+=h;return}if(s!==1)if(t!==4)for(let c=0;c<u;++c){const h=3*a[c];for(let _=0;_<s;++_)o[r]=n[h],o[r+1]=n[h+1],o[r+2]=n[h+2],o[r+3]=255,r+=l}else for(let c=0;c<u;++c){const h=4*a[c];for(let _=0;_<s;++_)o[r]=n[h],o[r+1]=n[h+1],o[r+2]=n[h+2],o[r+3]=n[h+3],r+=l}else{if(t===4){for(let c=0;c<u;++c){const h=4*a[c];o[r]=n[h],o[r+1]=n[h+1],o[r+2]=n[h+2],o[r+3]=n[h+3],r+=l}return}for(let c=0;c<u;++c){const h=3*a[c];o[r]=n[h],o[r+1]=n[h+1],o[r+2]=n[h+2],o[r+3]=255,r+=l}}}function Vl(e,t,i){const{data:r,indices:s}=e,n=t.typedBuffer,a=t.typedBufferStride,o=s.length,l=r[0];i*=a;for(let u=0;u<o;++u)n[i]=l,i+=a}function ud(e,t,i,r){Ge(rt,e,t);const s=Math.max(Math.sqrt(te(rt)),1e-4);X(rt,rt,1/s),i[r++]=rt[0],i[r++]=rt[1],i[r++]=rt[2],i[r++]=s}const rt=v();function kl(e,t,i,r,s=1){const n=t.typedBuffer,a=t.typedBufferStride;if(r*=a,s===1)for(let o=0;o<i;++o)n[r]=e[0],n[r+1]=e[1],n[r+2]=e[2],n[r+3]=e[3],r+=a;else for(let o=0;o<i;++o)for(let l=0;l<s;++l)n[r]=e[0],n[r+1]=e[1],n[r+2]=e[2],n[r+3]=e[3],r+=a}function Gl(e,t,i,r,s,n,a){var l;let o={numItems:0,numVerticesPerItem:0};for(const u of i.fields.keys()){const c=e.get(u),h=c==null?void 0:c.indices;if(c&&h)u===x.POSITION&&(o={numItems:1,numVerticesPerItem:h.length}),jl(u,c,r,s,n,a);else if(u===x.OLIDCOLOR&&t!=null){const _=(l=e.get(x.POSITION))==null?void 0:l.indices;if(_){const g=_.length;kl(t,n.getField(u,As),g,a)}}}return o}function jl(e,t,i,r,s,n){switch(e){case x.POSITION:{G(t.size===3);const a=s.getField(e,di);G(!!a,`No buffer view for ${e}`),Ul(t,i,a,n);break}case x.NORMAL:{G(t.size===3);const a=s.getField(e,di);G(!!a,`No buffer view for ${e}`),Bl(t,r,a,n);break}case x.NORMALCOMPRESSED:case x.PROFILERIGHT:case x.PROFILEUP:{G(t.size===2);const a=s.getField(e,zr);G(!!a,`No buffer view for ${e}`),Ui(t,a,n);break}case x.UV0:{G(t.size===2);const a=s.getField(e,za)??s.getField(e,Ha);G(!!a,`No buffer view for ${e}`),Ui(t,a,n);break}case x.UVI:{G(t.size===2);const a=s.getField(e,zr);G(!!a,`No buffer view for ${e}`),Ui(t,a,n);break}case x.COLOR:case x.SYMBOLCOLOR:{const a=s.getField(e,As);G(!!a,`No buffer view for ${e}`),G(t.size===3||t.size===4),Hl(t,t.size,a,n);break}case x.COLORFEATUREATTRIBUTE:case x.OPACITYFEATUREATTRIBUTE:case x.SIZEFEATUREATTRIBUTE:{const a=s.getField(e,Br)??s.getField(e,Br);G(!!a,`No buffer view for ${e}`),G(t.size===1),Vl(t,a,n);break}case x.TANGENT:{G(t.size===4);const a=s.getField(e,Ur);G(!!a,`No buffer view for ${e}`),zl(t,i,a,n);break}case x.PROFILEVERTEXANDNORMAL:{G(t.size===4);const a=s.getField(e,Ba)??s.getField(e,Ur);G(!!a,`No buffer view for ${e}`),on(t,a,n);break}case x.PROFILEAUXDATA:{G(t.size===3);const a=s.getField(e,Ua)??s.getField(e,di);G(!!a,`No buffer view for ${e}`),Er(t,a,n);break}}}let hd=class{constructor(t){this.vertexBufferLayout=t}elementCount(t){return t.get(x.POSITION).indices.length}write(t,i,r,s,n,a){return Gl(r,s,this.vertexBufferLayout,t,i,n,a)}intersect(t,i,r,s,n,a,o){const l=this.vertexBufferLayout.createView(t).getField(x.POSITION,di);if(l==null)return;const u=Pe(Wl,a,n),c=0,h=l.count/3,_=s.options.normalRequired,g=(m,M,E)=>{o(m,E,M)};Ml(n,u,c,h,l.typedBuffer,l.typedBufferStride,_,g)}};const Wl=v();let ql=class extends j{constructor(t,i,r){super(t,"mat4",L.Pass,(s,n,a)=>s.setUniformMatrix4fv(t,i(n,a),r))}};function Xl(e,t){const{attributes:i,vertex:r,varyings:s,fragment:n}=e;r.include(xo,t),i.add(x.POSITION,"vec3"),s.add("vPositionWorldCameraRelative","vec3"),s.add("vPosition_view","vec3",{invariant:!0}),r.uniforms.add(new he("transformWorldFromViewTH",a=>a.transformWorldFromViewTH),new he("transformWorldFromViewTL",a=>a.transformWorldFromViewTL),new Us("transformViewFromCameraRelativeRS",a=>a.transformViewFromCameraRelativeRS),new ql("transformProjFromView",a=>a.transformProjFromView),new wo("transformWorldFromModelRS",a=>a.transformWorldFromModelRS),new Te("transformWorldFromModelTH",a=>a.transformWorldFromModelTH),new Te("transformWorldFromModelTL",a=>a.transformWorldFromModelTL)),r.code.add(d`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}`),r.code.add(d`
    void forwardPosition(float fOffset) {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      if (fOffset != 0.0) {
        vPositionWorldCameraRelative += fOffset * ${t.spherical?d`normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)`:d`vec3(0.0, 0.0, 1.0)`};
      }

      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;
      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
    }
  `),n.uniforms.add(new he("transformWorldFromViewTL",a=>a.transformWorldFromViewTL)),r.code.add(d`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),n.code.add(d`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}let pd=class extends Ot{constructor(){super(...arguments),this.transformWorldFromViewTH=v(),this.transformWorldFromViewTL=v(),this.transformViewFromCameraRelativeRS=Ai(),this.transformProjFromView=Q()}},vd=class extends Ot{constructor(){super(...arguments),this.transformWorldFromModelRS=Ai(),this.transformWorldFromModelTH=v(),this.transformWorldFromModelTL=v()}},_d=class{constructor(t,i){this._module=t,this._load=i}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},Zr=class{constructor(t,i,r){this._context=t,this._locations=r,this._textures=new Map,this._glProgram=t.programCache.acquire(i.generate("vertex",!0),i.generate("fragment",!0),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=i.generateBind(this),this.bindPass=i.generateBindPass(this),this.bindDraw=i.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(t,i){this._glProgram.setUniform1i(t,i?1:0)}setUniform1i(t,i){this._glProgram.setUniform1i(t,i)}setUniform1f(t,i,r){this._glProgram.setUniform1f(t,i,r)}setUniform2fv(t,i,r){this._glProgram.setUniform2fv(t,i,r)}setUniform3fv(t,i,r){this._glProgram.setUniform3fv(t,i,r)}setUniform4fv(t,i,r){this._glProgram.setUniform4fv(t,i,r)}setUniformMatrix3fv(t,i,r){this._glProgram.setUniformMatrix3fv(t,i,!1,r)}setUniformMatrix4fv(t,i,r){this._glProgram.setUniformMatrix4fv(t,i,!1,r)}setUniform1fv(t,i,r){this._glProgram.setUniform1fv(t,i,r)}setUniform1iv(t,i){this._glProgram.setUniform1iv(t,i)}setUniform2iv(t,i){this._glProgram.setUniform2iv(t,i)}setUniform3iv(t,i){this._glProgram.setUniform3iv(t,i)}setUniform4iv(t,i){this._glProgram.setUniform4iv(t,i)}assertCompatibleVertexAttributeLocations(t){t.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear()}bindTexture(t,i){i!=null&&i.glName||(vs()&&console.error(`Texture sampler ${t} has no given Texture in ${new Error().stack} `),i=this._context.emptyTexture);const r=this._ensureTextureUnit(t,i);this._context.useProgram(this),this.setUniform1i(t,r.unit),this._context.bindTexture(i,r.unit)}_ensureTextureUnit(t,i){let r=this._textures.get(t);return r==null?(r={texture:i,unit:this._textures.size},this._textures.set(t,r)):r.texture=i,r}};const Yl=()=>mr.getLogger("esri.views.3d.webgl.ShaderTechnique");let yd=class{constructor(t,i,r,s=Ks){this.locations=s,this.primitiveType=ra.TRIANGLES,this.key=i.key,this._program=new Zr(t.rctx,r.get().build(i),s),this._pipeline=this.initializePipeline(i),this.reload=async n=>{n&&await r.reload(),this.key.equals(i.key)||Yl().warn("Configuration was changed after construction, cannot reload shader.",r),Qi(this._program),this._program=new Zr(t.rctx,r.get().build(i),s),this._pipeline=this.initializePipeline(i)}}destroy(){this._program=Qi(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(t){this.program.assertCompatibleVertexAttributeLocations(t)}getPipeline(t,i){return this._pipeline}initializePipeline(t){return Ka({blending:Za,colorWrite:Qa})}};function wd(e,t){return Wa(e)?{buffers:[sa.NONE]}:t??null}const Md={func:Ze.LESS},Od={func:Ze.ALWAYS},$d={mask:255},Sd={mask:0},Rd={function:{func:Ze.ALWAYS,ref:Je.OutlineVisualElementMask,mask:Je.OutlineVisualElementMask},operation:{fail:_e.KEEP,zFail:_e.KEEP,zPass:_e.ZERO}},bd={function:{func:Ze.ALWAYS,ref:Je.OutlineVisualElementMask,mask:Je.OutlineVisualElementMask},operation:{fail:_e.KEEP,zFail:_e.KEEP,zPass:_e.REPLACE}},Ad={function:{func:Ze.EQUAL,ref:Je.OutlineVisualElementMask,mask:Je.OutlineVisualElementMask},operation:{fail:_e.KEEP,zFail:_e.KEEP,zPass:_e.KEEP}},Id={function:{func:Ze.NOTEQUAL,ref:Je.OutlineVisualElementMask,mask:Je.OutlineVisualElementMask},operation:{fail:_e.KEEP,zFail:_e.KEEP,zPass:_e.KEEP}};let yr=class extends j{constructor(t,i,r){super(t,"vec2",L.Bind,(s,n)=>s.setUniform2fv(t,i(n),r))}};function Jr(e){e.varyings.add("linearDepth","float",{invariant:!0})}function Kl(e){e.vertex.uniforms.add(new yr("nearFar",t=>t.camera.nearFar))}function ln(e){e.vertex.code.add(d`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}function Cd(e,t){const{vertex:i}=e;switch(t.output){case ge.Color:case ge.ColorEmission:if(t.receiveShadows)return Jr(e),void i.code.add(d`void forwardLinearDepth() { linearDepth = gl_Position.w; }`);break;case ge.Shadow:case ge.ShadowHighlight:case ge.ShadowExcludeHighlight:case ge.ViewshedShadow:return e.include(Xl,t),Jr(e),Kl(e),ln(e),void i.code.add(d`void forwardLinearDepth() {
linearDepth = calculateLinearDepth(nearFar, vPosition_view.z);
}`)}i.code.add(d`void forwardLinearDepth() {}`)}function Ld(e,t){Zl(e,t,new Te("slicePlaneOrigin",(i,r)=>fn(t,i,r)),new Te("slicePlaneBasis1",(i,r)=>{var s;return Oi(t,i,r,(s=r.slicePlane)==null?void 0:s.basis1)}),new Te("slicePlaneBasis2",(i,r)=>{var s;return Oi(t,i,r,(s=r.slicePlane)==null?void 0:s.basis2)}))}function Nd(e,t){cn(e,t,new Te("slicePlaneOrigin",(i,r)=>fn(t,i,r)),new Te("slicePlaneBasis1",(i,r)=>{var s;return Oi(t,i,r,(s=r.slicePlane)==null?void 0:s.basis1)}),new Te("slicePlaneBasis2",(i,r)=>{var s;return Oi(t,i,r,(s=r.slicePlane)==null?void 0:s.basis2)}))}const Ql=d`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function cn(e,t,...i){t.hasSlicePlane?(e.uniforms.add(...i),e.code.add(Ql)):e.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function Zl(e,t,...i){cn(e,t,...i),t.hasSlicePlane?e.code.add(`
    void discardBySlice(vec3 pos) {
      if (sliceByPlane(pos)) {
        discard;
      }
    }

    vec4 applySliceOutline(vec4 color, vec3 pos) {
      SliceFactors factors = calculateSliceFactors(pos);

      factors.front /= 2.0 * fwidth(factors.front);
      factors.side0 /= 2.0 * fwidth(factors.side0);
      factors.side1 /= 2.0 * fwidth(factors.side1);
      factors.side2 /= 2.0 * fwidth(factors.side2);
      factors.side3 /= 2.0 * fwidth(factors.side3);

      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth
      if (sliceByFactors(factors)) {
        return color;
      }

      float outlineFactor = (1.0 - step(0.5, factors.front))
        * (1.0 - step(0.5, factors.side0))
        * (1.0 - step(0.5, factors.side1))
        * (1.0 - step(0.5, factors.side2))
        * (1.0 - step(0.5, factors.side3));

      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);
    }

    vec4 applySlice(vec4 color, vec3 pos) {
      return sliceEnabled() ? applySliceOutline(color, pos) : color;
    }
  `):e.code.add(d`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function un(e,t,i){return e.instancedDoublePrecision?k(Jl,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function hn(e,t){return e!=null?Ge($i,t.origin,e):t.origin}function dn(e,t,i){return e.hasSliceTranslatedView?t!=null?yi(ec,i.camera.viewMatrix,t):i.camera.viewMatrix:null}function fn(e,t,i){if(i.slicePlane==null)return kt;const r=un(e,t,i),s=hn(r,i.slicePlane),n=dn(e,r,i);return n!=null?Ce($i,s,n):s}function Oi(e,t,i,r){if(r==null||i.slicePlane==null)return kt;const s=un(e,t,i),n=hn(s,i.slicePlane),a=dn(e,s,i);return a!=null?(ve(Rt,r,n),Ce($i,n,a),Ce(Rt,Rt,a),Ge(Rt,Rt,$i)):r}const Jl=v(),$i=v(),Rt=v(),ec=Q();function Fd(e){ln(e),e.vertex.code.add(d`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),e.vertex.code.add(d`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}function Ii(e){e.code.add(d`struct MaskedColor {
vec4 color;
bvec4 mask;
};`)}function Dd(e){e.include(Ii),e.code.add(d`
    MaskedColor createMaskedFromUInt8NaNColor(vec4 color) {
      return MaskedColor(color * ${d.float(1/254)}, equal(color, vec4(255)));
    }
  `)}function tc(e){e.include(Ii),e.code.add(d`MaskedColor multiplyMaskedColors(MaskedColor color1, MaskedColor color2) {
vec4 masked1 = mix(color1.color, vec4(1), color1.mask);
vec4 masked2 = mix(color2.color, vec4(1), color2.mask);
return MaskedColor(masked1 * masked2, bvec4(ivec4(color1.mask) & ivec4(color2.mask)));
}`)}function ic(e){e.include(Ii),e.code.add(d`MaskedColor createMaskedFromNaNColor(vec4 color) {
return MaskedColor(color, isnan(color));
}`)}let xr=class extends j{constructor(t,i,r){super(t,"vec3",L.Bind,(s,n)=>s.setUniform3fv(t,i(n),r))}},rc=class extends j{constructor(t,i,r){super(t,"mat4",L.Draw,(s,n,a)=>s.setUniformMatrix4fv(t,i(n,a),r))}};function sc(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",kt):e.uniforms.add(new Te("cameraPosition",(i,r)=>k(pn,r.camera.viewInverseTransposeMatrix[3]-i.origin[0],r.camera.viewInverseTransposeMatrix[7]-i.origin[1],r.camera.viewInverseTransposeMatrix[11]-i.origin[2])))}function zd(e,t){if(!t.instancedDoublePrecision)return void e.uniforms.add(new fi("proj",r=>r.camera.projectionMatrix),new rc("view",(r,s)=>yi(es,s.camera.viewMatrix,r.origin)),new Te("localOrigin",r=>r.origin));const i=({camera:r})=>k(pn,r.viewInverseTransposeMatrix[3],r.viewInverseTransposeMatrix[7],r.viewInverseTransposeMatrix[11]);e.uniforms.add(new fi("proj",r=>r.camera.projectionMatrix),new fi("view",r=>yi(es,r.camera.viewMatrix,i(r))),new xr("localOrigin",r=>i(r)))}const es=Q(),pn=v();function Hd(e){e.uniforms.add(new fi("viewNormal",t=>t.camera.viewInverseTransposeMatrix))}function Vd(e){e.uniforms.add(new Ds("pixelRatio",t=>t.camera.pixelRatio/t.overlayStretch))}function kd(e,t,i){for(let r=0;r<i;++r)t[2*r]=e[r],t[2*r+1]=e[r]-t[2*r]}function Gd(e,t){const i=e.length;for(let r=0;r<i;++r)Tt[0]=e[r],t[r]=Tt[0];return t}function jd(e,t){const i=e.length;for(let r=0;r<i;++r)Tt[0]=e[r],Tt[1]=e[r]-Tt[0],t[r]=Tt[1];return t}const Tt=new Float32Array(2);let Wd=class extends j{constructor(t,i){super(t,"int",L.Pass,(r,s,n)=>r.setUniform1i(t,i(s,n)))}};function Xd(e,t){t.hasVertexColors?(e.attributes.add(x.COLOR,"vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(d`void forwardVertexColor() { vColor = color; }`),e.vertex.code.add(d`
      void forwardNormalizedVertexColor() { vColor = color * ${d.float(1/255)}; }
    `)):e.vertex.code.add(d`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function nc(e){e.vertex.code.add(d`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),e.vertex.code.add(d`vec3 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec3 params) {
return vec3(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z
);
}`),e.vertex.code.add(d`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec3 factor) {
return mix(size * clamp(factor.x, factor.z, 1.0), size, factor.y);
}`),e.vertex.code.add(d`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),e.vertex.code.add(d`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec3 factor) {
return mix(size * clamp(factor.x, factor.z, 1.0), size, factor.y);
}`),e.vertex.code.add(d`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function Yd(e){e.uniforms.add(new he("screenSizePerspective",t=>mn(t.screenSizePerspective)))}function ac(e){e.uniforms.add(new he("screenSizePerspectiveAlignment",t=>mn(t.screenSizePerspectiveAlignment||t.screenSizePerspective)))}function mn(e){return k(oc,e.parameters.divisor,e.parameters.offset,e.minScaleFactor)}const oc=v();let vn=class extends j{constructor(t,i,r){super(t,"vec4",L.Pass,(s,n,a)=>s.setUniform4fv(t,i(n,a),r))}},Qd=class{constructor(t){this.screenLength=na(t.screenLength),this.minWorldLength=t.minWorldLength??0,this.maxWorldLength=t.maxWorldLength??1/0}};function Jd(e,t){const i=e.vertex;t.hasVerticalOffset?(cc(i),t.hasScreenSizePerspective&&(e.include(nc),ac(i),sc(e.vertex,t)),i.code.add(d`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${t.spherical?d`vec3 worldNormal = normalize(worldPos + localOrigin);`:d`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${t.hasScreenSizePerspective?d`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:d`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):i.code.add(d`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}const lc=at();function cc(e){e.uniforms.add(new vn("verticalOffset",(t,i)=>{const{minWorldLength:r,maxWorldLength:s,screenLength:n}=t.verticalOffset,a=Math.tan(.5*i.camera.fovY)/(.5*i.camera.fullViewport[3]),o=i.camera.pixelRatio||1;return xi(lc,n*o,a,r,s)}))}function ef(e,t){if(t.output!==ge.ObjectAndLayerIdColor)return e.vertex.code.add(d`void forwardObjectAndLayerIdColor() {}`),void e.fragment.code.add(d`void outputObjectAndLayerIdColor() {}`);const i=t.objectAndLayerIdColorInstanced;e.varyings.add("objectAndLayerIdColorVarying","vec4"),e.attributes.add(i?x.INSTANCEOBJECTANDLAYERIDCOLOR:x.OLIDCOLOR,"vec4"),e.vertex.code.add(d`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${i?"instanceObjectAndLayerIdColor":"objectAndLayerIdColor"} * 0.003921568627451;
    }`),e.fragment.code.add(d`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)}function uc(e){const{fragment:t}=e;t.code.add(d`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(uvec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return texel[lic];
}
uint readLevelBits(uvec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)}let hc=class extends j{constructor(t,i){super(t,"ivec2",L.Bind,(r,s)=>r.setUniform2iv(t,i(s)))}},dc=class extends j{constructor(t,i){super(t,"int",L.Bind,(r,s)=>r.setUniform1i(t,i(s)))}},gn=class extends j{constructor(t,i){super(t,"sampler2D",L.Bind,(r,s)=>r.bindTexture(t,i(s)))}},fc=class extends j{constructor(t,i){super(t,"usampler2D",L.Bind,(r,s)=>r.bindTexture(t,i(s)))}};function pc(e,t){const{fragment:i}=e,{output:r,draped:s,hasHighlightMixTexture:n}=t;r===ge.Highlight?(i.uniforms.add(new dc("highlightLevel",a=>a.highlightLevel??0),new hc("highlightMixOrigin",a=>a.highlightMixOrigin)),e.outputs.add("fragHighlight","uvec2",0),e.include(uc),n?i.uniforms.add(new fc("highlightMixTexture",a=>a.highlightMixTexture)).code.add(d`uvec2 getAccumulatedHighlight() {
return texelFetch(highlightMixTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
uvec2 combinedHighlight = getAccumulatedHighlight();
combinedHighlight[li] |= bits;
fragHighlight = combinedHighlight;
}
}`):i.code.add(d`void outputHighlight(bool occluded) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
}`),s?i.code.add(d`bool isHighlightOccluded() {
return false;
}`):i.uniforms.add(new gn("depthTexture",a=>a.mainDepth)).code.add(d`bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}`),i.code.add(d`void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`)):i.code.add(d`void calculateOcclusionAndOutputHighlight() {}`)}let mc=class extends j{constructor(t,i,r,s){super(t,"vec4",L.Pass,(n,a,o)=>n.setUniform4fv(t,i(a,o),s),r)}},vc=class extends j{constructor(t,i,r,s){super(t,"float",L.Pass,(n,a,o)=>n.setUniform1fv(t,i(a,o),s),r)}};var ee,ts;(function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"})(ee||(ee={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}(ts||(ts={}));let wr=class{constructor(t){this.field=t}},gc=class extends wr{constructor(t){super(t),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[ee.Undefined,ee.Undefined,ee.Undefined],this.fallback=[0,0,0]}},is=class extends wr{constructor(t){super(t),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0],this.fallback=[0,0,0,0]}};class _c extends wr{constructor(t,i=0){super(t),this.fallback=i,this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}}let Tc=class{};function bt(e){return e!=null}function Ec(e,t,i,r=Q()){const s=e||0,n=t||0,a=i||0;return s!==0&&da(r,r,-s/180*Math.PI),n!==0&&ys(r,r,n/180*Math.PI),a!==0&&fa(r,r,a/180*Math.PI),r}function qe(e,t,i,r,s){var o;const n=e.minSize,a=e.maxSize;if(e.useSymbolValue){const l=r.symbolSize[i];return t.minSize[i]=l,t.maxSize[i]=l,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=ee.DefinedSize,!0}if(bt(e.field))return bt(e.stops)?e.stops.length===2&&ht(e.stops[0].size)&&ht(e.stops[1].size)?(rs(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=ee.DefinedSize,!0):!1:ht(n)&&ht(a)&&bt(e.minDataValue)&&bt(e.maxDataValue)?(rs(n,a,e.minDataValue,e.maxDataValue,t,i),t.type[i]=ee.DefinedSize,!0):e.valueUnit==="unknown"?!1:Ar[e.valueUnit]!=null?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/Ar[e.valueUnit],t.type[i]=ee.DefinedSize,!0):!1;if(!bt(e.field)){if((o=e.stops)!=null&&o[0]&&ht(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=ee.DefinedSize,!0;if(ht(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=ee.DefinedSize,!0}return!1}function rs(e,t,i,r,s,n){const a=Math.abs(r-i)>0?(t-e)/(r-i):0;s.minSize[n]=a>0?e:t,s.maxSize[n]=a>0?t:e,s.offset[n]=e-i*a,s.factor[n]=a}function yc(e,t,i,r){if(e.normalizationField||e.valueRepresentation||!ha(e.field))return null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return null}else t.size.field=e.field}else t.size=new gc(e.field),K(t.size.fallback,i.fallbackSize);let s;switch(e.axis){case"width":return s=qe(e,t.size,0,i),s?t:null;case"height":return s=qe(e,t.size,2,i),s?t:null;case"depth":return s=qe(e,t.size,1,i),s?t:null;case"width-and-depth":return s=qe(e,t.size,0,i),s&&qe(e,t.size,1,i),s?t:null;case null:case void 0:case"all":return s=qe(e,t.size,0,i),s=s&&qe(e,t.size,1,i),s=s&&qe(e,t.size,2,i),s?t:null;default:return`${e.axis}`,null}}function xc(e,t,i){for(let s=0;s<3;++s){let n=t.unitInMeters;e.type[s]===ee.DefinedSize&&(n*=t.modelSize[s],e.type[s]=ee.DefinedScale),e.minSize[s]=e.minSize[s]/n,e.maxSize[s]=e.maxSize[s]/n,e.offset[s]=e.offset[s]/n,e.factor[s]=e.factor[s]/n}let r;if(e.type[0]!==ee.Undefined)r=0;else if(e.type[1]!==ee.Undefined)r=1;else{if(e.type[2]===ee.Undefined)return!1;r=2}for(let s=0;s<3;++s)e.type[s]===ee.Undefined&&(e.minSize[s]=e.minSize[r],e.maxSize[s]=e.maxSize[r],e.offset[s]=e.offset[r],e.factor[s]=e.factor[r],e.type[s]=e.type[r]);return!0}function ss(e,t,i){e[4*t]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function wc(e,t,i,r){if(e.normalizationField)return null;if(vr(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.color=new is(e.field);const s=e.stops;for(let n=0;n<8;++n){const a=s[Math.min(n,s.length-1)];t.color.values[n]=a.value,ss(t.color.colors,n,a.color)}mt(t.color.fallback,i.fallbackColor)}}else{if(!(e.stops&&e.stops.length>=0))return null;{const s=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color=new is(null);for(let n=0;n<8;n++)t.color.values[n]=1/0,ss(t.color.colors,n,s);mt(t.color.fallback,i.fallbackColor)}}return t}function Mc(e,t,i,r){if(e.normalizationField)return null;if(vr(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.opacity=new _c(e.field,i.fallbackColor[3]);const s=e.stops;for(let n=0;n<8;++n){const a=s[Math.min(n,s.length-1)];t.opacity.values[n]=a.value,t.opacity.opacityValues[n]=a.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const s=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0],fallback:i.fallbackColor[3]};for(let n=0;n<8;n++)t.opacity.values[n]=1/0,t.opacity.opacityValues[n]=s}}return t}function Bi(e,t,i){const r=i===2&&e.rotationType==="arithmetic";t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function Oc(e,t,i){if(!vr(e.field))return null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return Bi(e,t.rotation,0),t;case"roll":return Bi(e,t.rotation,1),t;case null:case void 0:case"heading":return Bi(e,t.rotation,2),t;default:return`${e.axis}`,null}}class df{constructor({supports:t,modelSize:i,symbolSize:r,unitInMeters:s,anchor:n,scale:a,rotation:o,fallbackColor:l,fallbackSize:u}){this.supports=t,this.modelSize=i??Xt(),this.symbolSize=r??Xt(),this.unitInMeters=s??1,this.anchor=n??Gt(),this.scale=a??Xt(),this.rotation=o??Gt(),this.fallbackColor=l??aa(),this.fallbackSize=u??Xt()}}function _n(e,t,i){if(!e)return null;const r=e.reduce((s,n)=>{if(!s)return s;if(n.valueExpression)return null;switch(n.type){case"size":return t.supports.size?yc(n,s,t,i):s;case"color":return t.supports.color?wc(n,s,t):s;case"opacity":return t.supports.opacity?Mc(n,s,t):null;case"rotation":return t.supports.rotation?Oc(n,s,i):s;default:return null}},new Tc);return!(e.length>0&&r)||r.size||r.color||r.opacity||r.rotation?r!=null&&r.size&&!xc(r.size,t)?null:r:null}class $c{constructor(t,i,r){this.visualVariables=t,this.materialParameters=i,this.requiresShaderTransformation=r}}function ff(e,t){if(!e||yo()||Mo.TESTS_DISABLE_FAST_UPDATES)return null;const i=_n(e.visualVariables,t);return i?new $c(i,En(i,t),!!i.size):null}function pf(e,t,i){if(!t||!e)return!1;const r=e.visualVariables,s=_n(t.visualVariables,i);return!!s&&!!(ri(r.size,s.size,"size")&&ri(r.color,s.color,"color")&&ri(r.rotation,s.rotation,"rotation")&&ri(r.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=En(s,i),e.requiresShaderTransformation=!!s.size,!0)}function ri(e,t,i){if(!!e!=!!t||e&&e.field!==(t==null?void 0:t.field))return!1;if(e&&i==="rotation"){const r=e,s=t;for(let n=0;n<3;n++)if(r.type[n]!==s.type[n]||r.offset[n]!==s.offset[n]||r.factor[n]!==s.factor[n])return!1}return!0}class Tn extends Ot{constructor(t){super(),this.vvSize=(t==null?void 0:t.size)??null,this.vvColor=(t==null?void 0:t.color)??null,this.vvOpacity=(t==null?void 0:t.opacity)??null}}function En(e,t){const i=new Tn(e);return i.vvSize&&(i.vvSymbolAnchor=t.anchor,oa(Vt),Ec(t.rotation[2],t.rotation[0],t.rotation[1],Vt),i.vvSymbolRotationMatrix=i.vvSymbolRotationMatrix||Ai(),la(i.vvSymbolRotationMatrix,Vt)),i}function mf(e,t,i){if(!e.vvSize)return i;xt(Xe,i);const r=e.vvSymbolRotationMatrix;return ca(Vt,r[0],r[1],r[2],0,r[3],r[4],r[5],0,r[6],r[7],r[8],0,0,0,0,1),Ei(Xe,Xe,Vt),Sc(ns,e,t),ua(Xe,Xe,ns),yi(Xe,Xe,e.vvSymbolAnchor),Xe}function Sc(e,t,i){if(!t.vvSize)return k(e,1,1,1),e;if(Number.isNaN(i[0]))return K(e,t.vvSize.fallback);for(let r=0;r<3;++r){const s=t.vvSize.offset[r]+i[0]*t.vvSize.factor[r];e[r]=Ri(s,t.vvSize.minSize[r],t.vvSize.maxSize[r])}return e}function vf(e,t){const i=e==null?0:t.attributes[e];return typeof i=="number"&&isFinite(i)?i:NaN}const Xe=Q(),ns=v(),Vt=Q();let gf=class extends Tn{constructor(){super(...arguments),this.renderOccluded=jt.Occlude,this.isDecoration=!1}};const zi=8;function Tf(e,t){const{vertex:i,attributes:r}=e;t.hasVvInstancing&&(t.vvSize||t.vvColor)&&r.add(x.INSTANCEFEATUREATTRIBUTE,"vec4"),t.vvSize?(i.uniforms.add(new he("vvSizeMinSize",s=>s.vvSize.minSize)),i.uniforms.add(new he("vvSizeMaxSize",s=>s.vvSize.maxSize)),i.uniforms.add(new he("vvSizeOffset",s=>s.vvSize.offset)),i.uniforms.add(new he("vvSizeFactor",s=>s.vvSize.factor)),i.uniforms.add(new he("vvSizeFallback",s=>s.vvSize.fallback)),i.uniforms.add(new Us("vvSymbolRotationMatrix",s=>s.vvSymbolRotationMatrix)),i.uniforms.add(new he("vvSymbolAnchor",s=>s.vvSymbolAnchor)),i.code.add(d`vec3 vvScale(vec4 _featureAttribute) {
if (isnan(_featureAttribute.x)) {
return vvSizeFallback;
}
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),i.code.add(d`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 scale = max(vvScale(_featureAttribute), eps);
        return vec4(vvSymbolRotationMatrix * _normal / scale, 1.0);
      }

      ${t.hasVvInstancing?d`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):i.code.add(d`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),e.vertex.include(Ii),t.vvColor?(i.constants.add("vvColorNumber","int",zi),i.uniforms.add(new vc("vvColorValues",s=>s.vvColor.values,zi),new mc("vvColorColors",s=>s.vvColor.colors,zi),new vn("vvColorFallback",s=>s.vvColor.fallback,{supportsNaN:!0})),t.hasVvInstancing&&(e.vertex.include(tc),e.vertex.include(ic)),i.code.add(d`
      vec4 interpolateVVColor(float value) {
        if (isnan(value)) {
          return vvColorFallback;
        }

        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${t.hasVvInstancing?d`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return multiplyMaskedColors(color, createMaskedFromNaNColor(vvColor()));
            }
            `:d`
            vec4 vvColor() {
              return vec4(1.0);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return color;
            }
            `}
    `)):i.code.add(d`vec4 vvColor() {
return vec4(1.0);
}
MaskedColor applyVVColor(MaskedColor color) {
return color;
}`)}const Rc=1/255.5;let Ef=class extends j{constructor(t,i,r){super(t,"vec2",L.Pass,(s,n,a)=>s.setUniform2fv(t,i(n,a),r))}};function bc(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/t)}function Ac(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/i)}function Ic(e,t,i){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}function Pc(e,t,i){return 2*Math.atan(i*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}var as,D;(function(e){e[e.Default=0]="Default",e[e.Screenshot=1]="Screenshot",e[e.ObjectAndLayerID=2]="ObjectAndLayerID"})(as||(as={})),function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(D||(D={}));var lr;let R=lr=class extends fr{constructor(e){super(e),this._ray=Ps(),this._viewport=Ir(0,0,1,1),this._padding=Ir(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=xs(1,1e3),this._viewDirty=!0,this._viewMatrix=Q(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Q(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Q(),this._frustumDirty=!0,this._frustum=Ls(),this._fullViewport=at(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=v(),this._up=v(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return Ge(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){xt(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),k(v(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),k(v(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),k(v(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const e=Pr(at(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&Cr(e,t)?t:e}get screenPadding(){if(this.pixelRatio===1)return this._padding;const e=Pr(at(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&Cr(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[D.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[D.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[D.RIGHT]+this._padding[D.LEFT]}set fullWidth(e){this.width=e-(this._padding[D.RIGHT]+this._padding[D.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[D.TOP]+this._padding[D.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[D.TOP]+this._padding[D.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[D.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[D.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){Fi(this._padding,e)||(this._viewport[0]+=e[D.LEFT]-this._padding[D.LEFT],this._viewport[1]+=e[D.BOTTOM]-this._padding[D.BOTTOM],this._viewport[2]-=e[D.RIGHT]+e[D.LEFT]-(this._padding[D.RIGHT]+this._padding[D.LEFT]),this._viewport[3]-=e[D.TOP]+e[D.BOTTOM]-(this._padding[D.TOP]+this._padding[D.BOTTOM]),mt(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Ei(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return ui(Q(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||Q()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Ic(this._fov,this.width,this.height)}set fovX(e){this._fov=bc(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Pc(this._fov,this.width,this.height)}set fovY(e){this._fov=Ac(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return ws(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(ui(this._viewInverseTransposeMatrix,this.viewMatrix),Zi(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const{near:t,far:i}=this;return 2*t*i/(i+t-e*(i-t))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,s=i/this.rows,n=r/this.columns,a=-r/2+this.column*n,o=a+n,l=-i/2+this.row*s,u=l+s,c=pa(Q(),a*(1+2*this._padding[D.LEFT]/e),o*(1+2*this._padding[D.RIGHT]/e),l*(1+2*this._padding[D.BOTTOM]/t),u*(1+2*this._padding[D.TOP]/t),this.near,this.far),h=this._get("projectionMatrix");return h&&ma(h,c)?h:c}copyFrom(e){K(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,mt(this._viewport,e.viewport),this.notifyChange("_viewport"),mt(this._padding,e.padding),this.notifyChange("_padding"),va(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(xt(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(to(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(xt(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),mt(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up,this.fov=e.fov}clone(){return new lr().copyFrom(this)}equals(e){return Yt(this.eye,e.eye)&&Yt(this.center,e.center)&&Yt(this.up,e.up)&&Fi(this._viewport,e.viewport)&&Fi(this._padding,e.padding)&&ga(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||Lr(e.screenPadding,this.screenPadding)>=t||Lr(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;Pe(J,e.eye,e.center),Pe(Hi,this.eye,this.center);const i=Oe(J,Hi),r=Nr(J),s=Nr(Hi),n=5e-4;return i*i>=(1-1e-10)*r*s&&Ji(e.eye,this.eye)<Math.max(r,s)*n*n}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs(co(this.viewForward,Ge(J,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=_a()){return e[0]=(this.padding[D.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[D.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,i=.5){return e[0]=this.padding[D.LEFT]+this.width*t,e[1]=this.padding[D.BOTTOM]+this.height*i,e[2]=.5,e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t){e!==C&&K(C,e),C[3]=1,Kt(C,C,this.projectionMatrix);const i=Math.abs(C[3]);X(C,C,1/i);const r=this.fullViewport;t[0]=le(0,r[0]+r[2],.5+.5*C[0]),t[1]=le(0,r[1]+r[3],.5+.5*C[1]),t[2]=.5*(C[2]+1),t[3]=i}unapplyProjection(e,t){const i=this.fullViewport;C[0]=(e[0]/(i[0]+i[2])*2-1)*e[3],C[1]=(e[1]/(i[1]+i[3])*2-1)*e[3],C[2]=(2*e[2]-1)*e[3],C[3]=e[3],this.inverseProjectionMatrix!=null&&(Kt(C,C,this.inverseProjectionMatrix),t[0]=C[0],t[1]=C[1],t[2]=C[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,Vi),this.renderToScreen(Vi,t),t}projectToRenderScreen(e,t){if(C[0]=e[0],C[1]=e[1],C[2]=e[2],C[3]=1,Kt(C,C,this.viewProjectionMatrix),C[3]===0)return null;const i=C;X(i,i,1/Math.abs(C[3]));const r=this.fullViewport,s=le(0,r[0]+r[2],.5+.5*i[0]),n=le(0,r[1]+r[3],.5+.5*i[1]);return"x"in t?(t.x=s,t.y=n):(t[0]=s,t[1]=n,t.length>2&&(t[2]=.5*(i[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,Vi),t)}unprojectFromRenderScreen(e,t){if(Ei(si,this.projectionMatrix,this.viewMatrix),!ui(si,si))return null;const i=this.fullViewport;return C[0]=2*(e[0]-i[0])/i[2]-1,C[1]=2*(e[1]-i[1])/i[3]-1,C[2]=2*e[2]-1,C[3]=1,Kt(C,C,si),C[3]===0?null:(t[0]=C[0]/C[3],t[1]=C[1]/C[3],t[2]=C[2]/C[3],t)}constrainWindowSize(e,t,i,r){const s=e*this.pixelRatio,n=t*this.pixelRatio,a=Math.max(s-i/2,0),o=Math.max(this.fullHeight-n-r/2,0),l=-Math.min(s-i/2,0),u=-Math.min(this.fullHeight-n-r/2,0),c=i-l- -Math.min(this.fullWidth-s-i/2,0),h=r-u- -Math.min(n-r/2,0);return[Math.round(a),Math.round(o),Math.round(c),Math.round(h)]}computeUp(e){e===_s.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=i,t[1]=r}_computeUpGlobal(){Ge(J,this.center,this.eye);const e=te(this.center);e<1?(k(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(Oe(J,this.center))>.9999*te(J)*e||(Se(this._up,J,this.center),Se(this._up,this._up,J),je(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){Ms(J,this.eye,this.center),Math.abs(J[2])<=.9999&&(X(J,J,J[2]),k(this._up,-J[0],-J[1],1-J[2]),je(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t,i=""){typeof e[0]=="number"&&isFinite(e[0])&&typeof e[1]=="number"&&isFinite(e[1])&&typeof e[2]=="number"&&isFinite(e[2])?Yt(e,t)||(K(t,e),this._markViewDirty(),i.length&&this.notifyChange(i)):mr.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Ns(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(Ea(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};f([p()],R.prototype,"_viewport",void 0),f([p()],R.prototype,"_padding",void 0),f([p()],R.prototype,"_fov",void 0),f([p()],R.prototype,"_nearFar",void 0),f([p()],R.prototype,"_viewDirty",void 0),f([p()],R.prototype,"_viewMatrix",void 0),f([p()],R.prototype,"_pixelRatio",void 0),f([p()],R.prototype,"pixelRatio",null),f([p()],R.prototype,"row",void 0),f([p()],R.prototype,"column",void 0),f([p()],R.prototype,"_rows",void 0),f([p()],R.prototype,"rows",null),f([p()],R.prototype,"_columns",void 0),f([p()],R.prototype,"columns",null),f([p()],R.prototype,"eye",null),f([p()],R.prototype,"center",null),f([p()],R.prototype,"_center",void 0),f([p()],R.prototype,"up",null),f([p()],R.prototype,"_up",void 0),f([p()],R.prototype,"viewMatrix",null),f([p({readOnly:!0})],R.prototype,"viewForward",null),f([p({readOnly:!0})],R.prototype,"viewUp",null),f([p({readOnly:!0})],R.prototype,"viewRight",null),f([p({readOnly:!0})],R.prototype,"nearFar",null),f([p()],R.prototype,"near",null),f([p()],R.prototype,"far",null),f([p()],R.prototype,"viewport",null),f([p({readOnly:!0})],R.prototype,"screenViewport",null),f([p({readOnly:!0})],R.prototype,"screenPadding",null),f([p()],R.prototype,"x",null),f([p()],R.prototype,"y",null),f([p()],R.prototype,"width",null),f([p()],R.prototype,"height",null),f([p()],R.prototype,"fullWidth",null),f([p()],R.prototype,"fullHeight",null),f([p({readOnly:!0})],R.prototype,"_aspect",null),f([p()],R.prototype,"padding",null),f([p({readOnly:!0})],R.prototype,"projectionMatrix",null),f([p({readOnly:!0})],R.prototype,"inverseProjectionMatrix",null),f([p()],R.prototype,"fov",null),f([p()],R.prototype,"fovX",null),f([p()],R.prototype,"fovY",null),f([p()],R.prototype,"viewInverseTransposeMatrix",null),f([p({readOnly:!0})],R.prototype,"_projectionMatrixInternal",null),f([p()],R.prototype,"relativeElevation",void 0),R=lr=f([pr("esri.views.3d.webgl.RenderCamera")],R);const xf=R,C=at(),si=Q(),J=v(),Hi=v(),Vi=Ta();var ke;let wf=(ke=class{constructor(t=1/0,i=-1/0){this.near=t,this.far=i}set(t,i){this.near=t,this.far=i}union(t){t!=null&&(this.near=Math.min(this.near,t.near),this.far=Math.max(this.far,t.far))}within(t){return this.near<=t&&t<=this.far}equals(t){return this.near===t.near&&this.far===t.far}},ke.zero=new ke(0,0),ke.infinite=new ke,ke);function Cc(e,t){const i=[],r=[];return ni(i,e,t,Ie.LEFT),ni(r,i,t,Ie.BOTTOM),ni(i,r,t,Ie.RIGHT),ni(r,i,t,Ie.TOP),r}function ni(e,t,i,r){const s=Lc(i,r);if(e.length=0,t.length){s(ai,t[0],t[0])===de.INSIDE&&At(e,t[0]);for(let n=0;n<t.length;n++){const a=t[n===t.length-1?0:n+1];switch(s(ai,t[n],a)){case de.INSIDE:At(e,a);break;case de.INSIDE_OUT:At(e,Fr(ai));break;case de.OUTSIDE_IN:At(e,Fr(ai)),At(e,a);case de.OUTSIDE:}}}}function At(e,t){e.length!==0&&ya(e.at(-1),t)||e.push(t)}function Lc(e,t){const i=t===Ie.LEFT||t===Ie.RIGHT?0:1,r=e[t],s=t===Ie.LEFT||t===Ie.BOTTOM?Et.MIN:Et.MAX,n=i===0?1:0;return(a,o,l)=>{if(o[i]<r&&l[i]<r)return s===Et.MIN?de.OUTSIDE:de.INSIDE;if(o[i]>r&&l[i]>r)return s===Et.MIN?de.INSIDE:de.OUTSIDE;const u=(l[n]-o[n])/(l[i]-o[i]),c=o[n]+u*(r-o[i]);return a[i]=r,a[n]=c,(o[i]<r?1:-1)*s>0?de.OUTSIDE_IN:de.INSIDE_OUT}}var Et,de,Ie;(function(e){e[e.MIN=1]="MIN",e[e.MAX=-1]="MAX"})(Et||(Et={})),function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INSIDE=1]="INSIDE",e[e.OUTSIDE_IN=2]="OUTSIDE_IN",e[e.INSIDE_OUT=3]="INSIDE_OUT"}(de||(de={})),function(e){e[e.LEFT=0]="LEFT",e[e.BOTTOM=1]="BOTTOM",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP"}(Ie||(Ie={}));const ai=gr();var ot;let Nc=(ot=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(t){this.renderCoordsHelper=t,this.frustum=Ls(),this._points=io(),this.lines=new Array(12),this._origin=v(),this._direction=v(),this._altitude=null;for(let i=0;i<12;i++)this.lines[i]={origin:null,direction:v(),endpoint:null}}update(t){Ns(t.viewMatrix,t.projectionMatrix,this.frustum,this._points),K(this._origin,t.eye),K(this._direction,t.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(t){for(let i=0;i<this._points.length;i++)K(this._points[i],t[i]);ro(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(t){return so(this.frustum,t)}intersectsRay(t){return no(this.frustum,t)}intersectsLineSegment(t,i){return ao(this.frustum,t,i)}intersectsPoint(t){return oo(this.frustum,t)}_updateLines(){const t=this._points;for(let i=0;i<4;i++){const r=i+4;ki(this.lines[i],t[i],t[r]),ki(this.lines[i+4],t[i],i===3?t[0]:t[i+1]),ki(this.lines[i+8],t[r],i===3?t[4]:t[r+1])}}},ot.planePointIndices=lo,ot.nearFarLineIndices=[[We.NEAR_BOTTOM_LEFT,We.FAR_BOTTOM_LEFT],[We.NEAR_BOTTOM_RIGHT,We.FAR_BOTTOM_RIGHT],[We.NEAR_TOP_RIGHT,We.FAR_TOP_RIGHT],[We.NEAR_TOP_LEFT,We.FAR_TOP_LEFT]],ot);var Fe;function ki(e,t,i){e.origin=t,e.endpoint=i,Ms(e.direction,t,i)}(function(e){e[e.NEAR_FAR_BOTTOM_LEFT=0]="NEAR_FAR_BOTTOM_LEFT",e[e.NEAR_FAR_BOTTOM_RIGHT=1]="NEAR_FAR_BOTTOM_RIGHT",e[e.NEAR_FAR_TOP_RIGHT=2]="NEAR_FAR_TOP_RIGHT",e[e.NEAR_FAR_TOP_LEFT=3]="NEAR_FAR_TOP_LEFT",e[e.NEAR_BOTTOM=4]="NEAR_BOTTOM",e[e.NEAR_RIGHT=5]="NEAR_RIGHT",e[e.NEAR_TOP=6]="NEAR_TOP",e[e.NEAR_LEFT=7]="NEAR_LEFT",e[e.FAR_BOTTOM=8]="FAR_BOTTOM",e[e.FAR_RIGHT=9]="FAR_RIGHT",e[e.FAR_TOP=10]="FAR_TOP",e[e.FAR_LEFT=11]="FAR_LEFT"})(Fe||(Fe={}));const Fc=v(),oi=v();function yn(){return{direction:v(),up:v()}}function xn(e,t,i,r,s){let n=je(Fc,e),a=Oe(n,r);const o=a>0;a=Math.abs(a),a>.99&&(a=Math.abs(Oe(t,r)),a<.99?(K(n,t),o&&X(n,n,-1)):n=null);let l=0;if(n){X(oi,r,Oe(r,n)),Ge(n,n,oi);const c=Oe(n,s)/(te(n)*te(s));Se(oi,n,s),l=(Oe(oi,r)>0?1:-1)*lt(er(c))}const u=lt(er(-Oe(r,e)/te(e)));return i?(i.heading=l,i.tilt=u,i):{heading:l,tilt:u}}function wn(e,t,i,r){Ge(os,i,t),vo(r,fo(t,os),e)||e===i||K(e,i)}const os=v(),Mn=fe(0,1,0),On=fe(0,0,1),It=Q(),Le=v(),Ne=v();function $n(e,t,i,r=yn()){const{direction:s,up:n}=r;return xa(It,-xe(t)),ys(It,It,xe(i)),Ce(s,On,It),X(s,s,-1),Ce(n,Mn,It),r}function Dc(e,t,i,r){return xn(t,i,r,On,Mn)}function Uc(e,t,i,r){const s=$n(e,i,r),n=v();return X(n,s.direction,-t),ve(n,n,e),{up:s.up,eye:n,heading:i,tilt:r}}function Bc(e){return lt(e)}function zc(e){return xe(e)}function Hc(e,t,i,r,s){const n=e.renderSpatialReference,a=e.spatialReference??t.spatialReference;return kr(t,Le,n),kr(t,Ne,n),Le[0]-=i/2,Ne[0]+=i/2,Le[1]-=r/2,Ne[1]+=r/2,Vr(Le,n,Le,a),Vr(Ne,n,Ne,a),s?(s.xmin=Le[0],s.ymin=Le[1],s.xmax=Ne[0],s.ymax=Ne[1],s.spatialReference=a):s=new Os(Le[0],Le[1],Ne[0],Ne[1],a),s}function Vc(e,t){const i=e.frustum,{renderCoordsHelper:r}=e,s=r.getAltitude(t),n=e.spatialReference,a=e.state.camera.eye,o=[],l=i.planes[Fs.FAR];for(let u=0;u<4;u++){const c=i.lines[u];r.intersectInfiniteManifold(Cs(c.origin,c.direction),s,$e)||kc($e,i,r,c.endpoint,s),wn($e,a,$e,l),o.push(xs($e[0],$e[1]))}return Gc(Cc(o,r.extent),r,n)}function kc(e,t,i,r,s){const n=t.lines[Fe.FAR_LEFT].direction,a=(s-i.getAltitude(r))/n[2];He(e,r,n,a)}function Gc(e,t,i){const r=e.map(s=>(k($e,s[0],s[1],0),t.fromRenderCoords($e,$e,i),[$e[0],$e[1]]));return r.length<=2?new tr({spatialReference:i}):(r.push(r[0].slice()),$s(r)||r.reverse(),new tr({rings:[r],spatialReference:i}))}const $e=v();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Dc,eyeForCenterWithHeadingTilt:Uc,eyeTiltToLookAtTilt:zc,headingTiltToDirectionUp:$n,lookAtTiltToEyeTilt:Bc,toArea:Vc,toExtent:Hc},Symbol.toStringTag,{value:"Module"}));const Gi=fe(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),ji=3,Wi=fe(ji*parseFloat(65e-8.toFixed(6)),ji*parseFloat(1881e-9.toFixed(6)),ji*parseFloat(85e-9.toFixed(6)));fe(parseFloat(Number(Gi[0]+Wi[0]).toFixed(6)),parseFloat(Number(Gi[1]+Wi[1]).toFixed(6)),parseFloat(Number(Gi[2]+Wi[2]).toFixed(6)));const jc=2;Ps();function Wc(e,t,i){e.worldUpAtPosition(t,ls),Ge(qi,i,t);const r=te(qi);return r===0?0:er(Oe(qi,ls)/r)}const ls=v(),qi=v();function qc(e,t,i){const r=t/i,s=xe(e),n=Math.sin(r/2),a=Math.cos(s),o=2*bi(Math.sqrt(n*n/(a*a)));return lt(o)}const Sn=fe(0,0,1),Rn=je(v(),fe(1,1,1)),Xc=new Ma(-180,180),Pt=Q(),Ye=v(),dt=v();function bn(e,t,i,r=yn()){Se(Ye,e,Sn),Oe(Ye,Ye)===0&&Se(Ye,e,Rn),Ra(Pt,-xe(t),e),ba(Pt,Pt,-xe(i),Ye);const{up:s,direction:n}=r;return Se(s,Ye,e),je(s,s),Ce(s,s,Pt),je(n,e),Ss(n,n),Ce(n,n,Pt),r}function Yc(e,t,i,r){const s=Ye,n=dt;return je(s,e),Se(dt,s,Sn),Oe(dt,dt)===0&&Se(dt,s,Rn),Se(n,dt,s),xn(t,i,r,s,n)}function Kc(e,t,i,r){const s={eye:v(),up:null,tilt:r,heading:i},n=Ye;n[0]=e[0],n[1]=e[2],n[2]=-e[1];const a=t,o=xe(i),l=xe(r),u=Math.sin(o),c=Math.cos(o),h=Math.sin(l),_=Math.cos(l),g=te(n);let m;if(Math.abs(l)<1e-8)m=a+g;else{const H=g/h,V=bi(a/H),ie=Math.PI-l-V;m=H*Math.sin(ie)}const M=_*a,E=a*a*(h*h),F=c*c*E,P=m-M,A=P*P,I=F*(F+A-n[1]*n[1]);if(I<0)return X(s.eye,n,m/g),s.tilt=0,li(s,e);const z=Math.sqrt(I),U=n[1]*P,S=F+A;let w;if(w=c>0?-z+U:z+U,Math.abs(S)<1e-8)return g<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=a):X(s.eye,n,m/g),s.tilt=0,Xi(s.eye),li(s,e);s.eye[1]=w/S;const y=u*u*E,b=h*a,T=c*b*s.eye[1],O=s.eye[1]*s.eye[1],$=1-O,N=Math.sqrt($),B=F*O+y-2*T*N*P+$*A;return Math.abs(B)<1e-8?(X(s.eye,n,m/g),s.tilt=0,Xi(s.eye),li(s,e)):(s.eye[0]=($*(m*n[0]-M*n[0])-b*N*(n[0]*s.eye[1]*c+n[2]*u))/B,s.eye[2]=($*(m*n[2]-M*n[2])-b*N*(n[2]*s.eye[1]*c-n[0]*u))/B,X(s.eye,s.eye,m),Xi(s.eye),li(s,e))}function Xi(e){const t=e[1];e[1]=-e[2],e[2]=t}function li(e,t){const i=bn(t,e.heading,e.tilt);return e.up=i.up,e}function Qc(e,t,i){const r=te(t),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),n=bi(i/(s/Math.sin(e)));return lt(e-n)}function Zc(e,t,i){const r=xe(e),s=te(t);return bi(i/(s/Math.sin(r)))+r}function Jc(e,t,i,r,s){let n,a,o,l;const u=t.latitude,c=wa(e.spatialReference).radius,h=t.longitude,_=qc(u,i,c)/2;n=h-_,a=h+_;const g=xe(u),m=(1+Math.sin(g))/(1-Math.sin(g)),M=(m+1)*Math.tan(r/c/2),E=M*M;function F(A){const I=Math.PI/2;return(A=Aa.normalize(A,-I))>I&&(A=Math.PI-A),A}if(o=1.5*Math.PI-2*Math.atan(.5*(M+Math.sqrt(4*m+E))),l=o+r/c,o=F(o),l=F(l),l<o){const A=l;l=o,o=A}if(o=Math.max(lt(o),-90),l=Math.min(lt(l),90),a=Xc.monotonic(n,a),a-n>180){const A=(a-n-180)/2;n+=A,a-=A}const P=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:Oa.WGS84;return s?(s.xmin=n,s.ymin=o,s.xmax=a,s.ymax=l,s.spatialReference=P):s=new Os(n,o,a,l,P),e.spatialReference&&e.spatialReference.isWebMercator&&$a(s,!1,s),s}function eu(e,t){const{renderCoordsHelper:i}=e,r=e.state.camera.clone(),s=new Nc(i);r.near=jc,s.update(r);const n=i.getAltitude(t),a=e.spatialReference,o=i.referenceEllipsoid.radius,l=r.eye,u=1+ws(l,t)/(o+n),c=Math.sqrt(u*u-1),{minCurvature:h,maxCurvature:_,minSamples:g,maxSamples:m}=su,M=ru(e),E=Ri((c-h)/(_-h),0,1),F=Math.round(le(g,m,E)),P=r.aboveGround,A=s.planes[Fs.FAR],I=[],z=Gr(kt,nu,jr()),U=Gr(kt,au,jr());xi(Yi,0,0,0,0);const S=y=>{};for(let y=0;y<4;y++){const b=y===Fe.NEAR_FAR_BOTTOM_RIGHT&&!P||y===Fe.NEAR_FAR_TOP_LEFT&&P?1-M:0,T=y===Fe.NEAR_FAR_BOTTOM_RIGHT&&P||y===Fe.NEAR_FAR_TOP_LEFT&&!P?M:1,O=s.lines[y],$=s.lines[y===3?0:y+1];for(let N=0;N<F;N++){const B=N/F,H=y===Fe.NEAR_FAR_BOTTOM_RIGHT?1-(1-B)**2:y===Fe.NEAR_FAR_TOP_LEFT?B**2:B,V=N===0?0:le(b,T,H),ie=Ti(lu,O.origin,$.origin,V),ce=go(O.direction,$.direction,V,ou);i.intersectManifoldClosestSilhouette(Cs(ie,ce),n,se),wn(se,l,se,A),I.push(ms(se)),I.length!==0&&S(Ji(I.at(-1),se));const ue=(Wr(z,se)?1:0)|(Wr(U,se)?2:0);Yi[ue]=1}}I.length>2&&S(Ji(I[0],I.at(-1)));const w=tu(Sa(Yi)>1?iu(An(I,z),U):[I],i,a);return new tr({rings:w,spatialReference:a})}function tu(e,t,i){const r=2*Rs();return e.map(s=>{const n=[];let a=!1;for(const o of s)t.fromRenderCoords(o,se,i),Math.abs(o[0])<r&&Math.abs(o[1])<r?(n.push([null,se[1]]),n.push([null,se[1]]),a=!0):n.push([se[0],se[1]]);if(a)for(let o=0;o<n.length;o++){const l=n[o];if(l[0]!=null)continue;const u=n[o+1],c=n.at(o===0?-1:o-1);l[0]=c[0],o++;const h=n.at(o===n.length-1?0:o+1);u[0]=h[0]}return n.push(n[0]),$s(n)||n.reverse(),n})}function iu(e,t){const i=[];for(const r of e)i.push(...An(r,t));return i}function An(e,t){const i=[],r=[],s=Rs();for(let a=0;a<e.length;a++){const o=e[a],l=a===e.length-1?e[0]:e[a+1],u=mo(o,l,cu),c=_o(t,u.origin,u.vector,To.NONE,se);switch(c){case St.INSIDE:i.push(o);break;case St.OUTSIDE:r.push(o);break;case St.INTERSECTS_INSIDE_OUT:case St.INTERSECTS_OUTSIDE_IN:{const[h,_,g]=c===St.INTERSECTS_INSIDE_OUT?[1,i,r]:[-1,r,i],m=Eo(t),M=He(v(),se,m,h*s),E=He(v(),se,m,h*-s);_.push(o),_.push(M),g.push(E)}}}const n=[];return i.length&&n.push(i),r.length&&n.push(r),n}function ru(e){const{renderCoordsHelper:t,state:{camera:i}}=e,{center:r,eye:s}=i,n=Math.abs(t.getAltitude(r)),a=Math.abs(Math.PI/2-Wc(t,r,s));return eo(cs,t.referenceEllipsoid.radius+n),Ja(cs,a,i.distance,i.fovY)}const su={minCurvature:xe(5),maxCurvature:xe(50),minSamples:1,maxSamples:6},nu=fe(1,0,0),au=fe(0,1,0),ou=v(),lu=v(),se=v(),cs=_r(),cu=po(),Yi=at();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Yc,eyeForCenterWithHeadingTilt:Kc,eyeTiltToLookAtTilt:Zc,headingTiltToDirectionUp:bn,lookAtTiltToEyeTilt:Qc,toArea:eu,toExtent:Jc},Symbol.toStringTag,{value:"Module"}));var cr,us;(function(e){e.OPAQUE="opaque-color",e.TRANSPARENT="transparent-color",e.COMPOSITE="composite-color",e.FINAL="final-color"})(cr||(cr={})),function(e){e.SSAO="ssao",e.LASERLINES="laserline-color",e.ANTIALIASING="aa-color",e.HIGHLIGHTS="highlight-color",e.MAGNIFIER="magnifier-color",e.OCCLUDED="occluded-color",e.VIEWSHED="viewshed-color",e.OPAQUE_TERRAIN="opaque-terrain-color",e.OPAQUE_ENVIRONMENT="opaque-environment-color",e.TRANSPARENT_ENVIRONMENT="transparent-environment-color",e.FOCUSAREA="focusarea",e.FOCUSAREA_COLOR="focusarea-color"}(us||(us={}));let ft=class extends fr{constructor(t){super(t),this.view=null,this.consumes={required:[]},this.produces=cr.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([Ia(()=>this.view.ready,t=>{var i;t&&((i=this.view.stage)==null||i.renderer.addRenderNode(this))},Pa)])}destroy(){var t,i;(i=(t=this.view.stage)==null?void 0:t.renderer)==null||i.removeRenderNode(this)}precompile(){}render(){throw new yt("RenderNode:render-function-not-implemented","render() is not implemented.")}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view.stage.renderView.renderingContext.gl}get techniques(){return this.view.stage.renderView.techniques}acquireOutputFramebuffer(){var r,s,n;const t=(s=(r=this._frameBuffer)==null?void 0:r.getTexture())==null?void 0:s.descriptor,i=this.view.stage.renderer.fboCache.acquire((t==null?void 0:t.width)??640,(t==null?void 0:t.height)??480,this.produces);return(n=i.fbo)==null||n.initializeAndBind(),i}bindRenderTarget(){var t,i;return(i=(t=this._frameBuffer)==null?void 0:t.fbo)==null||i.initializeAndBind(),this._frameBuffer}requestRender(t){var i;t===Fa.UPDATE&&((i=this.view.stage)==null||i.renderView.requestRender(t)),this._dirty=!0}resetWebGLState(){var t;this.renderingContext.resetState(),this.renderingContext.bindFramebuffer((t=this._frameBuffer)==null?void 0:t.fbo)}get fboCache(){return this.view.stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view.stage.renderView.renderingContext}get renderContext(){var t;return(t=this.view.stage)==null?void 0:t.renderer.renderContext}updateAnimation(t){return!!this._dirty&&(this._dirty=!1,!0)}doRender(t){this._frameBuffer=t.find(({name:i})=>i===this.produces);try{return this.render(t)}finally{this._frameBuffer=null}}};f([p({constructOnly:!0})],ft.prototype,"view",void 0),f([p({constructOnly:!0})],ft.prototype,"consumes",void 0),f([p()],ft.prototype,"produces",void 0),f([p({readOnly:!0})],ft.prototype,"techniques",null),ft=f([pr("esri.views.3d.webgl.RenderNode")],ft);var q,Mt;(function(e){e[e.R8UNORM=0]="R8UNORM",e[e.R8UINT=1]="R8UINT",e[e.RG8UNORM=2]="RG8UNORM",e[e.RG8UINT=3]="RG8UINT",e[e.RGBA4UNORM=4]="RGBA4UNORM",e[e.RGBA8UNORM=5]="RGBA8UNORM",e[e.RGBA8UNORM_MIPMAP=6]="RGBA8UNORM_MIPMAP",e[e.R16FLOAT=7]="R16FLOAT",e[e.RGBA16FLOAT=8]="RGBA16FLOAT",e[e.R32FLOAT=9]="R32FLOAT",e[e.COUNT=10]="COUNT"})(q||(q={})),function(e){e[e.DEPTH16=10]="DEPTH16",e[e.DEPTH24_STENCIL8=11]="DEPTH24_STENCIL8"}(Mt||(Mt={}));q.R8UNORM+"",q.R8UINT+"",q.R16FLOAT+"",q.R32FLOAT+"",q.RG8UNORM+"",q.RG8UINT+"",q.RGBA8UNORM+"",q.RGBA4UNORM+"",q.RGBA8UNORM_MIPMAP+"",q.RGBA16FLOAT+"",Mt.DEPTH16+"",Mt.DEPTH24_STENCIL8+"";const pi=new we;pi.pixelFormat=oe.RED,pi.internalFormat=et.R8,pi.wrapMode=ye.CLAMP_TO_EDGE;const Ft=new we;Ft.pixelFormat=oe.RED_INTEGER,Ft.internalFormat=et.R8UI,Ft.wrapMode=ye.CLAMP_TO_EDGE,Ft.samplingMode=Ee.NEAREST;const mi=new we;mi.pixelFormat=oe.RG,mi.internalFormat=et.RG8,mi.wrapMode=ye.CLAMP_TO_EDGE;const Dt=new we;Dt.pixelFormat=oe.RG_INTEGER,Dt.internalFormat=et.RG8UI,Dt.wrapMode=ye.CLAMP_TO_EDGE,Dt.samplingMode=Ee.NEAREST;const vi=new we;vi.internalFormat=et.RGBA4,vi.dataType=De.UNSIGNED_SHORT_4_4_4_4,vi.wrapMode=ye.CLAMP_TO_EDGE;const In=new we;In.wrapMode=ye.CLAMP_TO_EDGE;const Ut=new we;Ut.wrapMode=ye.CLAMP_TO_EDGE,Ut.samplingMode=Ee.LINEAR_MIPMAP_LINEAR,Ut.hasMipmap=!0,Ut.maxAnisotropy=8;const Bt=new we;Bt.pixelFormat=oe.RED,Bt.dataType=De.HALF_FLOAT,Bt.internalFormat=et.R16F,Bt.samplingMode=Ee.NEAREST;const gi=new we;gi.dataType=De.HALF_FLOAT,gi.internalFormat=et.RGBA16F,gi.wrapMode=ye.CLAMP_TO_EDGE;const zt=new we;zt.pixelFormat=oe.RED,zt.dataType=De.FLOAT,zt.internalFormat=et.R32F,zt.samplingMode=Ee.NEAREST;q.R8UNORM+"",q.R8UINT+"",q.RG8UNORM+"",q.RG8UINT+"",q.RGBA4UNORM+"",q.RGBA8UNORM+"",q.RGBA8UNORM_MIPMAP+"",q.R16FLOAT+"",q.RGBA16FLOAT+"",q.R32FLOAT+"",q.COUNT+"";const uu={[hi.DEPTH_COMPONENT16]:De.UNSIGNED_SHORT,[hi.DEPTH_COMPONENT24]:De.UNSIGNED_INT,[hi.DEPTH_COMPONENT32F]:De.FLOAT,[ir.DEPTH24_STENCIL8]:De.UNSIGNED_INT_24_8,[ir.DEPTH32F_STENCIL8]:De.FLOAT_32_UNSIGNED_INT_24_8_REV};Mt.DEPTH24_STENCIL8+"",hs(ir.DEPTH24_STENCIL8),Mt.DEPTH16+"",hs(hi.DEPTH_COMPONENT16);function hs(e){const t=new we;return t.pixelFormat=Ca(e)?Dr.DEPTH_COMPONENT:Dr.DEPTH_STENCIL,t.dataType=uu[e],t.samplingMode=Ee.NEAREST,t.wrapMode=ye.CLAMP_TO_EDGE,t.internalFormat=e,t.hasMipmap=!1,t.isImmutable=!0,t}function Of(e,t=!0){e.attributes.add(x.POSITION,"vec2"),t&&e.varyings.add("uv","vec2"),e.vertex.main.add(d`
      gl_Position = vec4(position, 0.0, 1.0);
      ${t?d`uv = position * 0.5 + vec2(0.5);`:""}
  `)}function hu(e){e.uniforms.add(new yr("zProjectionMap",t=>du(t.camera))),e.code.add(d`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),e.code.add(d`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),e.code.add(d`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}function du(e){const t=e.projectionMatrix;return rr(fu,t[14],t[10])}const fu=gr();let $f=class extends j{constructor(t,i,r){super(t,"vec2",L.Draw,(s,n,a,o)=>s.setUniform2fv(t,i(n,a,o),r))}},pu=class extends j{constructor(t,i,r){super(t,"vec4",L.Bind,(s,n)=>s.setUniform4fv(t,i(n),r))}};function bf(e){e.fragment.uniforms.add(new pu("projInfo",t=>mu(t.camera))),e.fragment.uniforms.add(new yr("zScale",t=>vu(t.camera))),e.fragment.code.add(d`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}function mu(e){const t=e.projectionMatrix;return t[11]===0?xi(ds,2/(e.fullWidth*t[0]),2/(e.fullHeight*t[5]),(1+t[12])/t[0],(1+t[13])/t[5]):xi(ds,-2/(e.fullWidth*t[0]),-2/(e.fullHeight*t[5]),(1-t[8])/t[0],(1-t[9])/t[5])}const ds=at();function vu(e){return e.projectionMatrix[11]===0?rr(fs,0,1):rr(fs,1,0)}const fs=gr();function gu(e){e.uniforms.add(new xr("mainLightDirection",t=>t.lighting.mainLight.direction))}function _u(e){e.uniforms.add(new xr("mainLightIntensity",t=>t.lighting.mainLight.intensity))}function Af(e){gu(e.fragment),_u(e.fragment),e.fragment.code.add(d`vec3 applyShading(vec3 shadingNormal, float shadow) {
float dotVal = clamp(dot(shadingNormal, mainLightDirection), 0.0, 1.0);
return mainLightIntensity * ((1.0 - shadow) * dotVal);
}`)}function If(e){const t=3.141592653589793,i=.3183098861837907;e.constants.add("PI","float",t),e.constants.add("LIGHT_NORMALIZATION","float",i),e.constants.add("INV_PI","float",i),e.constants.add("HALF_PI","float",1.570796326794897),e.constants.add("TWO_PI","float",6.28318530717958)}let Pf=class extends j{constructor(t,i){super(t,"bool",L.Bind,(r,s)=>r.setUniform1b(t,i(s)))}},Tu=class{constructor(t=Gt()){this.intensity=t}};class Eu{constructor(t=Gt(),i=fe(.57735,.57735,.57735)){this.intensity=t,this.direction=i}}class ur{constructor(t=Gt(),i=fe(.57735,.57735,.57735),r=!0,s=1,n=1){this.intensity=t,this.direction=i,this.castShadows=r,this.specularStrength=s,this.environmentStrength=n}}let Pn=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function yu(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function Ki(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function wt(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function Cn(e){return(e+1)*(e+1)}function xu(e){return Ri(Math.floor(Math.sqrt(e)-1),0,2)}function Ln(e,t,i){const r=e[0],s=e[1],n=e[2],a=i||[];return a.length=Cn(t),t>=0&&(a[0]=.28209479177),t>=1&&(a[1]=.4886025119*r,a[2]=.4886025119*n,a[3]=.4886025119*s),t>=2&&(a[4]=1.09254843059*r*s,a[5]=1.09254843059*s*n,a[6]=.31539156525*(3*n*n-1),a[7]=1.09254843059*r*n,a[8]=.54627421529*(r*r-s*s)),a}function wu(e,t){const i=Cn(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let s=0;s<i;s++)r.r[s]=r.g[s]=r.b[s]=0;return r}function Mu(e,t){const i=xu(t.r.length);for(const r of e)Ss(hr,r.direction),Ln(hr,i,Be),yu(Be,_i),Ki(Be,r.intensity[0],pt),wt(t.r,pt),Ki(Be,r.intensity[1],pt),wt(t.g,pt),Ki(Be,r.intensity[2],pt),wt(t.b,pt);return t}function Ou(e,t){Ln(hr,0,Be);for(const i of e)t.r[0]+=Be[0]*_i[0]*i.intensity[0]*4*Math.PI,t.g[0]+=Be[0]*_i[0]*i.intensity[1]*4*Math.PI,t.b[0]+=Be[0]*_i[0]*i.intensity[2]*4*Math.PI;return t}function $u(e,t,i,r){wu(t,r),k(i.intensity,0,0,0);let s=!1;const n=Su,a=Ru,o=bu;n.length=0,a.length=0,o.length=0;for(const l of e)l instanceof ur&&!s?(K(i.direction,l.direction),K(i.intensity,l.intensity),i.specularStrength=l.specularStrength,i.environmentStrength=l.environmentStrength,i.castShadows=l.castShadows,s=!0):l instanceof ur||l instanceof Eu?n.push(l):l instanceof Tu?a.push(l):l instanceof Pn&&o.push(l);Mu(n,r),Ou(a,r);for(const l of o)wt(r.r,l.r),wt(r.g,l.g),wt(r.b,l.b)}const Su=[],Ru=[],bu=[],Be=[0],pt=[0],hr=v(),_i=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class ps{constructor(){this.color=v(),this.intensity=1}}class Au{constructor(){this.direction=v(),this.ambient=new ps,this.diffuse=new ps}}const Iu=.4;class Ff{constructor(){this._shOrder=2,this._legacy=new Au,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new Pn,this._mainLight=new ur(v(),fe(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(t){$u(t,this._shOrder,this._mainLight,this._sphericalHarmonics),K(this._legacy.direction,this._mainLight.direction);const i=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*i,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*i,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*i,X(this._legacy.diffuse.color,this._mainLight.intensity,i),K(ci,this._legacy.diffuse.color),X(ci,ci,Iu*this.globalFactor),ve(this._legacy.ambient.color,this._legacy.ambient.color,ci)}copyFrom(t){this._sphericalHarmonics.r=Array.from(t.sh.r),this._sphericalHarmonics.g=Array.from(t.sh.g),this._sphericalHarmonics.b=Array.from(t.sh.b),K(this._mainLight.direction,t.mainLight.direction),K(this._mainLight.intensity,t.mainLight.intensity),this._mainLight.castShadows=t.mainLight.castShadows,this._mainLight.specularStrength=t.mainLight.specularStrength,this._mainLight.environmentStrength=t.mainLight.environmentStrength,this.globalFactor=t.globalFactor,this.noonFactor=t.noonFactor}lerpLighting(t,i,r){if(Ti(this._mainLight.intensity,t.mainLight.intensity,i.mainLight.intensity,r),this._mainLight.environmentStrength=le(t.mainLight.environmentStrength,i.mainLight.environmentStrength,r),this._mainLight.specularStrength=le(t.mainLight.specularStrength,i.mainLight.specularStrength,r),K(this._mainLight.direction,i.mainLight.direction),this._mainLight.castShadows=i.mainLight.castShadows,this.globalFactor=le(t.globalFactor,i.globalFactor,r),this.noonFactor=le(t.noonFactor,i.noonFactor,r),t.sh.r.length===i.sh.r.length)for(let s=0;s<i.sh.r.length;s++)this._sphericalHarmonics.r[s]=le(t.sh.r[s],i.sh.r[s],r),this._sphericalHarmonics.g[s]=le(t.sh.g[s],i.sh.g[s],r),this._sphericalHarmonics.b[s]=le(t.sh.b[s],i.sh.b[s],r);else for(let s=0;s<i.sh.r.length;s++)this._sphericalHarmonics.r[s]=i.sh.r[s],this._sphericalHarmonics.g[s]=i.sh.g[s],this._sphericalHarmonics.b[s]=i.sh.b[s]}}const ci=v();function Df(e,{occlusionPass:t,terrainDepthTest:i,cullAboveTerrain:r}){const{vertex:s,fragment:n,varyings:a}=e;if(!i)return s.code.add("void forwardViewPosDepth(vec3 pos) {}"),void n.code.add(`${t?"bool":"void"} discardByTerrainDepth() { ${re(t,"return false;")}}`);a.add("viewPosDepth","float",{invariant:!0}),s.code.add(`void forwardViewPosDepth(vec3 pos) {
    viewPosDepth = pos.z;
  }`),n.include(hu),n.uniforms.add(new gn("terrainDepthTexture",o=>{var l;return(l=o.terrainDepth)==null?void 0:l.attachment})).code.add(d`
    ${t?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${t?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${r?">":"<="} linearDepth) discard;`}
    }`)}function Pu(e){e.code.add(d`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function Uf(e,t){e.include(pc,t),e.include(pl,t),e.fragment.include(Pu);const{output:i,oitPass:r,discardInvisibleFragments:s,snowCover:n}=t,a=i===ge.ObjectAndLayerIdColor,o=Is(i),l=nr(i)&&r===Z.ColorAlpha,u=nr(i)&&r!==Z.ColorAlpha;let c=0;(u||o||l)&&e.outputs.add("fragColor","vec4",c++),o&&e.outputs.add("fragEmission","vec4",c++),l&&e.outputs.add("fragAlpha","float",c++),e.fragment.code.add(d`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition, vec3 emissiveBaseColor ${re(n,", float snow")}) {
      ${re(a,"finalColor.a = 1.0;")}

      ${re(s,`if (finalColor.a < ${d.float(Rc)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${re(l,d`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${re(u,"fragColor = finalColor;")}
      ${re(o,`fragEmission = ${re(n,"mix(finalColor.a * getEmissions(emissiveBaseColor), vec4(0.0), snow);","finalColor.a * getEmissions(emissiveBaseColor);")}`)}
      calculateOcclusionAndOutputHighlight();
      ${re(a,"outputObjectAndLayerIdColor();")}
    }
  `)}export{sc as $,Ve as A,gt as B,ei as C,Vh as D,Kr as E,Zh as F,Mo as G,Zs as H,Bh as I,fl as J,jt as K,gh as L,Sc as M,zh as N,yo as O,Hl as P,ld as Q,Ul as R,Bl as S,on as T,cd as U,kl as V,bh as W,Uh as X,nt as Y,nh as Z,zd as _,Df as a,Us as a$,cc as a0,Hd as a1,Pf as a2,Jo as a3,el as a4,q as a5,gu as a6,_u as a7,xr as a8,fi as a9,Xh as aA,Qh as aB,qh as aC,Yh as aD,hd as aE,gf as aF,ul as aG,kd as aH,yh as aI,sl as aJ,vc as aK,If as aL,yr as aM,yl as aN,Id as aO,Od as aP,Ad as aQ,Sd as aR,Md as aS,ud as aT,id as aU,od as aV,vf as aW,hu as aX,Gh as aY,pd as aZ,wo as a_,Of as aa,he as ab,Ot as ac,Wd as ad,$f as ae,uc as af,ar as ag,ft as ah,us as ai,Ks as aj,xf as ak,Ff as al,Xr as am,Mt as an,vl as ao,Tu as ap,ed as aq,Fd as ar,Xd as as,Ld as at,Uf as au,Kh as av,bd as aw,Rd as ax,$d as ay,wd as az,Pu as b,vd as b0,Ii as b1,Dd as b2,tc as b3,ql as b4,xo as b5,Gd as b6,jd as b7,Hh as b8,al as b9,jl as bA,Kl as ba,Ys as bb,bf as bc,st as bd,Af as be,Iu as bf,dc as bg,Jd as bh,Cd as bi,ic as bj,Ch as bk,Qd as bl,ff as bm,pf as bn,df as bo,wf as bp,mf as bq,ah as br,td as bs,zi as bt,mc as bu,xl as bv,Il as bw,Gl as bx,vh as by,Yr as bz,Tf as c,Ef as d,ef as e,vn as f,cl as g,or as h,j as i,ac as j,Rc as k,gn as l,Nd as m,sh as n,pu as o,wh as p,Ds as q,pc as r,nc as s,Yd as t,Z as u,yd as v,Vd as w,_d as x,Wh as y,Nt as z};
